(function(){var aiscripts,angle,audio,cutscenehandler,engine,extscene,gradient,loader,particle,pauser,rect,savehandler,scenehandler,scenenode,screenhandler,sequence,serv,soundhandler,sprite,surface,tileset,vect,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};aiscripts=function(){function e(){}return e.prototype.watch=function(e){return function(t){var n;n=Math.pow(this.sprite.area.p.x-t.focus.area.p.x,2)+Math.pow(this.sprite.area.p.y-t.focus.area.p.y,2);if(n<e*e)return this.sprite.vector.set("pts",this.sprite.area.p,t.focus.area.p)}},e.prototype.random=function(e){return function(t){if(Math.random()>e)return this.sprite.mode=Math.floor(Math.random()*3),this.sprite.vector.set("spr",-3+Math.floor(Math.random()*8))}},e.prototype.follow=function(e,t,n){var r,i,s;return r=0,s=0,i=new vect(-1,-1),function(o){var u,a,f,l,c,h,p,d,v;h=o[o.length-1],l=new vect(Math.abs(this.sprite.area.p.x-o.focus.area.p.x),Math.abs(this.sprite.area.p.y-o.focus.area.p.y)),r===0&&(r=new Graph(h.grid.map(function(e){return e.map(function(e){return h.coll[e]>0?1:0})}))),c=Math.max(l.x,l.y),p=new vect(1+Math.floor((this.sprite.area.p.x+this.sprite.carea.p.x)/h.tilesize.x),1+Math.floor((this.sprite.area.p.y+this.sprite.carea.p.y)/h.tilesize.y)),u=new vect(1+Math.floor((o.focus.area.p.x+o.focus.carea.p.x)/h.tilesize.x),1+Math.floor((o.focus.area.p.y+o.focus.carea.p.y)/h.tilesize.y));if(i.x!==u.x||i.y!==u.y)i=new vect(u.x,u.y),s=astar.search(r.nodes,r.nodes[p.x][p.y],r.nodes[u.x][u.y]),s=s.filter(function(e,t,n){return n[t-1]!=null&&n[t+1]!=null?n[t-1].x===n[t+1].x||n[t-1].y===n[t+1].y:!0});if(c<=e){f=0,a=0,d=o.focus.vector.get("kbd");if(l.x<l.y){if(d.y!==0){if(d.x!==0)this.sprite.vector.set("kbd",new vect(-d.x,0));else{while(r.input[u.x+f][u.y]!==1)f+=1;while(r.input[u.x-a][u.y]!==1)a+=1;f===a&&o.focus.area.p.x+o.focus.area.s.x/2-(u.x-1)*h.tilesize.x<h.tilesize.x/2&&(f+=1),this.sprite.vector.set("kbd",new vect(f>a?1:-1,0))}this.sprite.mode=2}}else if(d.x!==0){if(d.y!==0)this.sprite.vector.set("kbd",new vect(0,-d.y));else{while(r.input[u.x][u.y+f]!==1)f+=1;while(r.input[u.x][u.y-a]!==1)a+=1;f===a&&o.focus.area.p.y+o.focus.area.s.y/2-(u.y-1)*h.tilesize.y<h.tilesize.y/2&&(f+=1),this.sprite.vector.set("kbd",new vect(0,f>a?1:-1))}this.sprite.mode=2}}e<c&&c<=t&&(this.sprite.vector.set("pts",this.sprite.area.p,o.focus.area.p),this.sprite.mode=0);if(t<c&&s.length>0)return v=new vect,s[0].x===p.x&&s[0].y===p.y&&s.shift(),v.x=s[0].x>p.x?1:s[0].x<p.x?-1:0,v.y=s[0].y>p.y?1:s[0].y<p.y?-1:0,v.x===0&&this.sprite.area.p.x+2*this.sprite.area.s.x>h.tilesize.x*(p.x+1)&&r.input[p.x+1][p.y+v.y]===1&&(v.x=-1),v.y===0&&this.sprite.area.p.y+2*this.sprite.area.s.y>h.tilesize.y*(p.y+1)&&r.input[p.x+v.x][p.y+1]===1&&(v.y=-1),this.sprite.vector.set("kbd",v),this.sprite.mode=n<c?2:1}},e.prototype.keyboard=function(){return function(e,t){var n,r,i,s;t.right.state===t.left.state&&t.down.state===t.up.state?this.sprite.mode=0:(this.sprite.vector.set("kbd",new vect(t.right.state-t.left.state,t.down.state-t.up.state)),this.sprite.mode=t.run.state===1?2:1);if(t.act.poll===1){s=[];for(r=0,i=e.length;r<i;r++)n=e[r],n.aiscripts.interact!=null&&s.push(n.interact(this.sprite));return s}}},e}(),audio=function(){function e(e){var t=this;e[e.length-1]==="0"?this.data=-1:(this.mode={stop:0,play:1,pause:2},this.ii=0,this.oldset=!1,this.newset=!1,this.sndmode=this.mode.stop,this.datamode=this.mode.stop,this.data=new Audio,this.data.src=e,this.data.addEventListener("ended",function(){t.datamode=t.mode.stop;if(t.ii===0)return t.sndmode=t.altdatamode}),this.altdatamode=this.mode.stop,this.altdata=new Audio,this.altdata.src=e,this.altdata.addEventListener("ended",function(){t.altdatamode=t.mode.stop;if(t.ii===0)return t.sndmode=t.datamode}),this.fade())}return e.prototype.play=function(){var e=this;if(this.data!==-1&&(this.sndmode!==this.mode.pause||this.ii!==0)){this.sndmode===this.mode.stop&&(this.sndmode=this.mode.play),this.loop!=null&&this.ii===0&&(this.ii=window.setInterval(function(){return e.play()},1e3*this.loop));if(this.datamode===this.mode.stop)return this.datamode=this.mode.play,this.data.play();if(this.altdatamode===this.mode.stop)return this.altdatamode=this.mode.play,this.altdata.play()}},e.prototype.stop=function(){if(this.data!==-1){this.sndmode=this.mode.stop,this.ii!==0&&window.clearInterval(this.ii),this.ii=0,this.datamode!==this.mode.stop&&(this.datamode=this.mode.stop,this.data.pause(),this.data.currentTime=0);if(this.altdatamode!==this.mode.stop)return this.altdatamode=this.mode.stop,this.altdata.pause(),this.altdata.currentTime=0}},e.prototype.pause=function(){if(this.data!==-1&&this.sndmode===this.mode.play){this.sndmode=this.mode.pause;if(this.ii!==0)return this.fade();this.datamode===this.mode.play&&(this.datamode=this.mode.pause,this.data.pause());if(this.altdatamode===this.mode.play)return this.altdatamode=this.mode.pause,this.altdata.pause()}},e.prototype.unpause=function(){if(this.data!==-1&&this.sndmode===this.mode.pause){this.sndmode=this.mode.play;if(this.ii!==0)return this.fade();this.datamode===this.mode.pause&&(this.datamode=this.mode.play,this.data.play());if(this.altdatamode===this.mode.pause)return this.altdatamode=this.mode.play,this.altdata.play()}},e.prototype.fade=function(){var e;if(this.data!==-1)return e=serv.audio.muted||this.sndmode===this.mode.pause&&this.ii!==0?0:serv.audio.volume,this.data.volume=e,this.altdata.volume=e},e.prototype.step=function(){return this.newset=!0},e}(),cutscenehandler=function(){function e(e,t,n,r,i,s,o){this.charsheet=e,this.background=t,this.chars=n,this.chararea=r,this.charpos=i,this.nexttxtsnd=s,this.lasttxtsnd=o,this.text=new surface(this.background.size()),this.frames=0,this.choice=-1}return e.prototype.initialize=function(e){return this.frames=e,this.frame={len:0,elem:-1,txt:-1,overlay:-1,snd:-1,next:0},this.framestate={len:-1,elem:-1,txt:-1,overlay:-1,snd:-1,next:-1},this.time=0,this.next()},e.prototype.render=function(e){var t,n,r,i,s;this.nexttxtsnd.step(),this.lasttxtsnd.step();if(this.frames!==0){this.time>(i=this.frame.len)&&i>0&&this.next(),this.frame.snd!==-1&&this.frame.snd.step(),this.frame.txt!==-1&&e.drawImage(this.text,this.charpos.x+(e.dims.x-this.text.dims.x)/2,this.charpos.y+(e.dims.y-this.text.dims.y)/2),this.frame.overlay!==-1&&this.frame.overlay.render(e)&&(this.frame.overlay=-1);if(this.frame.elem!==-1){s=this.frame.elem;for(n=0,r=s.length;n<r;n++)t=s[n],t.render(e);e.ctx.globalAlpha=1}return this.frame.len>0&&(this.time+=serv.screen.clock),this.frame.elem!==-1}return!1},e.prototype.input=function(e){if(this.frames!==0){this.frame.len===0&&e.act.poll===1&&this.next();if(e.act.poll!==1&&this.choice!==-1){if(e.up.poll===1||e.down.poll===1)this.choice+=this.choice<2?2:-2;if(e.left.poll===1||e.right.poll===1)this.choice+=this.choice%2===0?1:-1;this.drawchoice(this.frame.txt)}return!0}return!1},e.prototype.next=function(){var e,t,n;t=this.frame.next,"function"==typeof t&&(t=t(this.choice)),this.choice=-1;if(t===-1)return this.frame.txt!==-1&&this.lasttxtsnd.play(),this.frames=0;this.frame.txt!==this.frames[t].txt&&(this.frames[t].txt===-1?this.lasttxtsnd.play():this.frame.txt!==-1&&this.nexttxtsnd.play()),this.frame.snd!==this.frames[t].snd&&(n=this.frames[t].snd)!=null&&typeof n.play=="function"&&n.play();for(e in this.frames[t])this.frame[e]=this.frames[t][e],this.framestate[e]=t;this.frame.next===t&&(this.frame.next+=1,this.framestate.next=-1),this.time=0;if(this.frame.txt!==-1)return this.frame.txt[0]==="	"?(this.choice=0,this.drawchoice(this.frame.txt)):this.drawtext(this.frame.txt)},e.prototype.drawchoice=function(e){var t,n,r,i,s,o,u;t=e.substr(1).split("	",5),r=t.shift(),r!==""&&(r+="\n"),t.length===2&&this.choice>1&&(this.choice-=2),t.length===3&&this.choice===3&&(this.choice-=1),t[this.choice]="> "+t[this.choice]+" <";for(s=0,u=t.length;s<u;s++){n=t[s],i=Math.floor((Math.floor(this.chars.s.x/2)-n.length)/2);for(o=1;1>i?o>=i:o<=i;1>i?o--:o++)n=" "+n+" ";n.length%2!==this.chars.s.x/2%2&&(n+=" "),r+=n}return this.drawtext(r)},e.prototype.drawtext=function(e){var t,n,r,i,s,o,u,a;r=0,n=0,this.text.clear(!1),this.text.drawImage(this.background),a=[];for(o=0,u=e.length;o<u;o++){t=e[o];if(r>=this.chars.s.y)continue;t!=="\n"&&t!==" "&&(s=Math.floor(t.charCodeAt(0)/16),i=t.charCodeAt(0)-16*s,this.text.map(this.charsheet,i,s,this.chararea.s.x,this.chararea.s.y,this.chars.p.x+n,this.chars.p.y+r,this.chararea.p.x,this.chararea.p.y)),n+=1,n<this.chars.s.x&&t!=="\n"?a.push(void 0):(n=0,a.push(r+=1))}return a},e.prototype.savestate=function(){var e,t;if(this.frames!==0)return t={},this.frame.overlay!==-1&&(t.overlay=this.frame.overlay.savestate()),this.frame.elem!==-1&&(t.elem=function(){var t,n,r,i;r=this.frame.elem,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.savestate());return i}.call(this)),this.framestate.next===-1&&(t.next=this.frame.next),[this.choice,this.time,this.framestate,t]},e.prototype.loadstate=function(e){var t,n,r,i,s,o;if(this.frames!==0&&e!=null){this.choice=e[0],this.time=e[1],this.framestate=e[2];for(r in this.framestate)this.framestate[r]!==-1&&(this.frame[r]=this.frames[this.framestate[r]][r]);this.frame.overlay!==-1&&this.frame.overlay.loadstate(e[3].overlay);if(this.frame.elem!==-1){o=this.frame.elem;for(n=i=0,s=o.length;i<s;n=++i)t=o[n],t.loadstate(e[3].elem[n])}if(this.framestate.next===-1)return this.frame.next=e[3].next}},e}(),gradient=function(){function e(e,t,n){this.color=e,this.duration=t,this.type=n,this.time=0}return e.prototype.render=function(e){var t;return this.time+=serv.screen.clock,serv.audio.volume=this.type?1-this.time/this.duration:this.time/this.duration,serv.audio.volume>1&&(serv.audio.volume=1),serv.audio.volume<0&&(serv.audio.volume=0),t=this.type?this.time/this.duration:1-this.time/this.duration,t>1&&(t=1),t<0&&(t=0),e.ctx.globalAlpha=t,e.ctx.fillStyle=this.color,e.clear(!0),e.ctx.globalAlpha=1,e.ctx.fillStyle=serv.engine.bgcolor,this.time>this.duration},e.prototype.savestate=function(){return this.time},e.prototype.loadstate=function(e){this.time=e},e}(),sequence=function(){function e(e){var t,n,r,i;this.timeline=e,this.timeline.sort(function(e,t){return e[0]>t[0]?1:-1}),i=serv.engine.rends;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.currscene==null||t.currscene===0)continue;this.scene=t.sprites;break}this.time=0,this.frame=0}return e.prototype.render=function(e){var t;this.time+=serv.screen.clock;while(((t=this.timeline[this.frame])!=null?t[0]:void 0)<=this.time)this.scene[this.timeline[this.frame][1]][this.timeline[this.frame][2]]=this.timeline[this.frame][3],this.frame+=1;return this.timeline[this.frame]==null},e.prototype.savestate=function(){return this.time},e.prototype.loadstate=function(e){this.time=e},e}(),particle=function(){function e(e,t){this.image=e,this.callback=t,this["continue"]=!1,this.time=0}return e.prototype.render=function(e){var t,n,r;return this["continue"]?this.time+=serv.screen.clock:this.time=0,r=this.callback(this.time),e.ctx.globalAlpha=r[3],t=r[0]+(e.dims.x-this.image.dims.x*r[2])/2,n=r[1]+(e.dims.y-this.image.dims.y*r[2])/2,e.drawImage(this.image,t,n,r[2]*this.image.dims.x,r[2]*this.image.dims.y),this["continue"]=r[4]},e.prototype.savestate=function(){return this.time},e.prototype.loadstate=function(e){this.time=e},e.prototype.fadeform=function(e,t){return.5+.5*Math.cos(e*Math.PI/t)},e}(),engine=function(){function e(e,t,n){var r;this.rends=e,this.screen=t,this.keys={};for(r in n)this.keys[r]={val:n[r],poll:0,state:0};this.bgcolor="#000000",this.buffer=new surface(new vect(0,0)),this.resize(this.screen.size()),serv.scene.initialize(0,0),serv.reset(),serv.scene.initchild(0)}return e.prototype.resize=function(e){var t;serv.global.s=[e.x,e.y],t=this.buffer.size();if(e.x!==t.x||e.y!==t.y)return serv.screen.resize("display",e),this.screen.size(e),this.buffer.size(e),this.buffer.ctx.fillStyle=this.bgcolor,this.buffer.ctx.strokeStyle="#ffffff",this.buffer.ctx.lineWidth=25,this.buffer.ctx.lineCap="round",this.buffer.ctx.globalCompositeOperation="destination-over"},e.prototype.input=function(e,t,n){var r,i,s,o,u,a,f,l,c,h;r=!1;for(i in this.keys){this.keys[i].poll=0,c=this.keys[i].val;for(u=0,f=c.length;u<f;u++){s=c[u];if(t!==s)continue;r=!0,this.keys[i].poll=n}this.keys[i].poll===1&&(this.keys[i].state=1),this.keys[i].poll===-1&&(this.keys[i].state=0)}if(r){h=this.rends;for(a=0,l=h.length;a<l;a++){o=h[a];if(o.input(this.keys))break}e()}return!1},e.prototype.step=function(){var e,t,n,r;this.screen.drawImage(this.buffer),this.buffer.clear(!1),r=this.rends;for(t=0,n=r.length;t<n;t++){e=r[t];if(e.render(this.buffer))break}return this.buffer.clear(!0),serv.audio.render(),!1},e}(),extscene=function(){function extscene(){serv.load.filetype["txt/"]=function(e){var t,n;return t={txt:""},n=new XMLHttpRequest,serv.load.loadcount.push(n),n.open("GET",e,!0),n.onreadystatechange=function(){if(n.readyState===4){n.status===404&&serv.load.err(n,e);if(n.status===200)return t.txt=n.responseText,serv.load.finish(n)}},n.send(),t}}return extscene.prototype.setscene=function(e,t){var n,r,i,s,o,u;n=JSON.parse(e),i="",u=n.c;for(s=0,o=u.length;s<o;s++)r=u[s],r.l!=null&&r.t==="t"&&(i=r.l);return t==null&&(t=i==="out"?serv.outscenemgr:i==="in"?serv.inscenemgr:serv.cutscenemgr),new scenenode(n.k,n.f,function(){var e;return e=function(){var e,t,i,s;i=n.c,s=[];for(e=0,t=i.length;e<t;e++){r=i[e];switch(r.t){case"t":s.push(serv.extern.settile(this,r));break;case"s":s.push(serv.extern.setsprite(this,r));break;default:s.push(serv.extern.setcutscene(this,r))}}return s}.call(this),t.initialize(e)})},extscene.prototype.settile=function(e,t){var n,r;return(r=t.c)==null&&(t.c="#000000"),t.a!=null?(n=this.file(e,t.a),t.d!=null&&(n.loop=t.d)):n=0,new tileset(new vect(t.s[0],t.s[1]),this.file(e,t.i),t.p,n,t.c,t.m)},extscene.prototype.setsprite=function(e,t){var n,r,i;r={aiscripts:{}};for(n in t)switch(n){case"vector":r.vector=new angle("spr",t.vector);break;case"sheet":r.sheet=this.file(e,t.sheet);break;case"area":case"carea":r[n]=new rect(t[n][0],t[n][1],t[n][2],t[n][3]);break;default:n.substr(0,3)==="ai-"?r.aiscripts[n.substr(3)]=(i=serv.getai)[t[n][0]].apply(i,t[n].slice(1)):r[n]=t[n]}return new sprite(r)},extscene.prototype.setcutscene=function(e,t){var n,r,i;r={};for(n in t)if(t[n]===-1)r[n]=-1;else switch(n){case"snd":typeof t.snd[0]=="number"?r.snd=this.file(e,t.snd):(r.snd=this.file(e,t.snd[0]),r.snd.loop=t.snd[1]);break;case"next":typeof t.next=="number"?r.next=t.next:r.next=this.setfunction(t.next,"k",e);break;case"elem":r.elem=function(){var n,r,s,o;s=t.elem,o=[];for(n=0,r=s.length;n<r;n++)i=s[n],o.push(new particle(this.file(e,i[0]),this.setfunction(i[1],"t",e)));return o}.call(this);break;case"overlay":typeof t.overlay[0]!="string"?r.overlay=new sequence(t.overlay):r.overlay=new gradient(t.overlay[0],t.overlay[1],t.overlay[2]);break;default:r[n]=t[n]}return r},extscene.prototype.setfunction=function(_func,_arg,_this){var _f;return _func=_func.split(/\bthis\b/gm).join("_this"),_f=_func.split(";").filter(function(e){return e!==""}),_f.push("return ("+_f.pop()+")"),eval("(function ("+_arg+"){"+_f.join(";")+";})")},extscene.prototype.file=function(e,t){var n,r,i,s;r=e.file;for(i=0,s=t.length;i<s;i++)n=t[i],r=r[n];return r},extscene}(),loader=function(){function e(){this.maxload=0,this.loadcount=[],this.callbacks=[],this.filetype={},this.filetype["img/"]=function(e){var t;return t=new surface(new Image),serv.load.loadcount.push(t),t.buf.onerror=function(){return serv.load.err(t,e+".png")},t.buf.onload=function(){return t.dims.x=t.buf.width,t.dims.y=t.buf.height,serv.load.finish(t)},t.buf.src=e+".png",t}}return e.prototype.render=function(e){var t;return this.loadcount.length!==0?(this.maxload<this.loadcount.length&&(this.maxload=this.loadcount.length),t=(this.maxload-this.loadcount.length)*(e.dims.x-60)/this.maxload,e.ctx.beginPath(),e.ctx.moveTo(30,e.dims.y-30),e.ctx.lineTo(t+30,e.dims.y-30),e.ctx.stroke()):this.maxload=0,this.loadcount.length!==0},e.prototype.input=function(e){return this.loadcount.length!==0},e.prototype.load=function(e){var t,n,r,i,s;return i=e.substr(0,4),n=e.match(/(.*)(?:\[)([0-9]+)(?:-)([0-9]+)(?:])(.*)/),n!=null?r=function(){var e,r,i,s;s=[];for(t=e=r=parseInt(n[2],10),i=parseInt(n[3],10);r>i?e>=i:e<=i;t=r>i?--e:++e)s.push(this.load(n[1]+t+n[4]));return s}.call(this):r=typeof (s=this.filetype)[i]=="function"?s[i](e):void 0,r},e.prototype.err=function(e,t){return serv.screen.message("errorbox","Error: failed to load "+t,10),this.finish(e)},e.prototype.finish=function(e){var t,n,r,i,s,o;n=this.loadcount.indexOf(e),n!==-1&&this.loadcount.splice(n,1);if(this.loadcount.length===0){r=this.callbacks,this.callbacks=[],o=[];for(i=0,s=r.length;i<s;i++)t=r[i],o.push(t());return o}},e}(),serv={},window.onload=function(){var e,t;return serv.screen=new screenhandler(["display","miskatonic","errorbox"]),t=new surface(serv.screen.elem.miskatonic),serv.screen.getsysteminfo(),serv.screen.basicsupport?(e={up:[38,87,90,188],left:[37,65,81],down:[40,79,83],right:[39,68,69],run:[16],act:[13,32],pause:[27,80]},serv.global={m:!1,s:[800,600]},serv.load=new loader,serv.save=new savehandler(serv.screen.cansaveload),serv.audio=new soundhandler(serv.screen.soundext),serv.extern=new extscene,serv.reset=function(){return serv.audio.erase(),serv.state=serv.scene},serv.scene=new scenenode(["txt/title.json","txt/scene.json"],["img/text","img/pause","snd/next","snd/last","snd/omenu","snd/cmenu","txt/pause.json"],function(){var e,t;return this.canreeval=!1,t=new surface(new vect(656,208)),t.ctx.fillStyle="#000000",t.ctx.globalAlpha=.7,t.clear(!1),t.ctx.beginPath(),t.ctx.arc(16,64,16,3*Math.PI/2,Math.PI,!0),t.ctx.arc(16,192,16,Math.PI,Math.PI/2,!0),t.ctx.arc(640,192,16,Math.PI/2,0,!0),t.ctx.arc(640,64,16,0,3*Math.PI/2,!0),t.ctx.fill(),t.ctx.globalAlpha=1,serv.getai=new aiscripts,serv.inscenemgr=new scenehandler,serv.outscenemgr=new scenehandler,serv.cutscenemgr=new cutscenehandler(this.file[0],t,new rect(1,1/3,38,4),new rect(16,48,32,32),new vect(0,124),this.file[2],this.file[3]),e=new cutscenehandler(this.file[0],this.file[1],new rect(41/3,5,38,4),new rect(16,48,32,32),new vect(0,0),this.file[2],this.file[5]),serv.pausemgr=new pauser(serv.engine.screen,this.file[6].txt,e,this.file[4],this.file[5]),serv.engine.rends.push(serv.pausemgr,serv.cutscenemgr,serv.inscenemgr,serv.outscenemgr)},function(e){if(e!==-1)return this.initchild(e+1===this.child.length?0:e+1)}),serv.engine=new engine([serv.load],t,e),document.addEventListener("keydown",function(e){return serv.engine.input(function(){return e.preventDefault()},e.keyCode,1)}),document.addEventListener("keyup",function(e){return serv.engine.input(function(){return e.preventDefault()},e.keyCode,-1)}),serv.screen.animate(function(){return serv.engine.step()})):serv.screen.unwrap("miskatonic")},pauser=function(){function e(e,t,n,r,i){var s,o=this;this.underlay=e,this.obj=n,this.pausesnd=r,this.unpausesnd=i,this.display=new surface(this.underlay.size()),s=serv.extern.setscene(t,this.obj),s.initialize(serv.state,-1),serv.load.callbacks.push(function(){return o.menu=o.obj.frames,o.obj.frames=0}),s.file.push(this.display),s.canreeval=!1,s.exitscene(),this.pressed=0}return e.prototype.render=function(e){var t,n,r,i,s;this.pausesnd.step(),this.unpausesnd.step(),this.pressed>0&&(this.pressed===2&&this.unpausesnd.play(),this.obj.frames=0);if(this.pressed<0){this.display.size(this.underlay.size()),this.display.drawImage(this.underlay),this.pausesnd.play(),s=this.menu;for(r=0,i=s.length;r<i;r++){t=s[r];for(n in t)t[n].time!=null&&(t[n].time=0)}this.obj.initialize(this.menu)}return this.pressed=0,this.obj.render(e)},e.prototype.input=function(e){var t,n,r;return t=this.obj.frames===0?-1:1,r=this.obj.input(e),n=this.obj.frames===0?-1:1,this.pressed=e.pause.poll===1||t===1&&n===-1?t:0,e.pause.poll===1&&t===1&&(this.pressed=2),e.pause.poll===1&&this.obj.frame!=null&&this.obj.frame.overlay!==-1&&(this.pressed=0),r},e}(),savehandler=function(){function e(e){this.cansaveload=e}return e.prototype.validate=function(){try{return JSON.parse(localStorage.savestate),!0}catch(e){return!1}},e.prototype.savestate=function(e){var t,n;return t={global:serv.global},t.audio=serv.audio.savestate(),t.stack=serv.state.savestate(),t.local=function(){var e,t,r,i;r=serv.engine.rends,i=[];for(e=0,t=r.length;e<t;e++)n=r[e],n.savestate!=null&&i.push(n.savestate());return i}(),localStorage.savestate=JSON.stringify(t),e},e.prototype.loadstate=function(e){var t,n;return serv.reset(),t=JSON.parse(localStorage.savestate),serv.audio.mute(t.global.m),serv.engine.resize(new vect(t.global.s[0],t.global.s[1])),serv.scene.loadstate(t.stack),n=function(){return t.stack.length===0?serv.load.callbacks.push(function(){var e,n,r,i;i=serv.engine.rends;for(n=0,r=i.length;n<r;n++)e=i[n],e.loadstate!=null&&e.loadstate(t.local.shift());return serv.audio.loadstate(t.audio)}):serv.load.callbacks.push(n)},serv.load.callbacks.push(n),e},e}(),scenehandler=function(){function e(){this.currscene=0}return e.prototype.initialize=function(e){var t,n,r,i,s,o;this.currscene=e;if(this.currscene!==0){this.sprites={},this.currscene.focus=this.currscene[0],s=this.currscene,o=[];for(t=r=0,i=s.length;r<i;t=++r)n=s[t],this.sprites[n.id]=n,n.focus&&(this.currscene.focus=n),o.push(n.index=t);return o}},e.prototype.render=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;if(this.currscene!==0){this.currscene.sort(function(e,t){return t.area.p.y-e.area.p.y}),c=this.currscene;for(s=0,a=c.length;s<a;s++){r=c[s],typeof (i=r.aiscripts).frame=="function"&&i.frame(this.currscene),r.step();if(r.active){h=this.currscene;for(o=0,f=h.length;o<f;o++)n=h[o],r!==n&&n.collide(r)}}t=new vect(this.currscene.focus.area.p.x+(this.currscene.focus.area.s.x-e.dims.x)/2,this.currscene.focus.area.p.y+(this.currscene.focus.area.s.y-e.dims.y)/2),p=this.currscene;for(u=0,l=p.length;u<l;u++)r=p[u],r.render(e,t);return!0}return!1},e.prototype.input=function(e){var t,n,r,i,s;if(this.currscene!==0){s=this.currscene;for(r=0,i=s.length;r<i;r++)t=s[r],typeof (n=t.aiscripts).input=="function"&&n.input(this.currscene,e);return!0}return!1},e.prototype.savestate=function(){var e,t,n,r,i;if(this.currscene!==0){e=[],i=this.currscene;for(n=0,r=i.length;n<r;n++)t=i[n],e[t.index]=t.savestate();return e}},e.prototype.loadstate=function(e){var t,n,r,i;if(this.currscene!==0&&e!=null){i=this.currscene;for(n=0,r=i.length;n<r;n++)t=i[n],t.loadstate(e[t.index])}return!1},e}(),scenenode=function(){function e(e,t,n,r){this.child=e,this.filelist=t,this.init=n,this.callback=r,this.canreeval=!0}return e.prototype.initchild=function(e,t){var n,r=this;return typeof this.child[e]=="string"?(n=serv.load.load(this.child[e]),serv.load.callbacks.push(function(){var i;return i=serv.extern.setscene(n.txt),i.initialize(r,e),typeof t=="function"?t(i):void 0})):(this.child[e].initialize(this,e),typeof t=="function"?t(this.child[e]):void 0)},e.prototype.initialize=function(e,t){var n,r,i,s,o,u,a=this;this.parent=e,this.idx=t;if(this.canreeval){this.file=[],serv.audio.push(),serv.state=this,s=function(){var e,t,r,s;r=this.child,s=[];for(i=e=0,t=r.length;e<t;i=++e)n=r[i],n[0]==="~"&&s.push(i);return s}.call(this);if(this.filelist.length===0&&s.length===0)return serv.load.callbacks.length===0?this.init():serv.load.callbacks.push(function(){return a.init()});this.file=function(){var e,t,n,i;n=this.filelist,i=[];for(e=0,t=n.length;e<t;e++)r=n[e],i.push(serv.load.load(r));return i}.call(this);for(o=0,u=s.length;o<u;o++)i=s[o],this.child[i]=serv.load.load(child[i].substr(1));return serv.load.callbacks.push(function(){var e,t;for(e=0,t=s.length;e<t;e++)i=s[e],a.child[i]=serv.extern.setscene(a.child[i].txt);return a.init()})}},e.prototype.exitscene=function(e){var t;return serv.audio.clear(),serv.state=this.parent,typeof (t=this.parent).callback=="function"&&t.callback(this.idx),e},e.prototype.savestate=function(){var e;return this===serv.scene?[]:(e=this.parent.savestate(),e.push(this.idx),e)},e.prototype.loadstate=function(e){var t;if(e.length>0)return t=e.shift(),this.initchild(t,function(t){return t.loadstate(e)})},e}(),screenhandler=function(){function e(e){var t,n,r;this.elem={};for(n=0,r=e.length;n<r;n++)t=e[n],this.elem[t]=document.getElementById(t);this.reqframe=function(){var e,t,n,r,i;t=window.requestAnimationFrame,i=["ms","moz","webkit","o"];for(n=0,r=i.length;n<r;n++){e=i[n];if(t!=null)break;t=window[e+"RequestAnimationFrame"]}return t==null&&(t=function(e){return window.setTimeout(e,33.333333333333336)}),function(e){return t(e)}}()}return e.prototype.unwrap=function(e){return this.elem[e].parentNode.replaceChild(this.elem[e].firstChild,this.elem[e])},e.prototype.resize=function(e,t){return this.elem[e].style.width=t.x+"px",this.elem[e].style.height=t.y+"px"},e.prototype.fullscreen=function(e,t){return this.elem[e].className=t?"fullscreen":""},e.prototype.message=function(e,t,n){var r;return r=document.createElement("div"),r.innerText=t,this.elem[e].appendChild(r),window.setTimeout(function(){return this.elem[e].removeChild(r)},1e3*n)},e.prototype.animate=function(e){var t,n;return n=(new Date).getTime(),t=function(r){return serv.screen.clock=.03*(r-n),n=r,e(),serv.screen.reqframe(t)},serv.screen.reqframe(t)},e.prototype.getsysteminfo=function(){return this.basicsupport=Modernizr.canvas,this.render3D=Modernizr.webgl,this.cansaveload=Modernizr.localstorage,Modernizr.audio===!1||Modernizr.audio.mp3===""&&Modernizr.audio.ogg===""?this.soundext=0:Modernizr.audio.ogg==="probably"?this.soundext=".ogg":Modernizr.audio.mp3==="probably"?this.soundext=".mp3":Modernizr.audio.ogg==="maybe"?this.soundext=".ogg":this.soundext=".mp3"},e}(),soundhandler=function(){function e(e){this.soundext=e,this.volume=1,this.volnew=-1,this.muted=!1,this.list=[],serv.load.filetype["snd/"]=function(e){var t;return t=serv.audio.add(e+serv.audio.soundext),serv.audio.soundext!==0&&(serv.load.loadcount.push(t),t.data.addEventListener("error",function(){return t.data=-1,serv.load.err(t,e+serv.audio.soundext)}),t.data.addEventListener("canplaythrough",function(){return serv.load.finish(t)})),t}}return e.prototype.add=function(e){var t;return t=new audio(e),this.list[0].push(t),t},e.prototype.push=function(){return this.list.unshift([])},e.prototype.erase=function(){var e,t,n,r,i,s;i=this.list,s=[];for(e=n=0,r=i.length;n<r;e=++n)t=i[e],e!==0&&s.push(this.clear());return s},e.prototype.clear=function(){var e,t,n,r,i;r=this.list.shift(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.stop());return i},e.prototype.mute=function(e){return this.muted=e,serv.global.m=this.muted,this.volnew=-1},e.prototype.render=function(){var e,t,n,r,i,s,o;o=this.list;for(n=0,i=o.length;n<i;n++){t=o[n];for(r=0,s=t.length;r<s;r++)e=t[r],e.oldset&&!e.newset&&e.pause(),e.newset&&!e.oldset&&e.unpause(),e.oldset=e.newset,e.newset=!1,this.volnew!==this.volume&&e.fade()}return this.volnew=this.volume,!1},e.prototype.savestate=function(){var e,t,n,r,i,s;n=[this.volume],s=this.list;for(r=0,i=s.length;r<i;r++)t=s[r],n.push(function(){var n,r,i;i=[];for(n=0,r=t.length;n<r;n++)e=t[n],e.sndmode!==e.mode.pause?i.push(0):e.ii!==0?i.push(-1):e.datamode===e.mode.pause&&e.altdatamode===e.mode.pause?i.push(Math.min(e.data.currentTime,e.altdata.currentTime)):e.datamode===e.mode.pause?i.push(e.data.currentTime):i.push(e.altdata.currentTime);return i}());return n},e.prototype.loadstate=function(e){var t,n,r,i,s,o,u,a,f;this.volume=e.shift(),this.volnew=-1,f=this.list;for(i=s=0,u=f.length;s<u;i=++s){r=f[i];for(t=o=0,a=r.length;o<a;t=++o)n=r[t],n.sndmode===n.mode.stop&&e[i][t]!==0&&(e[i][t]>0&&(n.data.currentTime=e[i][t]),n.play(),n.pause()),n.sndmode!==n.mode.stop&&e[i][t]===0&&n.stop()}return!1},e}(),sprite=function(){function e(e){var t,n,r,i,s;t={sheet:0,area:new rect(0,0,0,0),carea:new rect(0,0,0,0),len:[],speed:[],solid:!1,active:!1,vector:new angle("spr",0),mode:0,frame:0,focus:!1,aiscripts:{}},this.id=(i=e.id)!=null?i:"";for(n in t)this[n]=(s=e[n])!=null?s:t[n];this.aiscripts!=={}&&(this.aiscripts.sprite=this),this.sheet!==0&&(this.id===""&&(this.id=this.sheet.buf.src.slice(1+this.sheet.buf.src.lastIndexOf("/"),-4)),r=this.sheet,this.sheet=new surface(new vect(8*this.area.s.x,r.dims.y)),this.sheet.ctx.scale(-1,1),this.sheet.drawImage(r,this.area.s.x,0,-3*this.area.s.x,0,3*this.area.s.x,r.dims.y),this.sheet.ctx.scale(-1,1),this.sheet.drawImage(r,0,0,3*this.area.s.x,0,5*this.area.s.x,r.dims.y))}return e.prototype.step=function(){var e;if(this.sheet!==0){e=this.vector.get("vlc"),this.area.p.x+=this.speed[this.mode]*e.x*serv.screen.clock,this.area.p.y+=this.speed[this.mode]*e.y*serv.screen.clock,this.frame+=.3*serv.screen.clock;if(this.frame<this.len[this.mode]||this.frame>=this.len[1+this.mode])return this.frame=this.len[this.mode]}},e.prototype.render=function(e,t){if(this.sheet!==0)return e.map(this.sheet,3+this.vector.get("spr"),Math.floor(this.frame),this.area.s.x,this.area.s.y,this.area.p.x-t.x,this.area.p.y-t.y,1,1)},e.prototype.collide=function(e){var t,n,r,i,s,o;t=e.area.p.x+e.carea.s.x-this.area.p.x-this.carea.p.x,n=e.area.p.y+e.carea.s.y-this.area.p.y-this.carea.p.y,r=this.area.p.x+this.carea.s.x-e.area.p.x-e.carea.p.x,i=this.area.p.y+this.carea.s.y-e.area.p.y-e.carea.p.y,o=1,s=t;if(t>0&&n>0&&r>0&&i>0){this.solid&&(s>n&&(s=n,o=2),s>r&&(s=r,o=3),s>i&&(s=i,o=4),o===1&&(e.area.p.x-=s),o===2&&(e.area.p.y-=s),o===3&&(e.area.p.x+=s),o===4&&(e.area.p.y+=s));if(this.aiscripts.trigger!=null)return e.mode=0,this.aiscripts.trigger(this,e)}},e.prototype.interact=function(e){var t,n,r,i;i=e.vector.get("kbd"),r=new rect(e.area.p.x+i.x*e.area.s.x/2,e.area.p.y+i.y*e.area.s.y/2,e.area.s.x,e.area.s.y),t=new i(r.p.x+r.s.x-this.area.p.x,r.p.y+r.s.y-this.area.p.y),n=new i(this.area.p.x+this.area.s.x-r.p.x,this.area.p.y+this.area.s.y-r.p.y);if(t.x>0&&t.y>0&&n.x>0&&n.y>0)return e.mode=0,this.aiscripts.interact(this,e)},e.prototype.savestate=function(){return{px:this.area.p.x,py:this.area.p.y,md:this.mode,fr:this.frame,vx:this.vector.get("spr")}},e.prototype.loadstate=function(e){return this.area.p.x=e.px,this.area.p.y=e.py,this.mode=e.md,this.frame=e.fr,this.vector.set("spr",e.vx)},e}(),surface=function(){function e(e){var t;e instanceof HTMLImageElement||e instanceof HTMLCanvasElement?(this.buf=e,this.dims=new vect(e.width,e.height)):(this.buf=document.createElement("canvas"),this.size(e)),this.ctx=typeof (t=this.buf).getContext=="function"?t.getContext("2d"):void 0}return e.prototype.size=function(e){return e!=null&&(this.dims=e,this.buf.width=e.x,this.buf.height=e.y),this.dims},e.prototype.clear=function(e){return e?this.ctx.fillRect(0,0,this.dims.x,this.dims.y):this.ctx.clearRect(0,0,this.dims.x,this.dims.y)},e.prototype.drawImage=function(){var e,t,n,r,i,s;n=arguments[0],e=2>arguments.length?[]:__slice.call(arguments,1);for(t=i=0,s=e.length;i<s;t=++i)r=e[t],e[t]=Math.round(r);switch(e.length){case 0:return this.ctx.drawImage(n.buf,0,0);case 2:return this.ctx.drawImage(n.buf,e[0],e[1]);case 4:return this.ctx.drawImage(n.buf,e[0],e[1],e[2],e[3]);case 6:return this.ctx.drawImage(n.buf,e[0],e[1],e[4],e[5],e[2],e[3],e[4],e[5]);case 8:return this.ctx.drawImage(n.buf,e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7])}},e.prototype.map=function(e,t,n,r,i,s,o,u,a){return a==null&&(u=r,a=i),this.drawImage(e,t*r,n*i,s*u,o*a,r,i)},e.prototype.layer=function(e,t){var n,r,i,s,o,u,a,f,l,c;return l=this.dims.x/2-t.x,c=this.dims.y/2-t.y,f=l+e.dims.x,o=c+e.dims.y,u=l>0?0:-l,n=l<0?0:l,a=c>0?0:-c,r=c<0?0:c,s=(f>this.dims.x?this.dims.x:f)-n,i=(o>this.dims.y?this.dims.y:o)-r,this.drawImage(e,u,a,n,r,s,i)},e}(),tileset=function(e){function t(e,n,r,i,s,o){var u,a,f,l,c,h,p,d,v,m,g;this.tilesize=e,this.tilesheet=n,this.coll=r,this.bgmusic=i,this.bgmusic!==0&&this.bgmusic.play(),serv.engine.bgcolor=s,serv.engine.buffer.ctx.fillStyle=s,this.coll.push(1),t.__super__.constructor.call(this,{solid:!0,area:new rect(0,0,this.tilesize.x,this.tilesize.y),carea:new rect(0,0,this.tilesize.x,this.tilesize.y)}),u=new vect(o[0].length,o.length),this.sheet=new surface(new vect(this.tilesize.x*u.x,this.tilesize.y*u.y)),p=this.tilesheet.dims.x/this.tilesize.x,this.grid=function(){var e,t,n;n=[];for(a=e=0,t=u.x+2;0>t?e>t:e<t;a=0>t?--e:++e)n.push(function(){var e,t,n;n=[];for(f=e=0,t=u.y+2;0>t?e>t:e<t;f=0>t?--e:++e)a===0||f===0||a===u.x+1||f===u.y+1?n.push(this.coll.length-1):n.push(o[f-1][a-1]);return n}.call(this));return n}.call(this);for(a=d=0,m=u.x;0>m?d>m:d<m;a=0>m?--d:++d)for(f=v=0,g=u.y;0>g?v>g:v<g;f=0>g?--v:++v)h=Math.floor(this.grid[1+a][1+f]/p),c=this.grid[1+a][1+f]-h*p,this.sheet.map(this.tilesheet,c,h,this.tilesize.x,this.tilesize.y,a,f);l=function(e,t,n,r,i){var s;return s=1/(t*t+1),function(o,u,a,f){var l,c,h;if(u[e]>t*u[n]+r){l=i?new vect(f.x,a.y):a;if(
l[e]>t*l[n]+r)return}else{l=i?new vect(a.x,f.y):f;if(l[e]<=t*l[n]+r)return}return c=(l[n]+t*l[e]-t*r)*s,h=t*c+r,o[n]+=c-l[n],o[e]+=h-l[e]}},this.solve=[l("y",this.tilesize.y/this.tilesize.x,"x",-this.tilesize.y,!0),l("y",-this.tilesize.y/this.tilesize.x,"x",this.tilesize.y,!1),l("y",this.tilesize.y/this.tilesize.x,"x",this.tilesize.y,!0),l("y",-this.tilesize.y/this.tilesize.x,"x",3*this.tilesize.y,!1),l("y",-this.tilesize.y/this.tilesize.x,"x",2*this.tilesize.y,!1),l("y",this.tilesize.y/this.tilesize.x,"x",0,!0),l("y",0,"x",this.tilesize.y,!1),l("x",0,"y",this.tilesize.x,!1)]}return __extends(t,e),t.prototype.step=function(){},t.prototype.render=function(e,t){return this.bgmusic!==0&&this.bgmusic.step(),e.layer(this.sheet,new vect(t.x+e.dims.x/2,t.y+e.dims.y/2))},t.prototype.collide=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;for(;;){h=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],c=new vect((e.area.p.x+e.carea.p.x)%this.tilesize.x,(e.area.p.y+e.carea.p.y)%this.tilesize.y),u=new vect(c.x-e.carea.p.x+e.carea.s.x,c.y-e.carea.p.y+e.carea.s.y),r=new vect((c.x+u.x)/2,(c.y+u.y)/2),n=new vect(1+Math.floor((e.area.p.x+e.carea.p.x)/this.tilesize.x),1+Math.floor((e.area.p.y+e.carea.p.y)/this.tilesize.y)),g=[[1,0],[0,0],[0,1],[1,1]];for(a=p=0,m=g.length;p<m;a=++p){f=g[a];switch(this.coll[this.grid[n.x+f[0]][n.y+f[1]]]){case 1:h[3*a]=!h[3*a],h[3*a+3]=!h[3*a+3];break;case 2:h[3*a+1]=!0;break;case 3:h[3*a+2]=!0}}h[0]=h[0]!==h.pop();if(this.tilesize.x<u.x&&this.tilesize.y<u.y){t={val:0,idx:-1},o=[u.x-this.tilesize.x,this.tilesize.y-c.y,this.tilesize.x-c.x,u.y-this.tilesize.y,u.x-this.tilesize.x];for(a=d=0;d<=3;a=++d)s={val:Math.min(o[a],o[a+1]),idx:3*a+a%2+1},h[3*a]&&o[a]>t.val&&(t={val:o[a],idx:3*a}),h[s.idx]&&s.val>t.val&&(t=s),h[3*a]=h[s.idx]=!1;h[t.idx]=!0}else h[0]=h[9]=h[10]=h[11]=!1,this.tilesize.x>=u.x&&(h[1]=h[2]=h[3]=!1),this.tilesize.y>=u.y&&(h[6]=h[7]=h[8]=!1);i=[h[2],h[4],h[8],h[10],h[1]||h[7],h[5]||h[11],h[0]||h[6],h[3]||h[9]],l=new vect(0,0);for(a=v=0;v<=7;a=++v)i[a]&&this.solve[a](l,r,c,u);e.area.p.x+=l.x,e.area.p.y+=l.y;if(l.x===0&&l.y===0)return}},t}(sprite),vect=function(){function e(e,t){this.x=e,this.y=t}return e}(),rect=function(){function e(e,t,n,r){this.p=new vect(e,t),this.s=new vect(n,r)}return e}(),angle=function(){function e(e,t){this.set(e,t)}return e.prototype.get=function(e){switch(e){case"spr":return this.value;case"kbd":return new vect([0,-1,-1,-1,0,1,1,1,0][4+this.value],[0,1,0,-1,-1,-1,0,1,1][4+this.value]);case"vlc":return new vect([0,-0.707,-1,-0.707,0,.707,1,.707,0][4+this.value],[0,.707,0,-0.707,-1,-0.707,0,.707,1][4+this.value])}},e.prototype.set=function(e,t,n){switch(e){case"spr":return this.value=t;case"kbd":return this.value=[[-1,0,1],[-2,-4,2],[-3,4,3]][1+t.y][1+t.x];case"pts":return this.value=this.getpts(t,n)}},e.prototype.getpts=function(e,t){var n,r,i,s;return i=e.x-t.x,s=e.y-t.y,i===0?n=s>0?0:4:(r=s/i,i<0&&(r>2.41421356&&(n=4),.414213562<r&&r<=2.41421356&&(n=3),-0.414213562<r&&r<=.414213562&&(n=2),-2.41421356<r&&r<=-0.414213562&&(n=1),r<=-2.41421356&&(n=0)),i>0&&(r>2.41421356&&(n=0),.414213562<r&&r<=2.41421356&&(n=-1),-0.414213562<r&&r<=.414213562&&(n=-2),-2.41421356<r&&r<=-0.414213562&&(n=-3),r<=-2.41421356&&(n=4))),n},e}()}).call(this);