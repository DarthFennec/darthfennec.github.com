<!DOCTYPE html>  <html> <head>   <title>sprite.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="icon" type="image/x-icon" href="http://spinnychair.co.cc/img/favicon.ico">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="aiscripts.html">                 aiscripts.coffee               </a>                                           <a class="source" href="audio.html">                 audio.coffee               </a>                                           <a class="source" href="cutscene.html">                 cutscene.coffee               </a>                                           <a class="source" href="engine.html">                 engine.coffee               </a>                                           <a class="source" href="format.html">                 format.coffee               </a>                                           <a class="source" href="load.html">                 load.coffee               </a>                                           <a class="source" href="pause.html">                 pause.coffee               </a>                                           <a class="source" href="save.html">                 save.coffee               </a>                                           <a class="source" href="scene.html">                 scene.coffee               </a>                                           <a class="source" href="scenenode.html">                 scenenode.coffee               </a>                                           <a class="source" href="sound.html">                 sound.coffee               </a>                                           <a class="source" href="sprite.html">                 sprite.coffee               </a>                                           <a class="source" href="surface.html">                 surface.coffee               </a>                                           <a class="source" href="sysinf.html">                 sysinf.coffee               </a>                                           <a class="source" href="tile.html">                 tile.coffee               </a>                                           <a class="source" href="unit.html">                 unit.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <a id="ribbon" href="https://github.com/DarthFennec"><img src="http://spinnychair.co.cc/img/forkme.png" /></a>             <h1>               sprite.coffee             </h1>           </th>           <th class="code">             <h1>               <a id="title" href="http://spinnychair.co.cc">Spinny Chair</a>             </h1>           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>The general sprite implementation.</strong></p>

<ul>
<li>sheet: The spritesheet.</li>
<li>area: The position and size of the sprite.</li>
<li>callback: Called in trigger and interact events.</li>
<li>aiscript: Called every frame.</li>
<li>len: Animation length for each mode.</li>
<li>speed: Movement speed for each mode.</li>
<li>collide: <em>true</em> if the sprite is solid.</li>
<li>trigger: <em>true</em> if there's a trigger event.</li>
<li>interact: <em>true</em> if there's an interact event.</li>
<li>passive: <em>true</em> if the sprite doesn't move/collide.</li>
<li>vector: The direction the sprite is pointing.</li>
<li>mode: The mode (standing, walking, running, etc).</li>
<li>frame: The animation frame index.</li>
</ul>

<p>Sprites can represent anything from maps to player characters to NPCs
to invisible trigger fields to interactive stationary objects, etc etc.
Everything in the scene can be represented by a sprite.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">sprite</span>
  <span class="nv">constructor: </span><span class="nf">(args) -&gt;</span>
    <span class="nv">def =</span>
      <span class="nv">sheet    : </span><span class="mi">0</span>
      <span class="nv">area     : </span><span class="k">new</span> <span class="nx">rect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      <span class="nv">callback : </span><span class="mi">0</span>
      <span class="nv">aiscript : </span><span class="mi">0</span>
      <span class="nv">len      : </span><span class="p">[]</span>
      <span class="nv">speed    : </span><span class="p">[]</span>
      <span class="nv">collide  : </span><span class="kc">false</span>
      <span class="nv">trigger  : </span><span class="kc">false</span>
      <span class="nv">interact : </span><span class="kc">false</span>
      <span class="nv">passive  : </span><span class="kc">false</span>
      <span class="nv">vector   : </span><span class="k">new</span> <span class="nx">angle</span> <span class="s2">&quot;spr&quot;</span><span class="p">,</span> <span class="mi">0</span>
      <span class="nv">mode     : </span><span class="mi">0</span>
      <span class="nv">frame    : </span><span class="mi">0</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">?</span> <span class="nx">def</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="k">for</span> <span class="nx">prop</span> <span class="k">of</span> <span class="nx">def</span>
    <span class="k">if</span> <span class="nx">@sheet</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nv">tmp = </span><span class="nx">@sheet</span>
      <span class="vi">@sheet = </span><span class="k">new</span> <span class="nx">surface</span> <span class="k">new</span> <span class="nx">vect</span> <span class="mi">8</span><span class="o">*</span><span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span>
      <span class="nx">@sheet</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
      <span class="nx">@sheet</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">tmp</span><span class="p">,</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span>
      <span class="nx">@sheet</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
      <span class="nx">@sheet</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Select the correct tile from the spritesheet, based on <em>vector</em>, <em>mode</em>,
and <em>frame</em>, and draw it to the screen based on <em>area</em>. Then update <em>area</em>
and <em>frame</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">step: </span><span class="nf">(buff, offset) -&gt;</span>
    <span class="k">if</span> <span class="nx">@sheet</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="vi">@frame = </span><span class="nx">@len</span><span class="p">[</span><span class="nx">@mode</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@frame</span> <span class="o">&lt;</span> <span class="nx">@len</span><span class="p">[</span><span class="nx">@mode</span><span class="p">]</span> <span class="o">or</span> <span class="nx">@frame</span> <span class="o">&gt;=</span> <span class="nx">@len</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">@mode</span><span class="p">]</span>
      <span class="nx">buff</span><span class="p">.</span><span class="nx">map</span> <span class="nx">@sheet</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="nx">@vector</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;spr&quot;</span><span class="p">),</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">@frame</span><span class="p">),</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
      <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">l</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@speed</span><span class="p">[</span><span class="nx">@mode</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nx">@vector</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;vlc&quot;</span><span class="p">).</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
      <span class="nx">@frame</span> <span class="o">+=</span> <span class="mf">0.3</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Detect collisions by calculating the distance from each edge of one
sprite to the alternate edge of the other. If every distance is positive,
there is an overlap, so determine the direction of least overlap and
push the sprite out in that direction (if the sprite is solid), and/or
trigger an event (if the corresponding flag is set).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">docollide: </span><span class="nf">(spr) -&gt;</span>
    <span class="nv">off1 = </span><span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">off2 = </span><span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">off3 = </span><span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">off4 = </span><span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">offx = </span><span class="mi">1</span>
    <span class="nv">offset = </span><span class="nx">off1</span>
    <span class="k">if</span> <span class="nx">off1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">off2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">off3</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">off4</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">@collide</span>
        <span class="k">if</span> <span class="nx">offset</span> <span class="o">&gt;</span> <span class="nx">off2</span>
          <span class="nv">offset = </span><span class="nx">off2</span>
          <span class="nv">offx = </span><span class="mi">2</span>
        <span class="k">if</span> <span class="nx">offset</span> <span class="o">&gt;</span> <span class="nx">off3</span>
          <span class="nv">offset = </span><span class="nx">off3</span>
          <span class="nv">offx = </span><span class="mi">3</span>
        <span class="k">if</span> <span class="nx">offset</span> <span class="o">&gt;</span> <span class="nx">off4</span>
          <span class="nv">offset = </span><span class="nx">off4</span>
          <span class="nv">offx = </span><span class="mi">4</span>
        <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">offset</span> <span class="k">if</span> <span class="nx">offx</span> <span class="o">is</span> <span class="mi">1</span>
        <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">offset</span> <span class="k">if</span> <span class="nx">offx</span> <span class="o">is</span> <span class="mi">2</span>
        <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">offset</span> <span class="k">if</span> <span class="nx">offx</span> <span class="o">is</span> <span class="mi">3</span>
        <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">offset</span> <span class="k">if</span> <span class="nx">offx</span> <span class="o">is</span> <span class="mi">4</span>
      <span class="k">if</span> <span class="nx">@trigger</span>
        <span class="nv">spr.mode = </span><span class="mi">0</span>
        <span class="nx">@callback</span> <span class="k">this</span><span class="p">,</span> <span class="nx">spr</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>When the action key is pressed, and a sprite is within the main sprite's
field of view (in this case, less than half a sprite away in the direction
the main sprite is facing), a sprite might "interact" via its <em>callback</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dointeract: </span><span class="nf">(spr) -&gt;</span>
    <span class="nv">offx = </span><span class="k">new</span> <span class="nx">rect</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">spr</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">y</span>
    <span class="nx">offx</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">l</span> <span class="nf">(k) -&gt;</span> <span class="nx">offx</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">spr</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;kbd&quot;</span><span class="p">).</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span><span class="o">*</span><span class="nx">offx</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="nv">off1 = </span><span class="p">(</span><span class="k">new</span> <span class="nx">vect</span><span class="p">).</span><span class="nx">l</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">offx</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="nx">offx</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">-</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
    <span class="nv">off2 = </span><span class="p">(</span><span class="k">new</span> <span class="nx">vect</span><span class="p">).</span><span class="nx">l</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@area</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">-</span> <span class="nx">offx</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">i</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">off1</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">off1</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">off2</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">off2</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">spr.mode = </span><span class="mi">0</span>
      <span class="nx">@callback</span> <span class="k">this</span><span class="p">,</span> <span class="nx">spr</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Gather and return data to be saved.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">savestate: </span><span class="o">-&gt;</span> <span class="p">{</span><span class="nv">px: </span><span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nv">py: </span><span class="nx">@area</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nv">md: </span><span class="nx">@mode</span><span class="p">,</span> <span class="nv">fr: </span><span class="nx">@frame</span><span class="p">,</span> <span class="nv">vx: </span><span class="nx">@vector</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;spr&quot;</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Distribute save data to be used.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">loadstate: </span><span class="nf">(state) -&gt;</span>
    <span class="vi">@area.p.x = </span><span class="nx">state</span><span class="p">.</span><span class="nx">px</span>
    <span class="vi">@area.p.y = </span><span class="nx">state</span><span class="p">.</span><span class="nx">py</span>
    <span class="vi">@mode = </span><span class="nx">state</span><span class="p">.</span><span class="nx">md</span>
    <span class="vi">@frame = </span><span class="nx">state</span><span class="p">.</span><span class="nx">fr</span>
    <span class="nx">@vector</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;spr&quot;</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">vx</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 