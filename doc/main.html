<!DOCTYPE html>  <html> <head>   <title>main.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="icon" type="image/x-icon" href="http://spinnychair.net/img/favicon.ico">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="aiscripts.html">                 aiscripts.coffee               </a>                                           <a class="source" href="audio.html">                 audio.coffee               </a>                                           <a class="source" href="cutscene.html">                 cutscene.coffee               </a>                                           <a class="source" href="engine.html">                 engine.coffee               </a>                                           <a class="source" href="extscene.html">                 extscene.coffee               </a>                                           <a class="source" href="load.html">                 load.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="pause.html">                 pause.coffee               </a>                                           <a class="source" href="save.html">                 save.coffee               </a>                                           <a class="source" href="scene.html">                 scene.coffee               </a>                                           <a class="source" href="scenenode.html">                 scenenode.coffee               </a>                                           <a class="source" href="screen.html">                 screen.coffee               </a>                                           <a class="source" href="sound.html">                 sound.coffee               </a>                                           <a class="source" href="sprite.html">                 sprite.coffee               </a>                                           <a class="source" href="surface.html">                 surface.coffee               </a>                                           <a class="source" href="tile.html">                 tile.coffee               </a>                                           <a class="source" href="unit.html">                 unit.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <a id="ribbon" href="https://github.com/DarthFennec">               <img src="http://spinnychair.net/img/forkme.png" />             </a>             <h1>               main.coffee             </h1>           </th>           <th class="code">             <h1>               <a id="title" href="http://spinnychair.net">Spinny Chair</a>             </h1>           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Global singleton, to contain service objects and common global variables.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">serv = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Initial function. Create and set up a minimal working engine object,
bind its IO to the DOM, and load the root scene.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">onload = </span><span class="nf">-&gt;</span>
  <span class="nv">serv.screen = </span><span class="k">new</span> <span class="nx">screenhandler</span> <span class="p">[</span><span class="s">&quot;display&quot;</span><span class="p">,</span> <span class="s">&quot;miskatonic&quot;</span><span class="p">,</span> <span class="s">&quot;errorbox&quot;</span><span class="p">]</span>
  <span class="nv">screen = </span><span class="k">new</span> <span class="nx">surface</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">serv</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">getsysteminfo</span><span class="p">()</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">basicsupport</span> <span class="k">then</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">unwrap</span> <span class="mi">1</span> <span class="k">else</span>
    <span class="nv">keymap = up: </span><span class="p">[</span><span class="mi">38</span><span class="p">,</span> <span class="mi">87</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">188</span><span class="p">],</span> <span class="nv">left: </span><span class="p">[</span><span class="mi">37</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">81</span><span class="p">],</span> <span class="nv">down: </span><span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">83</span><span class="p">],</span> <span class="nv">right: </span><span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">],</span> <span class="nv">run: </span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="nv">act: </span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="nv">pause: </span><span class="p">[</span><span class="mi">27</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span>
    <span class="nv">serv.global = m: </span><span class="kc">no</span><span class="p">,</span> <span class="nv">s: </span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">]</span>
    <span class="nv">serv.load = </span><span class="k">new</span> <span class="nx">loader</span>
    <span class="nv">serv.save = </span><span class="k">new</span> <span class="nx">savehandler</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">cansaveload</span>
    <span class="nv">serv.audio = </span><span class="k">new</span> <span class="nx">soundhandler</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">soundext</span>
    <span class="nv">serv.extern = </span><span class="k">new</span> <span class="nx">extscene</span>
    <span class="nv">serv.reset = </span><span class="nf">-&gt;</span>
      <span class="nx">serv</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">erase</span><span class="p">()</span>
      <span class="nv">serv.state = </span><span class="nx">serv</span><span class="p">.</span><span class="nx">scene</span>
    <span class="nv">serv.scene = </span><span class="k">new</span> <span class="nx">scenenode</span> <span class="p">[</span><span class="s">&quot;txt/title.json&quot;</span><span class="p">,</span> <span class="s">&quot;txt/scene.json&quot;</span><span class="p">],</span>
      <span class="p">[</span><span class="s">&quot;img/text&quot;</span><span class="p">,</span> <span class="s">&quot;img/pause&quot;</span><span class="p">,</span> <span class="s">&quot;snd/next&quot;</span><span class="p">,</span> <span class="s">&quot;snd/last&quot;</span><span class="p">,</span> <span class="s">&quot;snd/omenu&quot;</span><span class="p">,</span> <span class="s">&quot;snd/cmenu&quot;</span><span class="p">,</span> <span class="s">&quot;txt/pause.json&quot;</span><span class="p">]</span>
      <span class="nf">-&gt;</span>
        <span class="vi">@canreeval = </span><span class="kc">no</span>
        <span class="nv">surf = </span><span class="k">new</span> <span class="nx">surface</span> <span class="k">new</span> <span class="nx">vect</span> <span class="mi">656</span><span class="p">,</span> <span class="mi">208</span>
        <span class="nv">surf.ctx.fillStyle = </span><span class="s">&quot;</span><span class="err">#</span><span class="s">000000&quot;</span>
        <span class="nv">surf.ctx.globalAlpha = </span><span class="mf">0.7</span>
        <span class="nx">surf</span><span class="p">.</span><span class="nx">clear</span> <span class="kc">no</span>
        <span class="nx">surf</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
        <span class="nx">surf</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">yes</span>
        <span class="nx">surf</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="kc">yes</span>
        <span class="nx">surf</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">yes</span>
        <span class="nx">surf</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="kc">yes</span>
        <span class="nx">surf</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span>
        <span class="nv">surf.ctx.globalAlpha = </span><span class="mf">1.0</span>
        <span class="nv">serv.getai = </span><span class="k">new</span> <span class="nx">aiscripts</span>
        <span class="nv">serv.inscenemgr = </span><span class="k">new</span> <span class="nx">scenehandler</span>
        <span class="nv">serv.outscenemgr = </span><span class="k">new</span> <span class="nx">scenehandler</span>
        <span class="nv">serv.cutscenemgr = </span><span class="k">new</span> <span class="nx">cutscenehandler</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">surf</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nx">rect</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="k">new</span> <span class="nx">rect</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="k">new</span> <span class="nx">vect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">124</span><span class="p">),</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="nv">pausescene = </span><span class="k">new</span> <span class="nx">cutscenehandler</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="k">new</span> <span class="nx">rect</span> <span class="mi">41</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="k">new</span> <span class="nx">rect</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="p">(</span><span class="k">new</span> <span class="nx">vect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="nv">serv.pausemgr = </span><span class="k">new</span> <span class="nx">pauser</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">screen</span><span class="p">,</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="nx">txt</span><span class="p">,</span> <span class="nx">pausescene</span><span class="p">,</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">@file</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="nx">serv</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">rends</span><span class="p">.</span><span class="nx">push</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">pausemgr</span><span class="p">,</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">cutscenemgr</span><span class="p">,</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">inscenemgr</span><span class="p">,</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">outscenemgr</span>
      <span class="nf">(idx) -&gt;</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">@initchild</span> <span class="p">(</span><span class="k">if</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">is</span> <span class="nx">@child</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nv">serv.engine = </span><span class="k">new</span> <span class="nx">engine</span> <span class="p">[</span><span class="nx">serv</span><span class="p">.</span><span class="nx">audio</span><span class="p">,</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">],</span> <span class="nx">screen</span><span class="p">,</span> <span class="nx">keymap</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;keydown&quot;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">input</span> <span class="p">(</span><span class="nf">-&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()),</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="mi">1</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;keyup&quot;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">input</span> <span class="p">(</span><span class="nf">-&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()),</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span> <span class="p">(</span><span class="nf">-&gt;</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">step</span><span class="p">()),</span> <span class="mi">33</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 