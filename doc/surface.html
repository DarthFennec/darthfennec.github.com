<!DOCTYPE html>  <html> <head>   <title>surface.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="icon" type="image/x-icon" href="http://spinnychair.net/img/favicon.ico">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="aiscripts.html">                 aiscripts.coffee               </a>                                           <a class="source" href="audio.html">                 audio.coffee               </a>                                           <a class="source" href="cutscene.html">                 cutscene.coffee               </a>                                           <a class="source" href="engine.html">                 engine.coffee               </a>                                           <a class="source" href="extscene.html">                 extscene.coffee               </a>                                           <a class="source" href="load.html">                 load.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="pause.html">                 pause.coffee               </a>                                           <a class="source" href="save.html">                 save.coffee               </a>                                           <a class="source" href="scene.html">                 scene.coffee               </a>                                           <a class="source" href="scenenode.html">                 scenenode.coffee               </a>                                           <a class="source" href="screen.html">                 screen.coffee               </a>                                           <a class="source" href="sound.html">                 sound.coffee               </a>                                           <a class="source" href="sprite.html">                 sprite.coffee               </a>                                           <a class="source" href="surface.html">                 surface.coffee               </a>                                           <a class="source" href="tile.html">                 tile.coffee               </a>                                           <a class="source" href="unit.html">                 unit.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <a id="ribbon" href="https://github.com/DarthFennec">               <img src="http://spinnychair.net/img/forkme.png" />             </a>             <h1>               surface.coffee             </h1>           </th>           <th class="code">             <h1>               <a id="title" href="http://spinnychair.net">Spinny Chair</a>             </h1>           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>A wrapper for HTML drawable surfaces.</strong></p>

<ul>
<li>Abstract the distinction between an Image and a Canvas element.</li>
<li>Abstract the distinction between a Canvas element and its 2D context, like so: <br />
<code>surfaceobj1.drawImage surfaceobj2, 0, 0</code> <br />
rather than: <br />
<code>drawingcontext.drawImage somecanvas, 0, 0</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">surface</span>
  <span class="nv">constructor: </span><span class="nf">(arg) -&gt;</span>
    <span class="k">if</span> <span class="nx">arg</span> <span class="k">instanceof</span> <span class="nx">HTMLImageElement</span> <span class="o">or</span> <span class="nx">arg</span> <span class="k">instanceof</span> <span class="nx">HTMLCanvasElement</span>
      <span class="vi">@buf = </span><span class="nx">arg</span>
      <span class="vi">@dims = </span><span class="k">new</span> <span class="nx">vect</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">height</span>
    <span class="k">else</span>
      <span class="vi">@buf = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&quot;canvas&quot;</span>
      <span class="nx">@size</span> <span class="nx">arg</span>
    <span class="vi">@ctx = </span><span class="nx">@buf</span><span class="p">.</span><span class="nx">getContext</span><span class="o">?</span> <span class="s">&quot;2d&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Set and/or get the size of the surface.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">size: </span><span class="nf">(newsize) -&gt;</span>
    <span class="k">if</span> <span class="nx">newsize</span><span class="o">?</span>
      <span class="vi">@dims = </span><span class="nx">newsize</span>
      <span class="vi">@buf.width = </span><span class="nx">newsize</span><span class="p">.</span><span class="nx">x</span>
      <span class="vi">@buf.height = </span><span class="nx">newsize</span><span class="p">.</span><span class="nx">y</span>
    <span class="nx">@dims</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Clear/fill the surface, with transparency/color.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clear: </span><span class="nf">(opaque) -&gt;</span>
    <span class="k">if</span> <span class="nx">opaque</span> <span class="k">then</span> <span class="nx">@ctx</span><span class="p">.</span><span class="nx">fillRect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">y</span>
    <span class="k">else</span> <span class="nx">@ctx</span><span class="p">.</span><span class="nx">clearRect</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Wrapper for ctx.drawImage, supporting a wider range of
placement options. Round all placement options to the
nearest pixel, to keep HTML from interpolating pixel colors
and making the images blurry.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawImage: </span><span class="nf">(src, d...) -&gt;</span>
    <span class="nx">d</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">d</span>
    <span class="k">switch</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">@ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">src</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      <span class="k">when</span> <span class="mi">2</span> <span class="k">then</span> <span class="nx">@ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">src</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">when</span> <span class="mi">4</span> <span class="k">then</span> <span class="nx">@ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">src</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
      <span class="k">when</span> <span class="mi">6</span> <span class="k">then</span> <span class="nx">@ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">src</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
      <span class="k">when</span> <span class="mi">8</span> <span class="k">then</span> <span class="nx">@ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">src</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="nx">d</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Like drawImage, but for tiles. Copy a tile from <em>src</em> with specified size
at specified tile position, and put it at specified destination position,
given a destination tile size. Note that the tile is not resized to match the
destination tile size. If no size is given, the source size is used.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">map: </span><span class="nf">(src, sx, sy, sw, sh, dx, dy, dw, dh) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">dh</span><span class="o">?</span>
      <span class="nv">dw = </span><span class="nx">sw</span>
      <span class="nv">dh = </span><span class="nx">sh</span>
    <span class="nx">@drawImage</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">sx</span><span class="o">*</span><span class="nx">sw</span><span class="p">,</span> <span class="nx">sy</span><span class="o">*</span><span class="nx">sh</span><span class="p">,</span> <span class="nx">dx</span><span class="o">*</span><span class="nx">dw</span><span class="p">,</span> <span class="nx">dy</span><span class="o">*</span><span class="nx">dh</span><span class="p">,</span> <span class="nx">sw</span><span class="p">,</span> <span class="nx">sh</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Copy a destination-sized area out of <em>src</em>, at <em>pos</em>. <br />
Trying to copy any part of an image that lies outside of its bounds
results in failure, in HTML5. This function checks for that case,
and takes steps to avoid it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">layer: </span><span class="nf">(src, pos) -&gt;</span>
    <span class="nv">x = </span><span class="nx">@dims</span><span class="p">.</span><span class="nx">x</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">y = </span><span class="nx">@dims</span><span class="p">.</span><span class="nx">y</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">w = </span><span class="nx">x</span> <span class="o">+</span> <span class="nx">src</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">h = </span><span class="nx">y</span> <span class="o">+</span> <span class="nx">src</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">sx = </span><span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="nx">x</span>
    <span class="nv">dx = </span><span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">x</span>
    <span class="nv">sy = </span><span class="k">if</span> <span class="nx">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="nx">y</span>
    <span class="nv">dy = </span><span class="k">if</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nx">y</span>
    <span class="nv">fw = </span><span class="p">(</span><span class="k">if</span> <span class="nx">w</span> <span class="o">&gt;</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">x</span> <span class="k">then</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">x</span> <span class="k">else</span> <span class="nx">w</span><span class="p">)</span> <span class="o">-</span> <span class="nx">dx</span>
    <span class="nv">fh = </span><span class="p">(</span><span class="k">if</span> <span class="nx">h</span> <span class="o">&gt;</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">y</span> <span class="k">then</span> <span class="nx">@dims</span><span class="p">.</span><span class="nx">y</span> <span class="k">else</span> <span class="nx">h</span><span class="p">)</span> <span class="o">-</span> <span class="nx">dy</span>
    <span class="nx">@drawImage</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">,</span> <span class="nx">fw</span><span class="p">,</span> <span class="nx">fh</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 