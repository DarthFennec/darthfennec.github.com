<!DOCTYPE html>  <html> <head>   <title>sound.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="icon" type="image/x-icon" href="http://spinnychair.net/img/favicon.ico">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="aiscripts.html">                 aiscripts.coffee               </a>                                           <a class="source" href="audio.html">                 audio.coffee               </a>                                           <a class="source" href="cutscene.html">                 cutscene.coffee               </a>                                           <a class="source" href="engine.html">                 engine.coffee               </a>                                           <a class="source" href="extscene.html">                 extscene.coffee               </a>                                           <a class="source" href="load.html">                 load.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="pause.html">                 pause.coffee               </a>                                           <a class="source" href="save.html">                 save.coffee               </a>                                           <a class="source" href="scene.html">                 scene.coffee               </a>                                           <a class="source" href="scenenode.html">                 scenenode.coffee               </a>                                           <a class="source" href="screen.html">                 screen.coffee               </a>                                           <a class="source" href="sound.html">                 sound.coffee               </a>                                           <a class="source" href="sprite.html">                 sprite.coffee               </a>                                           <a class="source" href="surface.html">                 surface.coffee               </a>                                           <a class="source" href="tile.html">                 tile.coffee               </a>                                           <a class="source" href="unit.html">                 unit.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <a id="ribbon" href="https://github.com/DarthFennec">               <img src="http://spinnychair.net/img/forkme.png" />             </a>             <h1>               sound.coffee             </h1>           </th>           <th class="code">             <h1>               <a id="title" href="http://spinnychair.net">Spinny Chair</a>             </h1>           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>The audio server system.</strong></p>

<ul>
<li>Keep track of all sounds being currently used. Organize them in a stack
of lists. Each list in the stack represents a scene node in the tree,
and the collection of sounds loaded with that scene node. This makes
it easy to automatically unload sounds, without unloading the wrong ones.</li>
<li>Most of the engine depends on stack blocking: to pause the game or wait
for things to load, the render functions are simply ignored, because the
default behavior of graphics is to do nothing. However, the default behavior
of audio is to continue to play, so stack blocking doesn't work. <br />
This class helps to abstract stack blocking into the audio system.
Each <a href="audio.html">audio object</a> is required to run <em>step</em> each frame
to continue playing. When the stack is blocked, the <em>step</em> functions
won't be run. This system automatically plays and pauses sounds as it
detects changes in how frequently the <em>step</em> function is run.</li>
<li>Provide global volume and mute functions, which affect all loaded sounds.</li>
</ul>

<p>This layer will never block, and should never be blocked. Keep it at the
top of the render stack.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">soundhandler</span>
  <span class="nv">constructor: </span><span class="nf">(@soundext) -&gt;</span>
    <span class="vi">@volume = </span><span class="mi">1</span>
    <span class="vi">@volnew = </span><span class="o">-</span><span class="mi">1</span>
    <span class="vi">@muted = </span><span class="kc">no</span>
    <span class="vi">@list = </span><span class="p">[]</span>
    <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">filetype</span><span class="p">[</span><span class="s">&quot;snd/&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(url) -&gt;</span>
      <span class="nv">newf = </span><span class="nx">serv</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">add</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">soundext</span>
      <span class="k">if</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">soundext</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">loadcount</span><span class="p">.</span><span class="nx">push</span> <span class="nx">newf</span>
        <span class="nx">newf</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span>
          <span class="nv">newf.data = </span><span class="o">-</span><span class="mi">1</span>
          <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">err</span> <span class="nx">newf</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">audio</span><span class="p">.</span><span class="nx">soundext</span>
        <span class="nx">newf</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;canplaythrough&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">finish</span> <span class="nx">newf</span>
      <span class="nx">newf</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Add a sound to the top list in the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="nf">(sndurl) -&gt;</span>
    <span class="nv">newsound = </span><span class="k">new</span> <span class="nx">audio</span> <span class="nx">sndurl</span>
    <span class="nx">@list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">push</span> <span class="nx">newsound</span>
    <span class="nx">newsound</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Add an empty list to the top of the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">push: </span><span class="nf">-&gt;</span> <span class="nx">@list</span><span class="p">.</span><span class="nx">unshift</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Clear the entire stack, except the bottom list. Used when resetting.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">erase: </span><span class="nf">-&gt;</span> <span class="nx">@clear</span><span class="p">()</span> <span class="k">for</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@list</span> <span class="k">when</span> <span class="nx">i</span> <span class="o">isnt</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Stop and remove all sounds in the top list of the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clear: </span><span class="nf">-&gt;</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span> <span class="k">for</span> <span class="nx">sound</span> <span class="k">in</span> <span class="nx">@list</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Set global mute, and set the flag for the change to take effect.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mute: </span><span class="nf">(@muted) -&gt;</span>
    <span class="nv">serv.global.m = </span><span class="nx">@muted</span>
    <span class="vi">@volnew = </span><span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Check whether each sound has started or stopped stepping, usually due
to a change in the stack blocking. Pause or play the sound accordingly. Change
the volume on all sounds, if the global volume or mute has been changed. <br />
Do not use or block visual output, ever.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="nf">(buffer) -&gt;</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">@list</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">j</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span> <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">oldset</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">i</span><span class="p">.</span><span class="nx">newset</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">unpause</span><span class="p">()</span> <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">newset</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">i</span><span class="p">.</span><span class="nx">oldset</span>
      <span class="nv">i.oldset = </span><span class="nx">i</span><span class="p">.</span><span class="nx">newset</span>
      <span class="nv">i.newset = </span><span class="kc">no</span>
      <span class="nx">i</span><span class="p">.</span><span class="nx">fade</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@volnew</span> <span class="o">isnt</span> <span class="nx">@volume</span>
    <span class="vi">@volnew = </span><span class="nx">@volume</span>
    <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Do not use or block input, ever.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">input: </span><span class="nf">(keys) -&gt;</span> <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Gather and return audio data to be saved.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">savestate: </span><span class="nf">-&gt;</span>
    <span class="nv">ret = </span><span class="p">[</span><span class="nx">@volume</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">@list</span> <span class="k">then</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">j</span>
      <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sndmode</span> <span class="o">isnt</span> <span class="nx">i</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">pause</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">ii</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">datamode</span> <span class="o">is</span> <span class="nx">i</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">pause</span> <span class="o">and</span> <span class="nx">i</span><span class="p">.</span><span class="nx">altdatamode</span> <span class="o">is</span> <span class="nx">i</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">pause</span>
        <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">altdata</span><span class="p">.</span><span class="nx">currentTime</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">datamode</span> <span class="o">is</span> <span class="nx">i</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">pause</span> <span class="k">then</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">currentTime</span>
      <span class="k">else</span> <span class="nx">i</span><span class="p">.</span><span class="nx">altdata</span><span class="p">.</span><span class="nx">currentTime</span><span class="p">)</span>
    <span class="nx">ret</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Set all audio data properly.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">loadstate: </span><span class="nf">(state) -&gt;</span>
    <span class="vi">@volume = </span><span class="nx">state</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="vi">@volnew = </span><span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">@list</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">h</span> <span class="k">in</span> <span class="nx">j</span>
      <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sndmode</span> <span class="o">is</span> <span class="nx">i</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">stop</span> <span class="o">and</span> <span class="nx">state</span><span class="p">[</span><span class="nx">k</span><span class="p">][</span><span class="nx">h</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="nv">i.data.currentTime = </span><span class="nx">state</span><span class="p">[</span><span class="nx">k</span><span class="p">][</span><span class="nx">h</span><span class="p">]</span> <span class="k">if</span> <span class="nx">state</span><span class="p">[</span><span class="nx">k</span><span class="p">][</span><span class="nx">h</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">i</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span>
        <span class="nx">i</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sndmode</span> <span class="o">isnt</span> <span class="nx">i</span><span class="p">.</span><span class="nx">mode</span><span class="p">.</span><span class="nx">stop</span> <span class="o">and</span> <span class="nx">state</span><span class="p">[</span><span class="nx">k</span><span class="p">][</span><span class="nx">h</span><span class="p">]</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">i</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
    <span class="kc">no</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 