<!DOCTYPE html>  <html> <head>   <title>cutscene.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="icon" type="image/x-icon" href="http://spinnychair.co.cc/img/favicon.ico">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="aiscripts.html">                 aiscripts.coffee               </a>                                           <a class="source" href="audio.html">                 audio.coffee               </a>                                           <a class="source" href="cutscene.html">                 cutscene.coffee               </a>                                           <a class="source" href="engine.html">                 engine.coffee               </a>                                           <a class="source" href="format.html">                 format.coffee               </a>                                           <a class="source" href="load.html">                 load.coffee               </a>                                           <a class="source" href="pause.html">                 pause.coffee               </a>                                           <a class="source" href="save.html">                 save.coffee               </a>                                           <a class="source" href="scene.html">                 scene.coffee               </a>                                           <a class="source" href="scenenode.html">                 scenenode.coffee               </a>                                           <a class="source" href="sound.html">                 sound.coffee               </a>                                           <a class="source" href="sprite.html">                 sprite.coffee               </a>                                           <a class="source" href="surface.html">                 surface.coffee               </a>                                           <a class="source" href="sysinf.html">                 sysinf.coffee               </a>                                           <a class="source" href="tile.html">                 tile.coffee               </a>                                           <a class="source" href="unit.html">                 unit.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <a id="ribbon" href="https://github.com/DarthFennec"><img src="http://spinnychair.co.cc/img/forkme.png" /></a>             <h1>               cutscene.coffee             </h1>           </th>           <th class="code">             <h1>               <a id="title" href="http://spinnychair.co.cc">Spinny Chair</a>             </h1>           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>The cutscene/dialogue/etc system.</strong></p>

<p>This class is built to handle various kinds of cutscenes and cutscene-like
scenes: particularly, this class works with sequential scenes. Cinematic
cutscenes, dialogues, graphics effects, etc, are handled by this class.</p>

<p>A cutscene is simply a list of objects, where each object represents a
major change in the scene. The scene starts empty, and the first object
in the list is applied. This frame object might contain various data about
what the scene should look like: a new sound to play, new dialogue to display,
or new elements to put in the scene. It might also contain a length (the number
of frames to wait until the next frame object is applied, or 0 to wait for the
action key to be pressed instead), and a <em>next</em> value (the array index of
the next frame object to be applied, or -1 to end the cutscene, or a function
that returns said value).</p>

<p>Only the changes specified in a frame object will be applied; the rest of
the scene will remain the same (except in the case of the <em>next</em> value,
which will apply the succeeding frame if left unspecified). To remove
something from the cutscene, -1 should be applied.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">cutscenehandler</span>
  <span class="nv">constructor: </span><span class="nf">(@charsheet, @background, @chars, @chararea, @charpos, @nexttxtsnd, @lasttxtsnd) -&gt;</span>
    <span class="vi">@text = </span><span class="k">new</span> <span class="nx">surface</span> <span class="nx">@background</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span>
    <span class="vi">@frames = </span><span class="mi">0</span>
    <span class="vi">@choice = </span><span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Set up a new cutscene, default the current frame, and run it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">initialize: </span><span class="nf">(newscene) -&gt;</span>
    <span class="vi">@frames = </span><span class="nx">newscene</span>
    <span class="vi">@frame = </span><span class="p">{</span><span class="nv">len: </span><span class="mi">0</span><span class="p">,</span> <span class="nv">elem: </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">txt: </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">overlay: </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">snd: </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">next: </span><span class="mi">0</span><span class="p">}</span>
    <span class="vi">@time = </span><span class="mi">0</span>
    <span class="nx">@next</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Check through every element of the frame, and render it to the screen.
If the frame duration has been reached, apply the next frame.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="nf">(buffer) -&gt;</span>
    <span class="nx">@nexttxtsnd</span><span class="p">.</span><span class="nx">step</span><span class="p">()</span>
    <span class="nx">@lasttxtsnd</span><span class="p">.</span><span class="nx">step</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@frames</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">@time</span> <span class="o">&gt;</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">@next</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">snd</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">snd</span><span class="p">.</span><span class="nx">step</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@text</span><span class="p">,</span> <span class="nx">@charpos</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@text</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">@charpos</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@text</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">overlay</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">render</span> <span class="nx">buffer</span> <span class="k">then</span> <span class="vi">@frame.overlay = </span><span class="o">-</span><span class="mi">1</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">elem</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">elem</span> <span class="k">then</span> <span class="nx">p</span><span class="p">.</span><span class="nx">render</span> <span class="nx">buffer</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">elem</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">or</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">overlay</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nv">buffer.ctx.globalAlpha = </span><span class="mf">1.0</span>
      <span class="nx">@time</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@frame</span><span class="p">.</span><span class="nx">elem</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span> <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>If waiting for the action key, and it gets pressed, apply the next frame.
If displaying a choice box and an arrow key gets pressed, change the
current choice and prerender the new box.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">input: </span><span class="nf">(keys) -&gt;</span>
    <span class="k">if</span> <span class="nx">@frames</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">len</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">act</span><span class="p">.</span><span class="nx">poll</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">@next</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">act</span><span class="p">.</span><span class="nx">poll</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@choice</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">@choice</span> <span class="o">+=</span> <span class="p">(</span><span class="k">if</span> <span class="nx">@choice</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">then</span> <span class="mi">2</span> <span class="k">else</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">up</span><span class="p">.</span><span class="nx">poll</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">down</span><span class="p">.</span><span class="nx">poll</span> <span class="o">is</span> <span class="mi">1</span>
        <span class="nx">@choice</span> <span class="o">+=</span> <span class="p">(</span><span class="k">if</span> <span class="nx">@choice</span><span class="o">%</span><span class="mi">2</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">left</span><span class="p">.</span><span class="nx">poll</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">right</span><span class="p">.</span><span class="nx">poll</span> <span class="o">is</span> <span class="mi">1</span>
        <span class="nx">@drawchoice</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span>
      <span class="kc">yes</span>
    <span class="k">else</span> <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Advance to the next frame. Decide which frame to use, make the appropriate
changes from the current frame, restart the clock, tell any sounds to play,
and tell any textboxes to prerender themselves.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">next: </span><span class="o">-&gt;</span>
    <span class="nv">nxt = </span><span class="nx">@frame</span><span class="p">.</span><span class="nx">next</span>
    <span class="nv">nxt = </span><span class="nx">nxt</span> <span class="nx">@choice</span> <span class="k">if</span> <span class="s2">&quot;function&quot;</span> <span class="o">is</span> <span class="k">typeof</span> <span class="nx">nxt</span>
    <span class="vi">@choice = </span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="nx">nxt</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span> <span class="o">isnt</span> <span class="nx">@frames</span><span class="p">[</span><span class="nx">nxt</span><span class="p">].</span><span class="nx">txt</span>
        <span class="k">if</span> <span class="nx">@frames</span><span class="p">[</span><span class="nx">nxt</span><span class="p">].</span><span class="nx">txt</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">@lasttxtsnd</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">@nexttxtsnd</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span>
      <span class="nx">@frames</span><span class="p">[</span><span class="nx">nxt</span><span class="p">].</span><span class="nx">snd</span><span class="o">?</span><span class="p">.</span><span class="nx">play</span><span class="o">?</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">snd</span> <span class="o">isnt</span> <span class="nx">@frames</span><span class="p">[</span><span class="nx">nxt</span><span class="p">].</span><span class="nx">snd</span>
      <span class="nx">@frame</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@frames</span><span class="p">[</span><span class="nx">nxt</span><span class="p">][</span><span class="nx">n</span><span class="p">]</span> <span class="k">for</span> <span class="nx">n</span> <span class="k">of</span> <span class="nx">@frames</span><span class="p">[</span><span class="nx">nxt</span><span class="p">]</span>
      <span class="nx">@frame</span><span class="p">.</span><span class="nx">next</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">next</span> <span class="o">is</span> <span class="nx">nxt</span>
      <span class="vi">@time = </span><span class="mi">0</span>
      <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;;&quot;</span>
          <span class="vi">@choice = </span><span class="mi">0</span>
          <span class="nx">@drawchoice</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span>
        <span class="k">else</span> <span class="nx">@drawtext</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span>
    <span class="k">else</span>
      <span class="nx">@lasttxtsnd</span><span class="p">.</span><span class="nx">play</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@frame</span><span class="p">.</span><span class="nx">txt</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
      <span class="vi">@frames = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Build a text string to draw, given a ';'-delimited choice string.
A choicebox is in the form <code>;t;c1;c2[;c3[;c4]]</code>, where <em>cX</em> are the choices,
and <em>t</em> is the text that comes before them. Add a marker around the current
choice, and space the choices evenly.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawchoice: </span><span class="nf">(texttodraw) -&gt;</span>
    <span class="nv">choices = </span><span class="p">(</span><span class="nx">texttodraw</span><span class="p">.</span><span class="nx">substring</span> <span class="mi">1</span><span class="p">).</span><span class="nx">split</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="mi">5</span>
    <span class="nv">finalstring = </span><span class="nx">choices</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
    <span class="nx">@choice</span> <span class="o">-=</span> <span class="mi">2</span> <span class="k">if</span> <span class="nx">choices</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">2</span> <span class="o">and</span> <span class="nx">@choice</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="nx">@choice</span> <span class="o">-=</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">choices</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">3</span> <span class="o">and</span> <span class="nx">@choice</span> <span class="o">is</span> <span class="mi">3</span>
    <span class="nx">choices</span><span class="p">[</span><span class="nx">@choice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&gt; &quot;</span> <span class="o">+</span> <span class="nx">choices</span><span class="p">[</span><span class="nx">@choice</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &lt;&quot;</span>
    <span class="k">for</span> <span class="nx">currchoice</span> <span class="k">in</span> <span class="nx">choices</span>
      <span class="nv">j = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">@chars</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="err">/2) - currchoice.length)/2</span>
      <span class="nv">currchoice = </span><span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">currchoice</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="k">for</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">j</span><span class="p">]</span>
      <span class="nx">currchoice</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="k">if</span> <span class="nx">currchoice</span><span class="p">.</span><span class="nx">length</span><span class="o">%</span><span class="mi">2</span> <span class="o">isnt</span> <span class="p">(</span><span class="nx">@chars</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="err">/2)%2</span>
      <span class="nx">finalstring</span> <span class="o">+=</span> <span class="nx">currchoice</span>
    <span class="nx">@drawtext</span> <span class="nx">finalstring</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Draw the textbox. Copy over the background, go through the string,
and copy over each character from the font sheet. '#' characters are
special characters, and are interpreted as newlines.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawtext: </span><span class="nf">(texttodraw) -&gt;</span>
    <span class="nv">currline = </span><span class="mi">0</span>
    <span class="nv">currchar = </span><span class="mi">0</span>
    <span class="nx">@text</span><span class="p">.</span><span class="nx">clear</span> <span class="kc">no</span>
    <span class="nx">@text</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@background</span>
    <span class="k">for</span> <span class="nx">chartodraw</span> <span class="k">in</span> <span class="nx">texttodraw</span> <span class="k">when</span> <span class="nx">currline</span> <span class="o">&lt;</span> <span class="nx">@chars</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">y</span>
      <span class="k">if</span> <span class="nx">chartodraw</span> <span class="o">isnt</span> <span class="s2">&quot;#&quot;</span>
        <span class="nv">sy = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="p">(</span><span class="nx">chartodraw</span><span class="p">.</span><span class="nx">charCodeAt</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">16</span>
        <span class="nv">sx = </span><span class="p">(</span><span class="nx">chartodraw</span><span class="p">.</span><span class="nx">charCodeAt</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="o">*</span><span class="nx">sy</span>
        <span class="nx">@text</span><span class="p">.</span><span class="nx">map</span> <span class="nx">@charsheet</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">@chararea</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@chararea</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">@chars</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">currchar</span><span class="p">,</span> <span class="nx">@chars</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">currline</span><span class="p">,</span> <span class="nx">@chararea</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@chararea</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span>
        <span class="nx">currchar</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="nx">currchar</span> <span class="o">&gt;=</span> <span class="nx">@chars</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nx">x</span> <span class="o">or</span> <span class="nx">chartodraw</span> <span class="o">is</span> <span class="s2">&quot;#&quot;</span>
        <span class="nv">currchar = </span><span class="mi">0</span>
        <span class="nx">currline</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><strong>A color fade overlay element.</strong></p>

<p>The simplest overlay element. Fade to or from a certain color over a given time.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">gradient</span>
  <span class="nv">constructor: </span><span class="nf">(@color, @duration, @type) -&gt;</span> <span class="vi">@time = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Come up with a fade amount, set the audio volume, and render to the screen.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="nf">(buffer) -&gt;</span>
    <span class="nv">serv.audio.volume = </span><span class="k">if</span> <span class="nx">@type</span> <span class="k">then</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">@time</span><span class="sr">/@duration else @time/</span><span class="nx">@duration</span>
    <span class="nv">newalpha = </span><span class="k">if</span> <span class="nx">@type</span> <span class="k">then</span> <span class="nx">@time</span><span class="sr">/@duration else 1 - @time/</span><span class="nx">@duration</span>
    <span class="nv">buffer.ctx.globalAlpha = </span><span class="nx">newalpha</span>
    <span class="nv">buffer.ctx.fillStyle = </span><span class="nx">@color</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">clear</span> <span class="kc">yes</span>
    <span class="nv">buffer.ctx.globalAlpha = </span><span class="mf">1.0</span>
    <span class="nv">buffer.ctx.fillStyle = </span><span class="nx">serv</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">bgcolor</span>
    <span class="nx">@time</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nx">@time</span> <span class="o">&gt;</span> <span class="nx">@duration</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><strong>An image cutscene element.</strong></p>

<p>The most common cutscene element type, this is a simple still image. It can
be controlled per-frame by a callback function, which can determine the
position, size, and alpha of the particle.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">particle</span>
  <span class="nv">constructor: </span><span class="nf">(@image, @callback) -&gt;</span> <span class="vi">@time = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Run the callback, draw the results, and increment the frame counter.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">render: </span><span class="nf">(buffer) -&gt;</span>
    <span class="nv">info = </span><span class="nx">@callback</span> <span class="nx">@time</span>
    <span class="nv">buffer.ctx.globalAlpha = </span><span class="nx">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="nv">dx = </span><span class="nx">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">@image</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">x</span><span class="o">*</span><span class="nx">info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="nv">dy = </span><span class="nx">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">@image</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span><span class="o">*</span><span class="nx">info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
    <span class="nx">buffer</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@image</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">,</span> <span class="nx">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="nx">@image</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="nx">@image</span><span class="p">.</span><span class="nx">dims</span><span class="p">.</span><span class="nx">y</span>
    <span class="vi">@time = </span><span class="nx">info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Helper function for sinusoidal fades.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fadeform: </span><span class="nf">(t, cycle) -&gt;</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span> <span class="nx">t</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="err">/cycle</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 