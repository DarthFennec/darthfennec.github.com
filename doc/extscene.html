<!DOCTYPE html>  <html> <head>   <title>extscene.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="icon" type="image/x-icon" href="http://spinnychair.net/img/favicon.ico">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="aiscripts.html">                 aiscripts.coffee               </a>                                           <a class="source" href="audio.html">                 audio.coffee               </a>                                           <a class="source" href="cutscene.html">                 cutscene.coffee               </a>                                           <a class="source" href="engine.html">                 engine.coffee               </a>                                           <a class="source" href="extscene.html">                 extscene.coffee               </a>                                           <a class="source" href="load.html">                 load.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="pause.html">                 pause.coffee               </a>                                           <a class="source" href="save.html">                 save.coffee               </a>                                           <a class="source" href="scene.html">                 scene.coffee               </a>                                           <a class="source" href="scenenode.html">                 scenenode.coffee               </a>                                           <a class="source" href="screen.html">                 screen.coffee               </a>                                           <a class="source" href="sound.html">                 sound.coffee               </a>                                           <a class="source" href="sprite.html">                 sprite.coffee               </a>                                           <a class="source" href="surface.html">                 surface.coffee               </a>                                           <a class="source" href="tile.html">                 tile.coffee               </a>                                           <a class="source" href="unit.html">                 unit.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <a id="ribbon" href="https://github.com/DarthFennec">               <img src="http://spinnychair.net/img/forkme.png" />             </a>             <h1>               extscene.coffee             </h1>           </th>           <th class="code">             <h1>               <a id="title" href="http://spinnychair.net">Spinny Chair</a>             </h1>           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>The external scene loader.</strong></p>

<p>It is generally best to import scenes and cutscenes from external files,
rather than hardcoding them directly into the engine. Provide a simple
plaintext loader for this purpose, and provide means of interpreting text
files and presenting them to the engine as scenenodes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">extscene</span>
  <span class="nv">constructor: </span><span class="nf">-&gt;</span>
    <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">filetype</span><span class="p">[</span><span class="s">&quot;txt/&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(url) -&gt;</span>
      <span class="nv">data = txt: </span><span class="s">&quot;&quot;</span>
      <span class="nv">newf = </span><span class="k">new</span> <span class="nx">XMLHttpRequest</span>
      <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">loadcount</span><span class="p">.</span><span class="nx">push</span> <span class="nx">newf</span>
      <span class="nx">newf</span><span class="p">.</span><span class="nx">open</span> <span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span>
      <span class="nv">newf.onreadystatechange = </span><span class="nf">-&gt;</span> <span class="k">if</span> <span class="nx">newf</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">is</span> <span class="mi">4</span>
        <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">err</span> <span class="nx">newf</span><span class="p">,</span> <span class="nx">url</span> <span class="k">if</span> <span class="nx">newf</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">404</span>
        <span class="k">if</span> <span class="nx">newf</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">200</span>
          <span class="nv">data.txt = </span><span class="nx">newf</span><span class="p">.</span><span class="nx">responseText</span>
          <span class="nx">serv</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">finish</span> <span class="nx">newf</span>
      <span class="nx">newf</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
      <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Interpret file contents, and return a scenenode object. Scene data is
plaintext, and formatted in json. The specific layout depends on the
kind of scenenode.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setscene: </span><span class="nf">(str, sys) -&gt;</span>
    <span class="nv">file = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">str</span>
    <span class="nv">type = </span><span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">c</span> <span class="k">then</span> <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">l</span><span class="o">?</span> <span class="o">and</span> <span class="nx">i</span><span class="p">.</span><span class="nx">t</span> <span class="o">is</span> <span class="s">&quot;t&quot;</span> <span class="k">then</span> <span class="nv">type = </span><span class="nx">i</span><span class="p">.</span><span class="nx">l</span>
    <span class="nx">sys</span> <span class="o">?=</span>
      <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;out&quot;</span> <span class="k">then</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">outscenemgr</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">is</span> <span class="s">&quot;in&quot;</span> <span class="k">then</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">inscenemgr</span>
      <span class="k">else</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">cutscenemgr</span>
    <span class="k">new</span> <span class="nx">scenenode</span> <span class="nx">file</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">f</span><span class="p">,</span> <span class="nf">-&gt;</span>
      <span class="nv">list = </span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">c</span> <span class="k">then</span> <span class="k">switch</span> <span class="nx">i</span><span class="p">.</span><span class="nx">t</span>
        <span class="k">when</span> <span class="s">&quot;t&quot;</span> <span class="k">then</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">extern</span><span class="p">.</span><span class="nx">settile</span> <span class="k">this</span><span class="p">,</span> <span class="nx">i</span>
        <span class="k">when</span> <span class="s">&quot;s&quot;</span> <span class="k">then</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">extern</span><span class="p">.</span><span class="nx">setsprite</span> <span class="k">this</span><span class="p">,</span> <span class="nx">i</span>
        <span class="k">else</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">extern</span><span class="p">.</span><span class="nx">setcutscene</span> <span class="k">this</span><span class="p">,</span> <span class="nx">i</span>
      <span class="nx">sys</span><span class="p">.</span><span class="nx">initialize</span> <span class="nx">list</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Interpret <a href="tile.html">tileset objects</a> from json.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">settile: </span><span class="nf">(_this, i) -&gt;</span>
    <span class="nx">i</span><span class="p">.</span><span class="nx">c</span> <span class="o">?=</span> <span class="s">&quot;</span><span class="err">#</span><span class="s">000000&quot;</span>
    <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">a</span><span class="o">?</span>
      <span class="nv">snd = </span><span class="nx">@file</span> <span class="nx">_this</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">a</span>
      <span class="nv">snd.loop = </span><span class="nx">i</span><span class="p">.</span><span class="nx">d</span> <span class="k">if</span> <span class="nx">i</span><span class="p">.</span><span class="nx">d</span><span class="o">?</span>
    <span class="k">else</span> <span class="nv">snd = </span><span class="mi">0</span>
    <span class="k">new</span> <span class="nx">tileset</span> <span class="p">(</span><span class="k">new</span> <span class="nx">vect</span> <span class="nx">i</span><span class="p">.</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span><span class="p">.</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="nx">@file</span> <span class="nx">_this</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">i</span><span class="p">),</span> <span class="nx">snd</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">m</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Interpret <a href="sprite.html">sprite objects</a> from json.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setsprite: </span><span class="nf">(_this, i) -&gt;</span>
    <span class="nv">ps = aiscripts: </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">of</span> <span class="nx">i</span> <span class="k">then</span> <span class="k">switch</span> <span class="nx">p</span>
      <span class="k">when</span> <span class="s">&quot;vector&quot;</span> <span class="k">then</span> <span class="nv">ps.vector = </span><span class="p">(</span><span class="k">new</span> <span class="nx">angle</span> <span class="s">&quot;spr&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">vector</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&quot;sheet&quot;</span> <span class="k">then</span> <span class="nv">ps.sheet = </span><span class="nx">@file</span> <span class="nx">_this</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">sheet</span>
      <span class="k">when</span> <span class="s">&quot;area&quot;</span><span class="p">,</span> <span class="s">&quot;carea&quot;</span>
        <span class="nx">ps</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">rect</span> <span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;ai-&quot;</span>
          <span class="nx">ps</span><span class="p">.</span><span class="nx">aiscripts</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nx">serv</span><span class="p">.</span><span class="nx">getai</span><span class="p">[</span><span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="p">(</span><span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">slice</span> <span class="mi">1</span><span class="p">)...</span>
        <span class="k">else</span> <span class="nx">ps</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
    <span class="k">new</span> <span class="nx">sprite</span> <span class="nx">ps</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Interpret <a href="cutscene.html">cutscene frame objects</a> from json.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setcutscene: </span><span class="nf">(_this, i) -&gt;</span>
    <span class="nv">ps = </span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">of</span> <span class="nx">i</span>
      <span class="k">if</span> <span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">ps</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">else</span> <span class="k">switch</span> <span class="nx">p</span>
        <span class="k">when</span> <span class="s">&quot;snd&quot;</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">i</span><span class="p">.</span><span class="nx">snd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s">&quot;number&quot;</span> <span class="k">then</span> <span class="nv">ps.snd = </span><span class="nx">@file</span> <span class="nx">_this</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">snd</span>
          <span class="k">else</span>
            <span class="nv">ps.snd = </span><span class="nx">@file</span> <span class="nx">_this</span><span class="p">,</span> <span class="nx">i</span><span class="p">.</span><span class="nx">snd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nv">ps.snd.loop = </span><span class="nx">i</span><span class="p">.</span><span class="nx">snd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">when</span> <span class="s">&quot;next&quot;</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">i</span><span class="p">.</span><span class="nx">next</span> <span class="o">is</span> <span class="s">&quot;number&quot;</span> <span class="k">then</span> <span class="nv">ps.next = </span><span class="nx">i</span><span class="p">.</span><span class="nx">next</span>
          <span class="k">else</span> <span class="nv">ps.next = </span><span class="nx">@setfunction</span> <span class="nx">i</span><span class="p">.</span><span class="nx">next</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="nx">_this</span>
        <span class="k">when</span> <span class="s">&quot;elem&quot;</span> <span class="k">then</span> <span class="nv">ps.elem = </span><span class="k">for</span> <span class="nx">q</span> <span class="k">in</span> <span class="nx">i</span><span class="p">.</span><span class="nx">elem</span>
          <span class="k">new</span> <span class="nx">particle</span> <span class="p">(</span><span class="nx">@file</span> <span class="nx">_this</span><span class="p">,</span> <span class="nx">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">@setfunction</span> <span class="nx">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="nx">_this</span>
        <span class="k">when</span> <span class="s">&quot;overlay&quot;</span>
          <span class="nv">ps.overlay = </span><span class="k">new</span> <span class="nx">gradient</span> <span class="nx">i</span><span class="p">.</span><span class="nx">overlay</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span><span class="p">.</span><span class="nx">overlay</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">i</span><span class="p">.</span><span class="nx">overlay</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span> <span class="nx">ps</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
    <span class="nx">ps</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Interpret functions from json. There is no reason to avoid eval in this
case, as all text being evaluated is loaded from the server. Also, it
would be extremely difficult to implement something like this without eval.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setfunction: </span><span class="nf">(_func, _arg, _this) -&gt;</span>
    <span class="nv">_func = </span><span class="p">(</span><span class="nx">_func</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\bthis\b/gm</span><span class="p">).</span><span class="nx">join</span> <span class="s">&quot;_this&quot;</span>
    <span class="nv">_f = </span><span class="p">(</span><span class="nx">_func</span><span class="p">.</span><span class="nx">split</span> <span class="s">&quot;;&quot;</span><span class="p">).</span><span class="nx">filter</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="s">&quot;&quot;</span>
    <span class="nx">_f</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;return (&quot;</span> <span class="o">+</span> <span class="nx">_f</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span>
    <span class="nb">eval</span> <span class="s">&quot;(function (&quot;</span> <span class="o">+</span> <span class="nx">_arg</span> <span class="o">+</span> <span class="s">&quot;){&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">_f</span><span class="p">.</span><span class="nx">join</span> <span class="s">&quot;;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;;})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Help with file selection given nested/ranged files.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">file: </span><span class="nf">(_this, f) -&gt;</span>
    <span class="nv">rtn = </span><span class="nx">_this</span><span class="p">.</span><span class="nx">file</span>
    <span class="nv">rtn = </span><span class="nx">rtn</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">f</span>
    <span class="nx">rtn</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 