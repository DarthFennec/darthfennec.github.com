(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B=[].slice,C={}.hasOwnProperty,D=function(a,b){function d(){this.constructor=a}for(var c in b)C.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=function(){function a(){}return a.prototype.watch=function(a){return function(b){var c;c=Math.pow(this.area.p.x-b[0].area.p.x,2)+Math.pow(this.area.p.y-b[0].area.p.y,2);if(c<a*a)return this.vector.set("pts",this.area.p,b[0].area.p)}},a.prototype.random=function(a){return function(b){if(Math.random()>a)return this.mode=Math.floor(Math.random()*3),this.vector.set("spr",-3+Math.floor(Math.random()*8))}},a.prototype.follow=function(a,b,c){var d,e,f;return d=0,f=0,e=new A(-1,-1),function(g){var h,i,j,k,l,m,n,o,p,q=this;m=g[g.length-1],k=new A(Math.abs(this.area.p.x-g[0].area.p.x),Math.abs(this.area.p.y-g[0].area.p.y)),d===0&&(d=new Graph(m.grid.map(function(a){return a.map(function(a){return a<0?1:0})}))),l=k.x>k.y?k.x:k.y,n=(new A).l(function(a){return 1+Math.floor(q.area.p.i(a)/m.tilesize.i(a))}),h=(new A).l(function(a){return 1+Math.floor(g[0].area.p.i(a)/m.tilesize.i(a))});if(e.x!==h.x||e.y!==h.y)e=new A(h.x,h.y),f=astar.search(d.nodes,d.nodes[n.x][n.y],d.nodes[h.x][h.y]),f=f.filter(function(a,b,c){return c[b-1]!=null&&c[b+1]!=null?c[b-1].x===c[b+1].x||c[b-1].y===c[b+1].y:!0});if(l<=a){j=0,i=0,o=g[0].vector.get("kbd");if(k.x<k.y){if(o.y!==0){if(o.x!==0)this.vector.set("kbd",new A(-o.x,0));else{while(d.input[h.x+j][h.y]!==1)j+=1;while(d.input[h.x-i][h.y]!==1)i+=1;this.vector.set("kbd",new A(j>i?1:-1,0))}this.mode=2}}else if(o.x!==0){if(o.y!==0)this.vector.set("kbd",new A(0,-o.y));else{while(d.input[h.x][h.y+j]!==1)j+=1;while(d.input[h.x][h.y-i]!==1)i+=1;this.vector.set("kbd",new A(0,j>i?1:-1))}this.mode=2}}a<l&&l<=b&&(this.vector.set("pts",this.area.p,g[0].area.p),this.mode=0);if(b<l&&f.length>0)return p=new A,f[0].x===n.x&&f[0].y===n.y&&f.shift(),p.x=f[0].x>n.x?1:f[0].x<n.x?-1:0,p.y=f[0].y>n.y?1:f[0].y<n.y?-1:0,p.x===0&&this.area.p.x+2*this.area.s.x>m.tilesize.x*(n.x+1)&&d.input[n.x+1][n.y+p.y]===1&&(p.x=-1),p.y===0&&this.area.p.y+2*this.area.s.y>m.tilesize.y*(n.y+1)&&d.input[n.x+p.x][n.y+1]===1&&(p.y=-1),this.vector.set("kbd",p),this.mode=c<l?2:1}},a}(),c=function(){function a(a){var b=this;a[a.length-1]==="0"?this.data=-1:(this.ii=0,this.paused=!1,this.oldset=!1,this.newset=!1,this.mode={stop:0,play:1,pause:2},this.datamode=this.mode.stop,this.data=new Audio,this.data.src=a,this.data.addEventListener("ended",function(){return b.datamode=b.mode.stop}),this.altdatamode=this.mode.stop,this.altdata=new Audio,this.altdata.src=a,this.altdata.addEventListener("ended",function(){return b.altdatamode=b.mode.stop}))}return a.prototype.init=function(a,b){return this.loop=b,this.fade(a),this},a.prototype.play=function(a){var b=this;if(this.data!==-1){this.loop!=null&&a==null&&(this.ii=window.setInterval(function(){return b.play(0)},1e3*this.loop));if(this.datamode===this.mode.stop)return this.datamode=this.mode.play,this.data.play();if(this.altdatamode===this.mode.stop)return this.altdatamode=this.mode.play,this.altdata.play()}},a.prototype.stop=function(){if(this.data!==-1){this.datamode!==this.mode.stop&&(this.datamode=this.mode.stop,this.data.pause(),this.data.currentTime=0);if(this.altdatamode!==this.mode.stop)return this.altdatamode=this.mode.stop,this.altdata.pause(),this.altdata.currentTime=0}},a.prototype.pause=function(){if(this.data!==-1&&!this.paused)return this.ii!==0?this.fade(0):(this.datamode===this.mode.play&&(this.datamode=this.mode.pause,this.data.pause()),this.altdatamode===this.mode.play&&(this.altdatamode=this.mode.pause,this.altdata.pause())),this.paused=!0},a.prototype.unpause=function(a){if(this.data!==-1&&this.paused)return this.ii!==0?this.fade(a):(this.datamode===this.mode.pause&&(this.datamode=this.mode.play,this.data.play()),this.altdatamode===this.mode.pause&&(this.altdatamode=this.mode.play,this.altdata.play())),this.paused=!1},a.prototype.fade=function(a){if(this.data!==-1)return t.audio.muted&&(a=0),this.data.volume=a,this.altdata.volume=a},a.prototype.step=function(){return this.newset=!0},a}(),d=function(){function a(a,b,c,d,e,f,g){this.charsheet=a,this.background=b,this.chars=c,this.chararea=d,this.charpos=e,this.nexttxtsnd=f,this.lasttxtsnd=g,this.text=new w(this.background.size()),this.frames=0,this.choice=-1}return a.prototype.initialize=function(a){return this.frames=a,this.frame={len:0,elem:-1,txt:-1,overlay:-1,snd:-1,next:0},this.time=0,this.next()},a.prototype.render=function(a){var b,c,d,e,f;this.nexttxtsnd.step(),this.lasttxtsnd.step();if(this.frames!==0){this.time>(e=this.frame.len)&&e>0&&this.next(),this.frame.snd!==-1&&this.frame.snd.step(),this.frame.txt!==-1&&a.drawImage(this.text,this.charpos.x+(a.dims.x-this.text.dims.x)/2,this.charpos.y+(a.dims.y-this.text.dims.y)/2),this.frame.overlay!==-1&&this.frame.overlay.render(a)&&(this.frame.overlay=-1);if(this.frame.elem!==-1){f=this.frame.elem;for(c=0,d=f.length;c<d;c++)b=f[c],b.render(a)}if(this.frame.elem!==-1||this.frame.overlay!==-1)a.ctx.globalAlpha=1;return this.frame.len>0&&(this.time+=1),this.frame.elem!==-1}return!1},a.prototype.input=function(a){if(this.frames!==0){this.frame.len===0&&a.act.poll===1&&this.next();if(a.act.poll!==1&&this.choice!==-1){if(a.up.poll===1||a.down.poll===1)this.choice+=this.choice<2?2:-2;if(a.left.poll===1||a.right.poll===1)this.choice+=this.choice%2===0?1:-1;this.drawchoice(this.frame.txt)}return!0}return!1},a.prototype.next=function(){var a,b,c;b=this.frame.next,"function"==typeof b&&(b=b(this.choice)),this.choice=-1;if(b===-1)return this.frame.txt!==-1&&this.lasttxtsnd.play(),this.frames=0;this.frame.txt!==this.frames[b].txt&&(this.frames[b].txt===-1?this.lasttxtsnd.play():this.frame.txt!==-1&&this.nexttxtsnd.play()),this.frame.snd!==this.frames[b].snd&&(c=this.frames[b].snd)!=null&&typeof c.play=="function"&&c.play();for(a in this.frames[b])this.frame[a]=this.frames[b][a];this.frame.next===b&&(this.frame.next+=1),this.time=0;if(this.frame.txt!==-1)return this.frame.txt[0]===";"?(this.choice=0,this.drawchoice(this.frame.txt)):this.drawtext(this.frame.txt)},a.prototype.drawchoice=function(a){var b,c,d,e,f,g,h;b=a.substring(1).split(";",5),d=b.shift(),b.length===2&&this.choice>1&&(this.choice-=2),b.length===3&&this.choice===3&&(this.choice-=1),b[this.choice]="> "+b[this.choice]+" <";for(f=0,h=b.length;f<h;f++){c=b[f],e=Math.floor((Math.floor(this.chars.s.x/2)-c.length)/2);for(g=1;1>e?g>=e:g<=e;1>e?g--:g++)c=" "+c+" ";c.length%2!==this.chars.s.x/2%2&&(c+=" "),d+=c}return this.drawtext(d)},a.prototype.drawtext=function(a){var b,c,d,e,f,g,h,i;d=0,c=0,this.text.clear(!1),this.text.drawImage(this.background),i=[];for(g=0,h=a.length;g<h;g++){b=a[g];if(d>=this.chars.s.y)continue;b!=="#"&&(f=Math.floor(b.charCodeAt(0)/16),e=b.charCodeAt(0)-16*f,this.text.map(this.charsheet,e,f,this.chararea.s.x,this.chararea.s.y,this.chars.p.x+c,this.chars.p.y+d,this.chararea.p.x,this.chararea.p.y),c+=1),c<this.chars.s.x&&b!=="#"?i.push(void 0):(c=0,i.push(d+=1))}return i},a}(),g=function(){function a(a,b,c){this.color=a,this.duration=b,this.type=c,this.time=0}return a.prototype.render=function(a){var b;return t.audio.volume=this.type?1-this.time/this.duration:this.time/this.duration,b=this.type?this.time/this.duration:1-this.time/this.duration,a.ctx.globalAlpha=b,a.ctx.fillStyle=this.color,a.clear(!0),a.ctx.globalAlpha=1,a.ctx.fillStyle=t.engine.bgcolor,this.time+=1,this.time>this.duration},a}(),m=function(){function a(a,b){this.image=a,this.callback=b,this.time=0}return a.prototype.render=function(a){var b,c,d;return d=this.callback(this.time),a.ctx.globalAlpha=d[3],b=d[0]+(a.dims.x-this.image.dims.x*d[2])/2,c=d[1]+(a.dims.y-this.image.dims.y*d[2])/2,a.drawImage(this.image,b,c,d[2]*this.image.dims.x,d[2]*this.image.dims.y),this.time=d[4]},a.prototype.fadeform=function(a,b){return.5+.5*Math.cos(a*Math.PI/b)},a}(),e=function(){function a(a,b,c,d){var e;this.rends=a,this.screen=c,this.keys={};for(e in d)this.keys[e]={val:d[e],poll:0,state:0};this.bgcolor="#000000",this.buffer=new w(new A(0,0)),this.resize(this.screen.size()),b.n.buildtree(b.c,0,0),b.n.initialize(),t.reset(!0)}return a.prototype.resize=function(a){var b;b=this.buffer.size();if(a.x!==b.x||a.y!==b.y)return this.screen.size(a),this.buffer.size(a),this.buffer.ctx.fillStyle=this.bgcolor,this.buffer.ctx.strokeStyle="#ffffff",this.buffer.ctx.lineWidth=25,this.buffer.ctx.lineCap="round",this.buffer.ctx.globalCompositeOperation="destination-over"},a.prototype.fullscreen=function(a){return this.screen.buf.className=a?"fullscreen":""},a.prototype.input=function(a,b,c){var d,e,f,g,h,i,j,k,l,m;d=!1;for(e in this.keys){this.keys[e].poll=0,l=this.keys[e].val;for(h=0,j=l.length;h<j;h++){f=l[h];if(b!==f)continue;d=!0,this.keys[e].poll=c}this.keys[e].poll===1&&(this.keys[e].state=1),this.keys[e].poll===-1&&(this.keys[e].state=0)}if(d){m=this.rends;for(i=0,k=m.length;i<k;i++){g=m[i];if(g.input(this.keys))break}a()}return!1},a.prototype.step=function(){var a,b,c,d;this.screen.drawImage(this.buffer),this.buffer.clear(!1),d=this.rends;for(b=0,c=d.length;b<c;b++){a=d[b];if(a.render(this.buffer))break}return this.buffer.clear(!0),!1},a}(),f=function(){function a(){this.callbacks=[],this.filetype=[],this.filetype.push({head:"img/",call:function(a){var b;return b=new w(new Image),t.load.loadcount.push(b),b.buf.onerror=function(){return t.formats.err(b,a+".png")},b.buf.onload=function(){return b.dims.x=b.buf.width,b.dims.y=b.buf.height,t.formats.finish(b)},b.buf.src=a+".png",b}})}return a.prototype.load=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;l=a.substr(0,4),g=a.indexOf("["),d=a.indexOf("-",g),b=a.indexOf("]",d);if(g!==-1&&d!==-1&&b!==-1)j=a.substring(0,g),h=parseInt(a.substring(1+g,d),10),c=parseInt(a.substring(1+d,b),10),i=a.substring(1+b),k=function(){var a,b;b=[];for(e=a=h;h>c?a>=c:a<=c;e=h>c?--a:++a)b.push(this.load(j+e+i));return b}.call(this);else{o=this.filetype;for(m=0,n=o.length;m<n;m++)f=o[m],f.head===l&&(k=f.call(a))}return k},a.prototype.err=function(a,b){return window.alert("Error: failed to load "+b.substring(1+b.lastIndexOf("/"))),this.finish(a)},a.prototype.finish=function(a){var b,c,d,e,f,g;c=t.load.loadcount.indexOf(a),c!==-1&&t.load.loadcount.splice(c,1);if(t.load.loadcount.length===0){d=this.callbacks,this.callbacks=[],g=[];for(e=0,f=d.length;e<f;e++)b=d[e],g.push(b());return g}},a}(),l=function(){function a(){this.loadcount=[],this.maxload=0}return a.prototype.render=function(a){var b;return this.loadcount.length!==0?(this.maxload<this.loadcount.length&&(this.maxload=this.loadcount.length),b=(this.maxload-this.loadcount.length)*(a.dims.x-60)/this.maxload,a.ctx.beginPath(),a.ctx.moveTo(30,a.dims.y-30),a.ctx.lineTo(b+30,a.dims.y-30),a.ctx.stroke()):this.maxload=0,this.loadcount.length!==0},a.prototype.input=function(a){return this.loadcount.length!==0},a}(),n=function(){function a(a,b,c,d,e,f){this.underlay=a,this.display=b,this.menu=c,this.obj=d,this.pausesnd=e,this.unpausesnd=f,this.pressed=0}return a.prototype.render=function(a){var b,c,d,e,f;this.pausesnd.step(),this.unpausesnd.step(),this.pressed>0&&(this.pressed===2&&this.unpausesnd.play(),this.obj.frames=0);if(this.pressed<0){this.display.size(this.underlay.size()),this.display.drawImage(this.underlay),this.pausesnd.play(),f=this.menu;for(d=0,e=f.length;d<e;d++){b=f[d];for(c in b)b[c].time!=null&&(b[c].time=0)}this.obj.initialize(this.menu)}return this.pressed=0,this.obj.render(a)},a.prototype.input=function(a){var b,c,d;return b=this.obj.frames===0?-1:1,d=this.obj.input(a),c=this.obj.frames===0?-1:1,this.pressed=a.pause.poll===1||b===1&&c===-1?b:0,a.pause.poll===1&&b===1&&(this.pressed=2),a.pause.poll===1&&this.obj.frame!=null&&this.obj.frame.overlay!==-1&&(this.pressed=0),d},a}(),q=function(){function a(a){this.cansaveload=a}return a.prototype.validate=function(){return localStorage.savestate!=null},a.prototype.savestate=function(a){var b,c;return b={},b.stack=t.scene.savestate(t.state),b.stack.shift(),b.local=function(){var a,b,d,e;d=t.engine.rends,e=[];for(a=0,b=d.length;a<b;a++)c=d[a],c.savestate!=null&&e.push(c.savestate());return e}(),localStorage.savestate=JSON.stringify(b),a},a.prototype.loadstate=function(a){var b;return t.reset(!1),b=JSON.parse(localStorage.savestate),t.scene.loadstate(b.stack),t.formats.callbacks.push(function(){var a,c,d,e,f;e=t.engine.rends,f=[];for(c=0,d=e.length;c<d;c++)a=e[c],a.loadstate!=null&&f.push(a.loadstate(b.local.shift()));return f}),a},a}(),r=function(){function a(){this.currscene=0}return a.prototype.initialize=function(a){this.currscene=a},a.prototype.render=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n=this;if(this.currscene!==0){k=this.currscene;for(e=0,h=k.length;e<h;e++){d=k[e];if(!!d.passive)continue;l=this.currscene;for(f=0,i=l.length;f<i;f++)c=l[f],d!==c&&c.docollide(d);d.aiscript!==0&&d.aiscript(this.currscene)}b=(new A).l(function(b){return n.currscene[0].area.p.i(b)+(n.currscene[0].area.s.i(b)-a.dims.i(b))/2}),m=this.currscene;for(g=0,j=m.length;g<j;g++)d=m[g],d.step(a,b);return!0}return!1},a.prototype.input=function(a){var b,c,d,e;if(this.currscene!==0){a.right.state===a.left.state&&a.down.state===a.up.state?this.currscene[0].mode=0:(this.currscene[0].mode=a.run.state===1?2:1,this.currscene[0].vector.set("kbd",new A(a.right.state-a.left.state,a.down.state-a.up.state)));if(a.act.poll===1){e=this.currscene;for(c=0,d=e.length;c<d;c++)b=e[c],b.interact&&b.dointeract(this.currscene[0])}return!0}return!1},a.prototype.savestate=function(){var a,b,c,d,e;if(this.currscene!==0){d=this.currscene,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.savestate());return e}},a.prototype.loadstate=function(a){var b,c,d,e,f,g;if(this.currscene!==0){f=this.currscene,g=[];for(b=d=0,e=f.length;d<e;b=++d)c=f[b],g.push(c.loadstate(a[b]));return g}},a}(),s=function(){function a(a,b,c){this.filelist=a,this.init=b,this.callback=c,this.canreeval=!0}return a.prototype.buildtree=function(a,b,c){var d,e,f,g;this.parent=b,this.idx=c,this.child=[],g=[];for(c=e=0,f=a.length;e<f;c=++e)d=a[c],this.child[c]=d.n,g.push(d.n.buildtree(d.c,this,c));return g},a.prototype.initialize=function(){var a,b=this;if(this.canreeval)return this.file=[],t.audio.push(),t.state=this,this.filelist.length===0?t.formats.callbacks.length===0?this.init():t.formats.callbacks.push(function(){return b.init()}):(t.formats.callbacks.push(function(){return b.init()}),this.file=function(){var b,c,d,e;d=this.filelist,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(t.formats.load(a));return e}.call(this))},a.prototype.exitscene=function(a){var b;return t.audio.clear(),t.state=this.parent,typeof (b=this.parent).callback=="function"&&b.callback(this.idx),a},a.prototype.savestate=function(a){var b,c,d,e,f,g;d=0;if(a===this)d=[this.idx];else{g=this.child;for(e=0,f=g.length;e<f;e++){b=g[e];if(!((c=b.savestate(a))instanceof Array))continue;d=c,d.unshift(this.idx)}}return d},a.prototype.loadstate=function(a){var b;this.initialize();if(a.length>0)return b=a.shift(),this.child[b].loadstate(a)},a}(),u=function(){function a(a){this.soundext=a,this.volume=1,this.volnew=-1,this.maxvolume=!1,this.muted=0,this.list=[],t.formats.filetype.push({head:"snd/",call:function(a){var b;return b=t.audio.add(a+t.audio.soundext),t.audio.soundext!==0&&(t.load.loadcount.push(b),b.data.addEventListener("error",function(){return b.data=-1,t.formats.err(b,a+t.audio.soundext)}),b.data.addEventListener("canplaythrough",function(){return t.formats.finish(b)})),b}})}return a.prototype.add=function(a){var b;return b=new c(a),this.list[0].push(b),b},a.prototype.push=function(){return this.list.unshift([])},a.prototype.erase=function(){var a,b,c,d,e,f;e=this.list,f=[];for(a=c=0,d=e.length;c<d;a=++c)b=e[a],a!==0&&f.push(this.clear());return f},a.prototype.clear=function(){var a,b,c,d,e;d=this.list.shift(),e=[];for(b=0,c=d.length;b<c;b++)a=d[b],a.ii!==0&&window.clearInterval(a.ii),e.push(a.stop());return e},a.prototype.mute=function(a){if(this.muted!==a)return this.muted=a,this.maxvolume=!0,this.volnew=-1},a.prototype.render=function(a){var b,c,d,e,f,g,h;this.volume<0&&(this.volume=0),this.volume>1&&(this.volume=1),h=this.list;for(d=0,f=h.length;d<f;d++){c=h[d];for(e=0,g=c.length;e<g;e++)b=c[e],b.oldset&&!b.newset&&b.pause(),b.newset&&!b.oldset&&b.unpause(this.volume),b.oldset=b.newset,b.newset=!1,this.volnew!==this.volume&&!b.paused&&b.fade(this.volume)}return this.maxvolume?(this.volume=1,this.maxvolume=!1):this.volnew=this.volume,!1},a.prototype.input=function(a){return!1},a}(),v=function(){function a(a){var c,d,e,f;c={sheet:0,area:new p(0,0,0,0),callback:0,aiscript:0,len:[],speed:[],collide:!1,trigger:!1,interact:!1,passive:!1,vector:new b("spr",0),mode:0,frame:0};for(d in c)this[d]=(f=a[d])!=null?f:c[d];this.sheet!==0&&(e=this.sheet,this.sheet=new w(new A(8*this.area.s.x,e.dims.y)),this.sheet.ctx.scale(-1,1),this.sheet.drawImage(e,this.area.s.x,0,-3*this.area.s.x,0,3*this.area.s.x,e.dims.y),this.sheet.ctx.scale(-1,1),this.sheet.drawImage(e,0,0,3*this.area.s.x,0,5*this.area.s.x,e.dims.y))}return a.prototype.step=function(a,b){var c=this;if(this.sheet!==0){if(this.frame<this.len[this.mode]||this.frame>=this.len[1+this.mode])this.frame=this.len[this.mode];return a.map(this.sheet,3+this.vector.get("spr"),Math.floor(this.frame),this.area.s.x,this.area.s.y,this.area.p.x-b.x,this.area.p.y-b.y,1,1),this.area.p.l(function(a){return c.area.p.i(a)+c.speed[c.mode]*c.vector.get("vlc").i(a)}),this.frame+=.3}},a.prototype.docollide=function(a){var b,c,d,e,f,g;b=a.area.p.x+a.area.s.x-this.area.p.x,c=a.area.p.y+a.area.s.y-this.area.p.y,d=this.area.p.x+this.area.s.x-a.area.p.x,e=this.area.p.y+this.area.s.y-a.area.p.y,g=1,f=b;if(b>0&&c>0&&d>0&&e>0){this.collide&&(f>c&&(f=c,g=2),f>d&&(f=d,g=3),f>e&&(f=e,g=4),g===1&&(a.area.p.x-=f),g===2&&(a.area.p.y-=f),g===3&&(a.area.p.x+=f),g===4&&(a.area.p.y+=f));if(this.trigger)return a.mode=0,this.callback(this,a)}},a.prototype.dointeract=function(a){var b,c,d,e=this;d=new p(a.area.p.x,a.area.p.y,a.area.s.x,a.area.s.y),d.p.l(function(b){return d.p.i(b)+a.vector.get("kbd").i(b)*d.s.i(b)/2}),b=(new A).l(function(a){return d.p.i(a)+d.s.i(a)-e.area.p.i(a)}),c=(new A).l(function(a){return e.area.p.i(a)+e.area.s.i(a)-d.p.i(a)});if(b.x>0&&b.y>0&&c.x>0&&c.y>0)return a.mode=0,this.callback(this,a)},a.prototype.savestate=function(){return{px:this.area.p.x,py:this.area.p.y,md:this.mode,fr:this.frame,vx:this.vector.get("spr")}},a.prototype.loadstate=function(a){return this.area.p.x=a.px,this.area.p.y=a.py,this.mode=a.md,this.frame=a.fr,this.vector.set("spr",a.vx)},a}(),w=function(){function a(a){var b;a instanceof HTMLImageElement||a instanceof HTMLCanvasElement?(this.buf=a,this.dims=new A(a.width,a.height)):(this.buf=document.createElement("canvas"),this.size(a)),this.ctx=typeof (b=this.buf).getContext=="function"?b.getContext("2d"):void 0}return a.prototype.size=function(a){return a!=null&&(this.dims=a,this.buf.width=a.x,this.buf.height=a.y),this.dims},a.prototype.clear=function(a){return a?this.ctx.fillRect(0,0,this.dims.x,this.dims.y):this.ctx.clearRect(0,0,this.dims.x,this.dims.y)},a.prototype.drawImage=function(){var a,b,c,d,e,f;c=arguments[0],a=2>arguments.length?[]:B.call(arguments,1);for(b=e=0,f=a.length;e<f;b=++e)d=a[b],a[b]=Math.round(d);switch(a.length){case 0:return this.ctx.drawImage(c.buf,0,0);case 2:return this.ctx.drawImage(c.buf,a[0],a[1]);case 4:return this.ctx.drawImage(c.buf,a[0],a[1],a[2],a[3]);case 6:return this.ctx.drawImage(c.buf,a[0],a[1],a[4],a[5],a[2],a[3],a[4],a[5]);case 8:return this.ctx.drawImage(c.buf,a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7])}},a.prototype.map=function(a,b,c,d,e,f,g,h,i){return i==null&&(h=d,i=e),this.drawImage(a,b*d,c*e,f*h,g*i,d,e)},a.prototype.layer=function(a,b){var c,d,e,f,g,h,i,j,k,l;return k=this.dims.x/2-b.x,l=this.dims.y/2-b.y,j=k+a.dims.x,g=l+a.dims.y,h=k>0?0:-k,c=k<0?0:k,i=l>0?0:-l,d=l<0?0:l,f=(j>this.dims.x?this.dims.x:j)-c,e=(g>this.dims.y?this.dims.y:g)-d,this.drawImage(a,h,i,c,d,f,e)},a}(),x=function(){function a(){this.basicsupport=Modernizr.canvas,this.render3D=Modernizr.webgl,this.cansaveload=Modernizr.localstorage,Modernizr.audio===!1||Modernizr.audio.mp3===""&&Modernizr.audio.ogg===""?this.soundext=0:Modernizr.audio.ogg==="probably"?this.soundext=".ogg":Modernizr.audio.mp3==="probably"?this.soundext=".mp3":Modernizr.audio.ogg==="maybe"?this.soundext=".ogg":this.soundext=".mp3"}return a}(),y=function(a){function b(a,c,d,e,f){var g,h,i,j,k,l,m,n,o,q,r=this;this.tilesize=a,this.tilesheet=c,this.bgmusic=d,this.musicplaying=this.bgmusic===0,t.engine.bgcolor=e,t.engine.buffer.ctx.fillStyle=e,b.__super__.constructor.call(this,{collide:!0,passive:!0,area:new p(0,0,this.tilesize.x,this.tilesize.y)}),g=new A(f[0].length,f.length),this.sheet=new w((new A).l(function(a){return r.tilesize.i(a)*g.i(a)})),l=this.tilesheet.dims.x/this.tilesize.x,this.grid=function(){var a,b,c;c=[];for(h=a=0,b=g.x+2;0>b?a>b:a<b;h=0>b?--a:++a)c.push(function(){var a,b,c;c=[];for(i=a=0,b=g.y+2;0>b?a>b:a<b;i=0>b?--a:++a)h===0||i===0||h===g.x+1||i===g.y+1?c.push(-1):c.push(f[i-1][h-1]);return c}());return c}();for(h=m=0,o=g.x;0>o?m>o:m<o;h=0>o?--m:++m)for(i=n=0,q=g.y;0>q?n>q:n<q;i=0>q?--n:++n)k=Math.floor((Math.abs(this.grid[1+h][1+i])-1)/l),j=Math.abs(this.grid[1+h][1+i])-1-k*l,this.sheet.map(this.tilesheet,j,k,this.tilesize.x,this.tilesize.y,h,i)}return D(b,a),b.prototype.step=function(a,b){var c=this;return this.musicplaying||(this.musicplaying=!0,t.audio.maxvolume=!0,this.bgmusic.play()),this.bgmusic!==0&&this.bgmusic.step(),a.layer(this.sheet,(new A).l(function(c){return b.i(c)+a.dims.i(c)/2}))},b.prototype.docollide=function(a){var c,d,e,f=this;c=(new A).l(function(b){return 1+Math.floor(a.area.p.i(b)/f.tilesize.i(b))}),e=(new A).l(function(b){return 1+Math.floor((a.area.p.i(b)+a.area.s.i(b)/2)/f.tilesize.i(b))-c.i(b)}),d=1+e.x+e.y*2,this.grid[c.x][c.y]<0&&(d!==4||this.grid[c.x][c.y+1]>0&&this.grid[c.x+1][c.y]>0)&&(this.area.p.x=(c.x-1)*this.area.s.x,this.area.p.y=(c.y-1)*this.area.s.y,b.__super__.docollide.call(this,a)),this.grid[c.x+1][c.y]<0&&(d!==3||this.grid[c.x][c.y]>0&&this.grid[c.x+1][c.y+1]>0)&&(this.area.p.x=c.x*this.area.s.x,this.area.p.y=(c.y-1)*this.area.s.y,b.__super__.docollide.call(this,a)),this.grid[c.x][c.y+1]<0&&(d!==2||this.grid[c.x][c.y]>0&&this.grid[c.x+1][c.y+1]>0)&&(this.area.p.x=(c.x-1)*this.area.s.x,this.area.p.y=c.y*this.area.s.y,b.__super__.docollide.call(this,a));if(this.grid[c.x+1][c.y+1]<0&&(d!==1||this.grid[c.x][c.y+1]>0&&this.grid[c.x+1][c.y]>0))return this.area.p.x=c.x*this.area.s.x,this.area.p.y=c.y*this.area.s.y,b.__super__.docollide.call(this,a)},b}(v),A=function(){function a(a,b){this.x=a,this.y=b}return a.prototype.l=function(a){return this.x=a(!0),this.y=a(!1),this},a.prototype.i=function(a){return a?this.x:this.y},a.prototype.j=function(a){return a?this.y:this.x},a}(),p=function(){function a(a,b,c,d){this.p=new A(a,b),this.s=new A(c,d)}return a}(),b=function(){function a(a,b){this.set(a,b)}return a.prototype.get=function(a){switch(a){case"spr":return this.value;case"kbd":return new A([0,-1,-1,-1,0,1,1,1,0][4+this.value],[0,1,0,-1,-1,-1,0,1,1][4+this.value]);case"vlc":return new A([0,-0.707,-1,-0.707,0,.707,1,.707,0][4+this.value],[0,.707,0,-0.707,-1,-0.707,0,.707,1][4+this.value])}},a.prototype.set=function(a,b,c){switch(a){case"spr":return this.value=b;case"kbd":return this.value=[[-1,0,1],[-2,-4,2],[-3,4,3]][1+b.y][1+b.x];case"pts":return this.value=this.getpts(b,c)}},a.prototype.getpts=function(a,b){var c,d,e,f;return e=a.x-b.x,f=a.y-b.y,e===0?c=f>0?0:4:(d=f/e,e<0&&(d>2.41421356&&(c=4),.414213562<d&&d<=2.41421356&&(c=3),-0.414213562<d&&d<=.414213562&&(c=2),-2.41421356<d&&d<=-0.414213562&&(c=1),d<=-2.41421356&&(c=0)),e>0&&(d>2.41421356&&(c=0),.414213562<d&&d<=2.41421356&&(c=-1),-0.414213562<d&&d<=.414213562&&(c=-2),-2.41421356<d&&d<=-0.414213562&&(c=-3),d<=-2.41421356&&(c=4))),c},a}(),h=new s([],function(){var a=this;return t.cutscenemgr.initialize([{txt:"Pinkie Pie#Hi, I'm Pinkie Pie!"},{txt:"Pinkie Pie#I threw this party just for you!"},{txt:";Pinkie Pie#Were you surprised?#;Yes;Nope;What?;Buck you.",next:function(a){return 3+a}},{txt:"Pinkie Pie#You chose yes!",next:function(){return a.exitscene(-1)}},{txt:"Pinkie Pie#You chose no!",next:function(){return a.exitscene(-1)}},{txt:"Pinkie Pie#You chose hmm?",next:function(){return a.exitscene(-1)}},{txt:"#You made Pinkie cry :<",next:function(){return a.exitscene(-1)}}])}),i=new s(["img/room.test0","img/thumb.art1","img/artifact.quest"],function(){var a=this;return t.cutscenemgr.initialize([{len:150,elem:[new m(this.file[2],function(a){return[Math.cos(Math.PI*a/30)*200,Math.sin(Math.PI*a/30)*200,1,1,a<60?a+1:0]}),new m(this.file[1],function(a){return[0,0,1,this.fadeform(a,30),a<60?a+1:0]}),new m(this.file[0],function(a){return[0,0,1,1,0]})],txt:"#This is some text during a cutscene."},{len:0,elem:[new m(this.file[2],function(a){return[0,0,Math.cos(Math.PI*a/30)+1,1,a<60?a+1:0]}),new m(this.file[0],function(a){return[0,0,1,1,0]})],txt:";#Make your choice:#;Choice One;Choice Two",next:function(a){return 2+a}},{len:50,txt:"#You chose one!",next:function(){return a.exitscene(-1)}},{len:50,txt:"#You chose two!",next:function(){return a.exitscene(-1)}}])}),t={},window.addEventListener("load",function(){var a,b,c,d;return c=new w(document.getElementById("miskatonic")),d=new x,d.basicsupport?(b={n:j,c:[{n:z,c:[]},{n:k,c:[{n:h,c:[]},{n:i,c:[]}]}]},a={up:[38,87,90,188],left:[37,65,81],down:[40,79,83],right:[39,68,69],run:[16],act:[13,32],pause:[27,80]},t.scene=b.n,t.load=new l,t.formats=new f,t.save=new q(d.cansaveload),t.audio=new u(d.soundext),t.reset=function(a){t.audio.erase(),t.state=t.scene;if(a)return t.scene.child[0].initialize()},t.engine=new e([t.audio,t.load],b,c,a),document.addEventListener("keydown",function(a){return t.engine.input(function(){return a.preventDefault()},a.keyCode,1)}),document.addEventListener("keyup",function(a){return t.engine.input(function(){return a.preventDefault()},a.keyCode,-1)}),window.setInterval(function(){return t.engine.step()},33)):c.buf.parentNode.replaceChild(c.buf.firstChild,c.buf)}),j=new s(["img/text","img/pause","snd/next","snd/last","snd/omenu","snd/cmenu","img/controls[0-4]"],function(){var b,c,e;return this.canreeval=!1,e=new w(new A(656,208)),e.ctx.fillStyle="#000000",e.ctx.globalAlpha=.7,e.clear(!1),e.ctx.beginPath(),e.ctx.arc(16,64,16,3*Math.PI/2,Math.PI,!0),e.ctx.arc(16,192,16,Math.PI,Math.PI/2,!0),e.ctx.arc(640,192,16,Math.PI/2,0,!0),e.ctx.arc(640,64,16,0,3*Math.PI/2,!0),e.ctx.fill(),b=new w(t.engine.screen.size()),e.ctx.globalAlpha=1,t.inscenemgr=new r,t.outscenemgr=new r,t.cutscenemgr=new d(this.file[0],e,new p(1,1/3,38,4),new p(16,48,32,32),new A(0,124),this.file[2],this.file[3]),c=new d(this.file[0],this.file[1],new p(41/3,5,38,4),new p(16,48,32,32),new A(0,0),this.file[2],this.file[5]),t.pausemgr=new n(t.engine.screen,b,o(b,this.file[6]),c,this.file[4],this.file[5]),t.getai=new a,t.engine.rends.push(t.pausemgr,t.cutscenemgr,t.inscenemgr,t.outscenemgr)},function(a){return this.child[a+1===this.child.length?0:a+1].initialize()}),k=new s(["img/tiles","img/pinkiepie","img/pinkiepie","img/pinkiepie","snd/scene1"],function(){var a=this;return t.inscenemgr.initialize([new v({area:new p(51,1368,96,96),len:[0,1,7,13],speed:[0,3,9],vector:new b("spr",2),sheet:this.file[1]}),new v({area:new p(1823,109,96,96),len:[0,1,7,13],speed:[0,3,9],collide:!0,aiscript:t.getai.follow(100,150,200),interact:!0,vector:new b("spr",-1),sheet:this.file[2],callback:function(b,c){return a.child[1].initialize()}}),new v({area:new p(1013,661,96,96),len:[0,1,7,13],speed:[0,3,9],collide:!0,interact:!0,passive:!0,sheet:this.file[3],callback:function(b,c){return b.vector.set("pts",b.area.p,c.area.p),a.child[0].initialize()}}),new y(new A(100,100),this.file[0],this.file[4].init(0,15),"#000000",[[-7,-7,-7,-7,-7,1,2,3,-7,1,18,26,16,3,-7,1,2,2,2,3],[-7,16,17,3,-7,27,12,9,-7,10,14,12,15,8,-7,27,12,12,12,8],[24,15,12,22,-7,6,12,14,2,15,12,12,12,13,-7,11,12,12,12,13],[-7,21,12,22,-7,6,12,4,-7,-7,20,19,-7,-7,-7,-7,5,4,-7,-7],[-7,-7,5,22,-7,6,12,8,-7,1,15,14,2,3,-7,-7,10,9,-7,-7],[-7,-7,10,9,-7,10,12,8,-7,27,12,12,12,8,-7,1,15,14,2,3],[-7,24,15,14,2,15,12,8,-7,27,12,12,12,8,-7,11,12,12,12,13],[-7,-7,-7,-7,-7,5,12,8,-7,11,12,12,12,13,-7,-7,-7,5,4,-7],[-7,-7,-7,-7,-7,10,12,9,-7,-7,-7,-7,-7,-7,-7,-7,-7,10,22,-7],[1,2,2,17,2,15,12,14,2,2,2,17,17,2,2,2,2,15,22,-7],[6,12,12,12,12,23,-7,21,12,12,12,12,12,12,12,12,12,12,9,-7],[6,12,12,12,19,-7,-7,-7,20,4,-7,-7,-7,5,4,-7,-7,5,14,29],[6,12,12,12,14,18,-7,16,15,9,-7,-7,-7,10,9,-7,-7,10,12,29],[6,4,-7,-7,5,14,2,15,12,14,17,2,2,15,14,2,2,15,4,-7],[11,13,-7,-7,11,12,12,12,12,12,12,23,-7,28,28,-7,21,12,13,-7]])])}),o=function(a,b){return[{elem:[new m(a,function(a){return[0,0,1,1,0]})],txt:";;Continue;Options;Save Game;Quit Game",next:function(a){switch(a){case 0:return-1;case 2:return t.save.cansaveload?t.save.savestate(2):5;default:return a}}},{txt:";;Audio;Controls;Video;Back",next:function(a){switch(a){case 3:return 0;case 0:return t.audio.musicext===0||t.audio.soundext===0?6:7;default:return 7+a}}},{txt:"    Your progress has been saved.",next:-1},{txt:";    Are you sure you want to quit?#;Yes;No",next:function(a){return a===0?4:-1}},{len:50,overlay:new g("#000000",50,!0),txt:-1,next:function(){return t.pausemgr.display.clear(!0),t.reset(!0),-1}},{txt:"Your browser does not support savestates.",next:0},{txt:"Your browser does not support audio.",next:1},{txt:";;Mute;Unmute",next:function(a){return t.audio.mute(a===0),-1}},{elem:[new m(b[1],function(a){return[5,72,1,0<=a&&a<15?a/15:30<=a&&a<45?1-(a-30)/15:15<=a&&a<30?1:0,a<119?a+1:0]}),new m(b[2],function(a){return[5,72,1,30<=a&&a<45?(a-30)/15:60<=a&&a<75?1-(a-60)/15:45<=a&&a<60?1:0,a<119?a+1:0]}),new m(b[3],function(a){return[5,72,1,60<=a&&a<75?(a-60)/15:90<=a&&a<105?1-(a-90)/15:75<=a&&a<90?1:0,a<119?a+1:0]}),new m(b[4],function(a){return[5,72,1,90<=a&&a<105?(a-90)/15:0<=a&&a<15?1-a/15:105<=a&&a<120?1:0,a<119?a+1:0]}),new m(b[0],function(a){return[0,85,1,1,0]}),new m(a,function(a){return[0,0,1,1,0]})],txt:"",next:-1},{txt:";;Aspect Ratio;3D Effect;Fullscreen;Back",next:function(a){switch(a){case 3:return 1;default:return 10+a}}},{txt:";;4:3;16:10;5:3;16:9",next:function(a){switch(a){case 0:t.engine.resize(new A(800,600));break;case 1:t.engine.resize(new A(960,600));break;case 2:t.engine.resize(new A(1e3,600));break;case 3:t.engine.resize(new A(1066,600))}return-1}},{txt:"This has not been implemented yet.",next:-1},{txt:";;Full Mode;Normal Mode",next:function(a){return a===0?t.engine.fullscreen(!0):t.engine.fullscreen(!1),13}},{txt:"Please press the F11 key to enter#or leave true fullscreen mode.",next:-1}]},z=new s(["img/title","snd/title"],function(){var a=this;return t.cutscenemgr.initialize([{len:50,overlay:new g("#000000",50,!1),elem:[new m(this.file[0],function(a){return[0,0,1,1,0]})]},{len:0,txt:";##;New Game;Load Game",snd:this.file[1].init(0,225),next:function(a){return a===0?2:t.save.cansaveload?t.save.validate()?4:3:5}},{len:30,overlay:new g("#000000",30,!0),txt:-1,next:function(){return a.exitscene(6)}},{txt:"##There is no save data avaliable.",next:1},{len:30,overlay:new g("#000000",30,!0),txt:-1,next:function(){return t.save.loadstate(6)}},{txt:"##Your browser does not support savestates.",next:1},{overlay:new g("#000000",30,!1),elem:-1,snd:-1,next:-1}])})}).call(this);