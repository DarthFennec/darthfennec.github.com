// Generated by CoffeeScript 1.3.3
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=[].slice,E={}.hasOwnProperty,F=function(a,b){function d(){this.constructor=a}for(var c in b)E.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};a=function(){function a(){}return a.prototype.watch=function(a){return function(b){var c;c=Math.pow(this.area.p.x-b[0].area.p.x,2)+Math.pow(this.area.p.y-b[0].area.p.y,2);if(c<a*a)return this.vector.set("pts",this.area.p,b[0].area.p)}},a.prototype.random=function(a){return function(b){if(Math.random()>a)return this.mode=Math.floor(Math.random()*4),this.vector.set("spr",-3+Math.floor(Math.random()*8))}},a.prototype.follow=function(a,b,c){var d,e,f;return d=0,f=0,e=new C(-1,-1),function(g){var h,i,j,k,l,m,n,o,p;m=g[g.length-1],k=new C(Math.abs(this.area.p.x-g[0].area.p.x),Math.abs(this.area.p.y-g[0].area.p.y)),d===0&&(d=new Graph(m.grid.map(function(a){return a.map(function(a){return a<0?1:0})}))),l=k.x>k.y?k.x:k.y,n=new C(Math.floor(this.area.p.x/m.tilesize.x),Math.floor(this.area.p.y/m.tilesize.y)),h=new C(Math.floor(g[0].area.p.x/m.tilesize.x),Math.floor(g[0].area.p.y/m.tilesize.y));if(e.x!==h.x||e.y!==h.y)e=new C(h.x,h.y),f=astar.search(d.nodes,d.nodes[n.x][n.y],d.nodes[h.x][h.y]),f=f.filter(function(a,b,c){return c[b-1]!=null&&c[b+1]!=null?c[b-1].x===c[b+1].x||c[b-1].y===c[b+1].y:!0});if(l<=a){j=0,i=0,o=g[0].vector.get("kbd");if(k.x<k.y){if(o.y!==0){if(o.x===-1)this.vector.set("spr",2);else if(o.x===1)this.vector.set("spr",-2);else{while(h.x+j!==d.input.length&&d.input[h.x+j][h.y]!==1)j+=1;while(h.x-i!==0&&d.input[h.x-i][h.y]!==1)i+=1;this.vector.set("spr",j>i?2:-2)}this.mode=3}}else if(o.x!==0){if(o.y===-1)this.vector.set("spr",4);else if(o.y===1)this.vector.set("spr",0);else{while(h.y+j!==d.input[0].length&&d.input[h.x][h.y+j]!==1)j+=1;while(h.y-i!==0&&d.input[h.x][h.y-i]!==1)i+=1;this.vector.set("spr",j>i?4:0)}this.mode=3}}a<l&&l<=b&&(this.vector.set("pts",this.area.p,g[0].area.p),this.mode=0);if(b<l&&f.length>0)return p=new C,f[0].x===n.x&&f[0].y===n.y&&f.shift(),p.x=f[0].x>n.x?1:f[0].x<n.x?-1:0,p.y=f[0].y>n.y?1:f[0].y<n.y?-1:0,p.x===0&&this.area.p.x+this.area.s.x>m.tilesize.x*(n.x+1)&&d.input[n.x+1][n.y+p.y]===1&&(p.x=-1),p.y===0&&this.area.p.y+this.area.s.y>m.tilesize.y*(n.y+1)&&d.input[n.x+p.x][n.y+1]===1&&(p.y=-1),this.vector.set("kbd",p),this.mode=c<l?3:1}},a}(),c=function(){function a(a){var b=this;this.ii=0,this.oldset=!1,this.newset=!1,this.datamode=0,this.data=new Audio,this.data.src=a,this.data.addEventListener("ended",function(){return b.datamode=0}),this.altdatamode=0,this.altdata=new Audio,this.altdata.src=a,this.altdata.addEventListener("ended",function(){return b.altdatamode=0})}return a.prototype.play=function(){if(this.datamode===0)return this.datamode=1,this.data.play();if(this.altdatamode===0)return this.altdatamode=1,this.altdata.play()},a.prototype.stop=function(){this.datamode!==0&&(this.datamode=0,this.data.pause(),this.data.currentTime=0);if(this.altdatamode!==0)return this.altdatamode=0,this.altdata.pause(),this.altdata.currentTime=0},a.prototype.pause=function(){this.datamode===1&&(this.datamode=2,this.data.pause());if(this.altdatamode===1)return this.altdatamode=2,this.altdata.pause()},a.prototype.unpause=function(){this.datamode===2&&(this.datamode=1,this.data.play());if(this.altdatamode===2)return this.altdatamode=1,this.altdata.play()},a.prototype.fade=function(a){return this.data.volume=a,this.altdata.volume=a},a}(),d=function(){function a(a,b,c,d){this.charsheet=a,this.background=b,this.chars=c,this.chararea=d,this.text=new y(this.background.size()),this.frames=0,this.choice=-1}return a.prototype.initialize=function(a){return this.frames=a,this.frame={len:0,elem:-1,txt:-1,overlay:-1,snd:-1,next:0},this.time=0,this.next()},a.prototype.render=function(a){var b,c,d,e,f;if(this.frames!==0){this.time>(e=this.frame.len)&&e>0&&this.next(),this.frame.snd!==-1&&this.frame.snd.step(),this.frame.txt!==-1&&a.drawImage(this.text,(a.dims.x-this.text.dims.x)/2,a.dims.y-this.text.dims.y-(a.dims.x-this.text.dims.x)/2),this.frame.overlay!==-1&&this.frame.overlay.render(a)&&(this.frame.overlay=-1);if(this.frame.elem!==-1){f=this.frame.elem;for(c=0,d=f.length;c<d;c++)b=f[c],b.render(a)}if(this.frame.elem!==-1||this.frame.overlay!==-1)a.ctx.globalAlpha=1;return this.time+=1,this.frame.elem!==-1}return!1},a.prototype.input=function(a){if(this.frames!==0){this.frame.len===0&&a.act.poll===1&&this.next();if(a.act.poll!==1&&this.choice!==-1){if(a.up.poll===1||a.down.poll===1)this.choice+=this.choice<2?2:-2;if(a.left.poll===1||a.right.poll===1)this.choice+=this.choice%2===0?1:-1;this.drawchoice(this.frame.txt)}return!0}return!1},a.prototype.next=function(){var a,b;b=this.frame.next,"function"==typeof b&&(b=b(this.choice)),this.choice=-1;if(b===-1)return this.frames=0;for(a in this.frames[b])this.frame[a]=this.frames[b][a];this.frame.next===b&&(this.frame.next+=1),this.time=0;if(this.frame.txt!==-1)return this.frame.txt[0]===";"?(this.choice=0,this.drawchoice(this.frame.txt)):this.drawtext(this.frame.txt)},a.prototype.drawchoice=function(a){var b,c,d,e,f,g,h;b=a.substring(1).split(";",5),d=b.shift(),b.length===2&&this.choice>1&&(this.choice-=2),b.length===3&&this.choice===3&&(this.choice-=1),b[this.choice]="> "+b[this.choice]+" <";for(f=0,h=b.length;f<h;f++){c=b[f],e=Math.floor((Math.floor(this.chars.s.x/2)-c.length)/2);for(g=1;1>e?g>=e:g<=e;1>e?g--:g++)c=" "+c+" ";c.length%2!==this.chars.s.x/2%2&&(c+=" "),d+=c}return this.drawtext(d)},a.prototype.drawtext=function(a){var b,c,d,e,f,g,h,i;d=0,c=0,this.text.clear(!1),this.text.drawImage(this.background),i=[];for(g=0,h=a.length;g<h;g++){b=a[g];if(d>=this.chars.s.y)continue;b!=="#"&&(f=Math.floor(b.charCodeAt(0)/16),e=b.charCodeAt(0)-16*f,this.text.map(this.charsheet,e,f,this.chararea.s.x,this.chararea.s.y,this.chars.p.x+c,this.chars.p.y+d,this.chararea.p.x,this.chararea.p.y),c+=1),c<this.chars.s.x&&b!=="#"?i.push(void 0):(c=0,i.push(d+=1))}return i},a}(),g=function(){function a(a,b,c){this.color=a,this.duration=b,this.type=c,this.time=0}return a.prototype.render=function(a){var b;return u.audio.volume=this.type?1-this.time/this.duration:this.time/this.duration,b=this.type?this.time/this.duration:1-this.time/this.duration,a.ctx.globalAlpha=b,a.ctx.fillStyle=this.color,a.clear(!0),a.ctx.globalAlpha=1,a.ctx.fillStyle="#000000",this.time+=1,this.time>this.duration},a}(),n=function(){function a(a,b){this.image=a,this.callback=b,this.time=0}return a.prototype.render=function(a){var b;return b=this.callback(this.time),a.ctx.globalAlpha=b[3],a.drawImage(this.image,b[0],b[1],b[2]*this.image.dims.x,b[2]*this.image.dims.y),this.time+=1},a.prototype.fadeform=function(a,b){return.5+.5*Math.cos(a*Math.PI/b)},a.prototype.zoomform=function(a,b,c,d,e,f){return[c-a*e,d-b*e,e,f]},a}(),v=function(){function a(a){this.track=a}return a.prototype.step=function(){var a;return(a=this.track)!=null?a.newset=!0:void 0},a}(),m=function(){function a(a,b,c){var d,e,f,g=this;this.track=a,this.loop=c,(d=this.track)!=null&&d.fade(b),(e=this.track)!=null&&e.play(),(f=this.track)!=null&&(f.ii=window.setInterval(function(){return g.track.play()},1e3*this.loop))}return a.prototype.step=function(){var a;return(a=this.track)!=null?a.newset=!0:void 0},a}(),e=function(){function a(a,b,c,d){var e;this.rends=a,this.screen=c,this.keys={};for(e in d)this.keys[e]={val:d[e],poll:0,state:0};this.buffer=new y(this.screen.size()),this.buffer.ctx.fillStyle="#000000",this.buffer.ctx.strokeStyle="#ffffff",this.buffer.ctx.lineWidth=25,this.buffer.ctx.lineCap="round",this.buffer.ctx.globalCompositeOperation="destination-over",b.n.buildtree(b.c,0,0),b.n.initialize(),u.reset(!0)}return a.prototype.input=function(a,b){var c,d,e,f,g,h,i,j,k,l;c=!1;for(d in this.keys){this.keys[d].poll=0,k=this.keys[d].val;for(g=0,i=k.length;g<i;g++){e=k[g];if(a!==e)continue;c=!0,this.keys[d].poll=b}this.keys[d].poll===1&&(this.keys[d].state=1),this.keys[d].poll===-1&&(this.keys[d].state=0)}if(c){l=this.rends;for(h=0,j=l.length;h<j;h++){f=l[h];if(f.input(this.keys))break}}return!1},a.prototype.step=function(){var a,b,c,d;this.screen.drawImage(this.buffer),this.buffer.clear(!1),d=this.rends;for(b=0,c=d.length;b<c;b++){a=d[b];if(a.render(this.buffer))break}return this.buffer.clear(!0)},a}(),f=function(){function a(){this.callbacks=[],this.filetype=[],this.filetype.push({head:"img/",call:function(a){var b,c=this;return b=new y(new Image),u.load.loadcount.push(b),b.buf.onload=function(){return b.dims.x=b.buf.width,b.dims.y=b.buf.height,u.formats.finish(b)},b.buf.src=a+".png",b}})}return a.prototype.load=function(a){var b,c,d,e,f,g;d=a.substr(0,4),g=this.filetype;for(e=0,f=g.length;e<f;e++)b=g[e],b.head===d&&(c=b.call(a));return c},a.prototype.finish=function(a){var b,c,d,e,f,g;c=u.load.loadcount.indexOf(a),c!==-1&&u.load.loadcount.splice(c,1);if(u.load.loadcount.length===0){d=this.callbacks,this.callbacks=[],g=[];for(e=0,f=d.length;e<f;e++)b=d[e],g.push(b());return g}},a}(),l=function(){function a(){this.loadsprite=0,this.loadcount=[],this.maxload=0}return a.prototype.render=function(a){var b;return this.loadcount.length!==0?(this.maxload<this.loadcount.length&&(this.maxload=this.loadcount.length),b=(this.maxload-this.loadcount.length)*(a.dims.x-60)/this.maxload,a.ctx.beginPath(),a.ctx.moveTo(30,a.dims.y-30),a.ctx.lineTo(b+30,a.dims.y-30),a.ctx.stroke(),this.loadsprite!==0&&this.loadsprite.step(a,new C(0,0))):this.maxload=0,this.loadcount.length!==0},a.prototype.input=function(a){return this.loadcount.length!==0},a}(),o=function(){function a(a,b,c){this.underlay=a,this.menu=b,this.obj=c,this.display=new y(this.underlay.size()),this.menu[0].elem=[new n(this.display,function(a){return[0,0,1,1]})],this.pressed=0}return a.prototype.render=function(a){var b,c,d,e,f;this.pressed>0&&(this.obj.frames=0);if(this.pressed<0){this.display.clear(!1),this.display.drawImage(this.underlay),f=this.menu;for(d=0,e=f.length;d<e;d++){b=f[d];for(c in b)b[c].time!=null&&(b[c].time=0)}this.obj.initialize(this.menu)}return this.pressed=0,this.obj.render(a)},a.prototype.input=function(a){var b,c,d;return b=this.obj.frames===0?-1:1,d=this.obj.input(a),c=this.obj.frames===0?-1:1,this.pressed=a.pause.poll===1||b===1&&c===-1?b:0,d},a}(),r=function(){function a(a){this.cansaveload=a}return a.prototype.validate=function(){return localStorage.savestate!=null},a.prototype.savestate=function(a){var b,c;return b={},b.stack=u.scene.savestate(u.state),b.stack.shift(),b.local=function(){var a,b,d,e;d=u.engine.rends,e=[];for(a=0,b=d.length;a<b;a++)c=d[a],c.savestate!=null&&e.push(c.savestate());return e}(),localStorage.savestate=JSON.stringify(b),a},a.prototype.loadstate=function(a){var b;return u.reset(!1),b=JSON.parse(localStorage.savestate),u.scene.loadstate(b.stack),u.formats.callbacks.push(function(){var a,c,d,e,f;e=u.engine.rends,f=[];for(c=0,d=e.length;c<d;c++)a=e[c],a.loadstate!=null&&f.push(a.loadstate(b.local.shift()));return f}),a},a}(),s=function(){function a(){this.currscene=0}return a.prototype.initialize=function(a){this.currscene=a},a.prototype.render=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if(this.currscene!==0){l=this.currscene;for(f=0,i=l.length;f<i;f++){e=l[f];if(!!e.passive)continue;m=this.currscene;for(g=0,j=m.length;g<j;g++)d=m[g],e!==d&&d.docollide(e);e.aiscript!==0&&e.aiscript(this.currscene)}b=this.currscene[0].area.p.x+(this.currscene[0].area.s.x-a.dims.x)/2,c=this.currscene[0].area.p.y+(this.currscene[0].area.s.y-a.dims.y)/2,n=this.currscene;for(h=0,k=n.length;h<k;h++)e=n[h],e.step(a,new C(b,c));return!0}return!1},a.prototype.input=function(a){var b,c,d,e;if(this.currscene!==0){a.right.state===a.left.state&&a.down.state===a.up.state?this.currscene[0].mode=0:(this.currscene[0].mode=a.run.state===1?3:1,this.currscene[0].vector.set("kbd",new C(a.right.state-a.left.state,a.down.state-a.up.state)));if(a.act.poll===1){e=this.currscene;for(c=0,d=e.length;c<d;c++)b=e[c],b.interact&&b.dointeract(this.currscene[0])}return!0}return!1},a.prototype.savestate=function(){var a,b,c,d,e;if(this.currscene!==0){d=this.currscene,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.savestate());return e}},a.prototype.loadstate=function(a){var b,c,d,e,f,g;if(this.currscene!==0){f=this.currscene,g=[];for(b=d=0,e=f.length;d<e;b=++d)c=f[b],g.push(c.loadstate(a[b]));return g}},a}(),t=function(){function a(a,b,c){this.filelist=a,this.init=b,this.callback=c,this.canreeval=!0}return a.prototype.buildtree=function(a,b,c){var d,e,f,g;this.parent=b,this.idx=c,this.child=[],g=[];for(c=e=0,f=a.length;e<f;c=++e)d=a[c],this.child[c]=d.n,g.push(d.n.buildtree(d.c,this,c));return g},a.prototype.initialize=function(){var a,b=this;if(this.canreeval)return this.file=[],u.audio.push(),u.state=this,this.filelist.length===0?u.formats.callbacks.length===0?this.init():u.formats.callbacks.push(function(){return b.init()}):(u.formats.callbacks.push(function(){return b.init()}),this.file=function(){var b,c,d,e;d=this.filelist,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(u.formats.load(a));return e}.call(this))},a.prototype.exitscene=function(a){var b;return u.audio.clear(),u.state=this.parent,typeof (b=this.parent).callback=="function"&&b.callback(this.idx),a},a.prototype.savestate=function(a){var b,c,d,e,f,g;d=0;if(a===this)d=[this.idx];else{g=this.child;for(e=0,f=g.length;e<f;e++){b=g[e];if(!((c=b.savestate(a))instanceof Array))continue;d=c,d.unshift(this.idx)}}return d},a.prototype.loadstate=function(a){var b;this.initialize();if(a.length>0)return b=a.shift(),this.child[b].loadstate(a)},a}(),w=function(){function a(a,b){this.musicext=a,this.soundext=b,this.volume=1,this.volnew=1,this.list=[],u.formats.filetype.push({head:"trk/",call:function(a){var b,c=this;if(u.audio.musicext!==0)return b=u.audio.add(a+u.audio.musicext),u.load.loadcount.push(b),b.data.addEventListener("canplaythrough",function(){return u.formats.finish(b)}),b}}),u.formats.filetype.push({head:"snd/",call:function(a){var b,c=this;if(u.audio.soundext!==0)return b=u.audio.add(a+u.audio.soundext),u.load.loadcount.push(b),b.data.addEventListener("canplaythrough",function(){return u.formats.finish(b)}),b}})}return a.prototype.add=function(a,b){var d;return d=new c(a),this.list[0].push(d),d},a.prototype.push=function(){return this.list.unshift([])},a.prototype.erase=function(){var a,b,c,d,e;d=this.list,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(this.clear());return e},a.prototype.clear=function(){var a,b,c,d;c=this.list.shift(),d=[];for(a=0,b=c.length;a<b;a++)v=c[a],v.ii!==0&&window.clearInterval(v.ii),d.push(v.stop());return d},a.prototype.render=function(a){var b,c,d,e,f,g,h;this.volume<0&&(this.volume=0),this.volume>1&&(this.volume=1),h=this.list;for(d=0,f=h.length;d<f;d++){c=h[d];for(e=0,g=c.length;e<g;e++)b=c[e],b.oldset&&!b.newset&&(b.ii===0?b.pause():b.fade(0)),b.newset&&!b.oldset&&(b.ii===0?b.unpause():b.fade(this.volume)),b.oldset=b.newset,b.newset=!1,this.volnew!==this.volume&&(this.volnew=this.volume,b.fade(this.volume))}return!1},a.prototype.input=function(a){return!1},a}(),x=function(){function a(a){var c,d,e;c={sheet:0,area:new q(0,0,0,0),callback:0,aiscript:0,len:[],speed:[],collide:!1,trigger:!1,interact:!1,passive:!1,vector:new b("spr",0),mode:0,frame:0};for(d in c)this[d]=(e=a[d])!=null?e:c[d]}return a.prototype.step=function(a,b){var c,d=this;if(this.sheet!==0)return this.frame>=this.len[this.mode]&&(this.frame=0),c=new C(Math.floor(this.frame)+Math.abs(this.len[this.mode]*this.vector.get("spr")),this.mode),this.vector.get("spr")<0?(a.ctx.scale(-1,1),a.map(this.sheet,c.x,c.y,this.area.s.x,this.area.s.y,b.x-this.area.p.x-this.area.s.x,this.area.p.y-b.y,1,1),a.ctx.scale(-1,1)):a.map(this.sheet,c.x,c.y,this.area.s.x,this.area.s.y,this.area.p.x-b.x,this.area.p.y-b.y,1,1),this.area.p.l(function(){return d.area.p.i()+d.speed[d.mode]*d.vector.get("vlc").i()}),this.frame+=.3},a.prototype.docollide=function(a){var b,c,d,e,f,g;b=a.area.p.x+a.area.s.x-this.area.p.x,c=a.area.p.y+a.area.s.y-this.area.p.y,d=this.area.p.x+this.area.s.x-a.area.p.x,e=this.area.p.y+this.area.s.y-a.area.p.y,g=1,f=b;if(b>0&&c>0&&d>0&&e>0){this.collide&&(f>c&&(f=c,g=2),f>d&&(f=d,g=3),f>e&&(f=e,g=4),g===1&&(a.area.p.x-=f),g===2&&(a.area.p.y-=f),g===3&&(a.area.p.x+=f),g===4&&(a.area.p.y+=f));if(this.trigger)return a.mode=0,this.callback(this,a)}},a.prototype.dointeract=function(a){var b,c,d,e=this;d=new q(a.area.p.x,a.area.p.y,a.area.s.x,a.area.s.y),d.p.l(function(){return d.p.i()+a.vector.get("kbd").i()*d.s.i()/2}),b=(new C).l(function(){return d.p.i()+d.s.i()-e.area.p.i()}),c=(new C).l(function(){return e.area.p.i()+e.area.s.i()-d.p.i()});if(b.x>0&&b.y>0&&c.x>0&&c.y>0)return a.mode=0,this.callback(this,a)},a.prototype.savestate=function(){return{px:this.area.p.x,py:this.area.p.y,md:this.mode,fr:this.frame,vx:this.vector.get("spr")}},a.prototype.loadstate=function(a){return this.area.p.x=a.px,this.area.p.y=a.py,this.mode=a.md,this.frame=a.fr,this.vector.set("spr",a.vx)},a}(),y=function(){function a(a){var b;a instanceof HTMLImageElement||a instanceof HTMLCanvasElement?(this.buf=a,this.dims=new C(a.width,a.height)):(this.buf=document.createElement("canvas"),this.size(a)),this.ctx=typeof (b=this.buf).getContext=="function"?b.getContext("2d"):void 0}return a.prototype.size=function(a){return a!=null&&(this.dims=a,this.buf.width=a.x,this.buf.height=a.y),this.dims},a.prototype.clear=function(a){return a?this.ctx.fillRect(0,0,this.dims.x,this.dims.y):this.ctx.clearRect(0,0,this.dims.x,this.dims.y)},a.prototype.drawImage=function(){var a,b,c,d,e,f;c=arguments[0],a=2>arguments.length?[]:D.call(arguments,1);for(b=e=0,f=a.length;e<f;b=++e)d=a[b],a[b]=Math.round(d);switch(a.length){case 0:return this.ctx.drawImage(c.buf,0,0);case 2:return this.ctx.drawImage(c.buf,a[0],a[1]);case 4:return this.ctx.drawImage(c.buf,a[0],a[1],a[2],a[3]);case 6:return this.ctx.drawImage(c.buf,a[0],a[1],a[4],a[5],a[2],a[3],a[4],a[5]);case 8:return this.ctx.drawImage(c.buf,a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7])}},a.prototype.map=function(a,b,c,d,e,f,g,h,i){return i!=null?this.drawImage(a,b*d,c*e,f*h,g*i,d,e):this.drawImage(a,b*d,c*e,f*d,g*e,d,e)},a.prototype.layer=function(a,b){var c,d,e,f,g,h,i,j,k,l;return k=this.dims.x/2-b.x,l=this.dims.y/2-b.y,j=k+a.dims.x,g=l+a.dims.y,h=k>0?0:-k,c=k<0?0:k,i=l>0?0:-l,d=l<0?0:l,f=(j>this.dims.x?this.dims.x:j)-c,e=(g>this.dims.y?this.dims.y:g)-d,this.drawImage(a,h,i,c,d,f,e)},a}(),z=function(){function a(){this.basicsupport=Modernizr.canvas,this.rendershoggoth=Modernizr.webgl,this.cansaveload=Modernizr.localstorage,Modernizr.audio===!1||Modernizr.audio.mp3===""&&(Modernizr.audio.ogg===""||Modernizr.audio.wav==="")?(this.musicext=0,this.soundext=0):(Modernizr.audio.ogg==="probably"?this.musicext=".ogg":Modernizr.audio.mp3==="probably"?this.musicext=".mp3":Modernizr.audio.ogg==="maybe"?this.musicext=".ogg":this.musicext=".mp3",Modernizr.audio.wav==="probably"?this.soundext=".wav":Modernizr.audio.mp3==="probably"?this.soundext=".mp3":Modernizr.audio.wav==="maybe"?this.soundext=".wav":this.soundext=".mp3")}return a}(),A=function(a){function b(a,c,d){var e,f,g,h,i,j,k,l,m,n,o=this;this.tilesize=a,this.tilesheet=c,this.gridsize=new C(d[0].length,d.length),this.grid=function(){var a,b,c;c=[];for(e=a=0,b=this.gridsize.x;0>b?a>b:a<b;e=0>b?--a:++a)c.push(function(){var a,b,c;c=[];for(f=a=0,b=this.gridsize.y;0>b?a>b:a<b;f=0>b?--a:++a)c.push(d[f][e]);return c}.call(this));return c}.call(this),g=new y((new C).l(function(){return o.tilesize.i()*o.gridsize.i()})),j=this.tilesheet.dims.x/this.tilesize.x;for(e=k=0,m=this.gridsize.x;0>m?k>m:k<m;e=0>m?--k:++k)for(f=l=0,n=this.gridsize.y;0>n?l>n:l<n;f=0>n?--l:++l)i=Math.floor((Math.abs(this.grid[e][f])-1)/j),h=Math.abs(this.grid[e][f])-1-i*j,g.map(this.tilesheet,h,i,this.tilesize.x,this.tilesize.y,e,f);b.__super__.constructor.call(this,{sheet:g,collide:!0,passive:!0,area:new q(0,0,this.tilesize.x,this.tilesize.y)})}return F(b,a),b.prototype.step=function(a,b){return a.layer(this.sheet,(new C).l(function(){return b.i()+a.dims.i()/2}))},b.prototype.docollide=function(a){var c,d,e,f=this;c=(new C).l(function(){return Math.floor(a.area.p.i()/f.tilesize.i())}),e=(new C).l(function(){return Math.floor((a.area.p.i()+a.area.s.i()/2)/f.tilesize.i())-c.i()}),d=1+e.x+e.y*2,c.x<0&&(this.area.p.x=-this.area.s.x,this.area.p.y=a.area.p.y,b.__super__.docollide.call(this,a)),c.x>this.gridsize.x-2&&(this.area.p.y=a.area.p.y,this.area.p.x=this.gridsize.x*this.area.s.x,b.__super__.docollide.call(this,a)),c.y<0&&(this.area.p.y=-this.area.s.y,this.area.p.x=a.area.p.x,b.__super__.docollide.call(this,a)),c.y>this.gridsize.y-2&&(this.area.p.x=a.area.p.x,this.area.p.y=this.gridsize.y*this.area.s.y,b.__super__.docollide.call(this,a));if(c.x>0&&c.x<this.gridsize.x-2){this.grid[c.x][c.y]<0&&(d!==4||this.grid[c.x][c.y+1]>0&&this.grid[c.x+1][c.y]>0)&&(this.area.p.x=c.x*this.area.s.x,this.area.p.y=c.y*this.area.s.y,b.__super__.docollide.call(this,a)),this.grid[c.x+1][c.y]<0&&(d!==3||this.grid[c.x][c.y]>0&&this.grid[c.x+1][c.y+1]>0)&&(this.area.p.x=(c.x+1)*this.area.s.x,this.area.p.y=c.y*this.area.s.y,b.__super__.docollide.call(this,a)),this.grid[c.x][c.y+1]<0&&(d!==2||this.grid[c.x][c.y]>0&&this.grid[c.x+1][c.y+1]>0)&&(this.area.p.x=c.x*this.area.s.x,this.area.p.y=(c.y+1)*this.area.s.y,b.__super__.docollide.call(this,a));if(this.grid[c.x+1][c.y+1]<0&&(d!==1||this.grid[c.x][c.y+1]>0&&this.grid[c.x+1][c.y]>0))return this.area.p.x=(c.x+1)*this.area.s.x,this.area.p.y=(c.y+1)*this.area.s.y,b.__super__.docollide.call(this,a)}},b}(x),C=function(){function a(b,c){this.x=b,this.y=c,this["static"]=a["static"]}return a.prototype.l=function(a){return this["static"].isx=!0,this.x=a(),this["static"].isx=!1,this.y=a(),this},a.prototype.i=function(){return this["static"].isx?this.x:this.y},a.prototype.j=function(){return this["static"].isx?this.y:this.x},a}(),C["static"]={isx:!0},q=function(){function a(a,b,c,d){this.p=new C(a,b),this.s=new C(c,d)}return a}(),b=function(){function a(a,b){this.set(a,b)}return a.prototype.get=function(a){switch(a){case"spr":return this.value;case"kbd":return new C([0,-1,-1,-1,0,1,1,1,0][4+this.value],[0,1,0,-1,-1,-1,0,1,1][4+this.value]);case"vlc":return new C([0,-0.707,-1,-0.707,0,.707,1,.707,0][4+this.value],[0,.707,0,-0.707,-1,-0.707,0,.707,1][4+this.value])}},a.prototype.set=function(a,b,c){switch(a){case"spr":return this.value=b;case"kbd":return this.value=[[-1,0,1],[-2,-4,2],[-3,4,3]][1+b.y][1+b.x];case"pts":return this.value=this.getpts(b,c)}},a.prototype.getpts=function(a,b){var c,d,e,f;return e=a.x-b.x,f=a.y-b.y,e===0?c=f>0?0:4:(d=f/e,e<0&&(d>2.41421356&&(c=4),.414213562<d&&d<=2.41421356&&(c=3),-0.414213562<d&&d<=.414213562&&(c=2),-2.41421356<d&&d<=-0.414213562&&(c=1),d<=-2.41421356&&(c=0)),e>0&&(d>2.41421356&&(c=0),.414213562<d&&d<=2.41421356&&(c=-1),-0.414213562<d&&d<=.414213562&&(c=-2),-2.41421356<d&&d<=-0.414213562&&(c=-3),d<=-2.41421356&&(c=4))),c},a}(),i=new t(["img/room.test0","img/thumb.art1","img/artifact.quest"],function(){var a=this;return u.cutscenemgr.initialize([{len:150,elem:[new n(this.file[2],function(a){return[Math.cos(Math.PI*a/30)*200+350,Math.sin(Math.PI*a/30)*200+250,1,1]}),new n(this.file[1],function(a){return[350,250,1,this.fadeform(a,30)]}),new n(this.file[0],function(a){return[0,0,1,1]})],txt:"#This is some text during a cutscene."},{len:0,elem:[new n(this.file[2],function(a){return this.zoomform(64,64,400,300,Math.cos(Math.PI*a/30)+1,1)}),new n(this.file[0],function(a){return[0,0,1,1]})],txt:";#Make your choice:#;Choice One;Choice Two",next:function(a){return 2+a}},{len:50,txt:"#You chose one!",next:function(){return a.exitscene(-1)}},{len:50,txt:"#You chose two!",next:function(){return a.exitscene(-1)}}])}),u={},window.addEventListener("load",function(){var a,b,c,d;return c=new y(document.getElementById("miskatonic")),d=new z,d.basicsupport?(b={n:j,c:[{n:B,c:[]},{n:k,c:[{n:h,c:[]},{n:i,c:[]}]}]},a={up:[38,87,90,188],left:[37,65,81],down:[40,79,83],right:[39,68,69],run:[16,17,18],act:[13,32],pause:[8,9,27,80]},u.scene=b.n,u.load=new l,u.formats=new f,u.save=new r(d.cansaveload),u.audio=new w(d.musicext,d.soundext),u.reset=function(a){u.audio.erase(),u.state=u.scene;if(a)return u.scene.child[0].initialize()},u.engine=new e([u.audio,u.load],b,c,a),document.addEventListener("keydown",function(a){return u.engine.input(a.keyCode,1)}),document.addEventListener("keyup",function(a){return u.engine.input(a.keyCode,-1)}),window.setInterval(function(){return u.engine.step()},33)):c.buf.parentNode.replaceChild(c.buf.firstChild,c.buf)}),j=new t(["img/load","img/text","img/pause"],function(){var b,c;return this.canreeval=!1,c=new y(new C(656,208)),c.ctx.fillStyle="#000000",c.ctx.globalAlpha=.7,c.clear(!1),c.ctx.beginPath(),c.ctx.arc(16,64,16,3*Math.PI/2,Math.PI,!0),c.ctx.arc(16,192,16,Math.PI,Math.PI/2,!0),c.ctx.arc(640,192,16,Math.PI/2,0,!0),c.ctx.arc(640,64,16,0,3*Math.PI/2,!0),c.ctx.fill(),c.ctx.globalAlpha=1,u.inscenemgr=new s,u.outscenemgr=new s,u.cutscenemgr=new d(this.file[1],c,new q(1,1/3,38,4),new q(16,48,32,32)),b=new d(this.file[1],this.file[2],new q(5.5,5,38,4),new q(16,48,32,32)),u.pausemgr=new o(u.engine.screen,p,b),u.getai=new a,u.load.loadsprite=new x({sheet:this.file[0],area:new q(350,300,100,100),len:[8],speed:[0]}),u.engine.rends.push(u.pausemgr,u.cutscenemgr,u.inscenemgr,u.outscenemgr)},function(a){return this.child[a+1===this.child.length?0:a+1].initialize()}),p=[{txt:";;Continue;Options;Save Game;Quit Game",next:function(a){switch(a){case 0:return-1;case 2:return u.save.cansaveload?u.save.savestate(2):5;default:return a}}},{txt:"    This will be implemented soon.",next:0},{txt:"    Your progress has been saved.",next:-1},{txt:";    Are you sure you want to quit?#;Yes;No",next:function(a){return a===0?4:-1}},{len:50,overlay:new g("#000000",50,!0),txt:-1,next:function(){return u.pausemgr.display.clear(!0),u.reset(!0),-1}},{txt:"Your browser does not support this feature.",next:0}],k=new t(["img/pinkiepie","img/tent"],function(){var a=this;return u.outscenemgr.initialize([new x({sheet:this.file[0],area:new q(100,100,96,96),vector:new b("spr",2),len:[1,6,6,6],speed:[0,3,6,9]}),new x({sheet:this.file[0],area:new q(500,100,96,96),collide:!0,interact:!0,passive:!0,vector:new b("spr",4),len:[1,6,6,6],speed:[0,3,6,9],callback:function(b,c){return b.vector.set("pts",b.area.p,c.area.p),a.child[0].initialize()}}),new x({sheet:this.file[0],area:new q(100,500,96,96),collide:!0,interact:!0,aiscript:u.getai.follow(100,150,200),vector:new b("spr",-1),len:[1,6,6,6],speed:[0,3,6,9],callback:function(){return a.child[1].initialize()}}),new A(new C(100,100),this.file[1],[[21,21,21,21,21,21,21,21,21,21],[21,21,21,21,21,21,21,21,21,21],[21,21,21,21,21,21,21,21,21,21],[21,21,21,21,1,-2,-3,-4,5,21],[21,21,21,21,6,-7,-8,-9,10,21],[21,21,21,21,11,-12,13,-14,15,21],[21,21,21,21,16,17,18,19,20,21],[21,21,21,21,21,21,21,21,21,21]])])}),h=new t([],function(){var a=this;return u.cutscenemgr.initialize([{txt:"Pinkie Pie#Hi, I'm Pinkie Pie!"},{txt:"Pinkie Pie#I threw this party just for you!"},{txt:";Pinkie Pie#Were you surprised?#;Yes;Nope;What?;Buck you.",next:function(a){return 3+a}},{txt:"Pinkie Pie#You chose yes!",next:function(){return a.exitscene(-1)}},{txt:"Pinkie Pie#You chose no!",next:function(){return a.exitscene(-1)}},{txt:"Pinkie Pie#You chose hmm?",next:function(){return a.exitscene(-1)}},{txt:"#You made Pinkie cry :<",next:function(){return a.exitscene(-1)}}])}),B=new t(["img/title","trk/title"],function(){var a=this;return u.cutscenemgr.initialize([{len:50,overlay:new g("#000000",50,!1),snd:new m(this.file[1],0,225),elem:[new n(this.file[0],function(a){return[0,0,1,1]})]},{len:0,txt:";##;New Game;Load Game",next:function(a){return a===0?2:u.save.cansaveload?u.save.validate()?4:3:5}},{len:30,overlay:new g("#000000",30,!0),txt:-1,next:function(){return a.exitscene(6)}},{txt:"##There is no save data avaliable.",next:1},{len:30,overlay:new g("#000000",30,!0),txt:-1,next:function(){return u.save.loadstate(6)}},{txt:"##Your browser does not support this feature.",next:1},{overlay:new g("#000000",30,!1),elem:-1,snd:-1,next:-1}])})}).call(this);