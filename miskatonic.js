((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=function(a,b){return function(){return a.apply(b,arguments)}},v=Object.prototype.hasOwnProperty,w=function(a,b){function d(){this.constructor=a}for(var c in b)v.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};b=function(){function a(a){this.text=a,this.currscene=0,this.currclip=0,this.currframe=0}return a.prototype.initialize=function(a,b){var c;this.currclip=0,this.currframe=0,this.currscene=b,c=this.currscene[this.currclip].text;if(c!==-1&&c!==0)return this.text.initialize(c)},a.prototype.render=function(a){var b,c,d,e,f;if(this.currscene!==0){if(this.currframe>(e=this.currscene[this.currclip].duration)&&e>0){this.currframe=0,this.currclip+=1;if(this.currclip>=this.currscene.length){this.text.next(),this.currscene=0;return}this.currscene[this.currclip].text===-1?this.text.show=0:this.currscene[this.currclip].text===0?this.text.next():this.text.display(this.currscene[this.currclip].text)}this.text.render(a),f=this.currscene[this.currclip].particle;for(c=0,d=f.length;c<d;c++)b=f[c],a.draw(b.image,b.parametric(this.currframe));return a.ctx.globalAlpha=1,this.currframe+=1,!0}return!1},a.prototype.input=function(a){return this.currscene!==0?(a.poll[5]!==1&&this.text.input(a),this.currscene[this.currclip].duration<1&&a.poll[5]===1&&(this.currframe=0,this.currclip+=1,this.currclip<this.currscene.length?this.currscene[this.currclip].text===-1?this.text.show=0:this.currscene[this.currclip].text===0?this.text.next():this.text.display(this.currscene[this.currclip].text):(this.text.next(),this.currscene=0)),!0):!1},a.prototype.fadeform=function(a,b){return.5+.5*Math.cos(a*Math.PI/b)},a.prototype.zoomform=function(a,b,c,d,e,f){return[c-a*e,d-b*e,e,f]},a}(),a=function(){function a(a,b,c){this.duration=a,this.text=b,this.particle=c}return a}(),l=function(){function a(a,b){this.image=a,this.parametric=b}return a}(),c=function(){function a(){this.frame=0,this.step=0}return a.prototype.initialize=function(a,b){return this.color=a,this.frame=0,this.step=b},a.prototype.render=function(a){var b;return this.step!==0&&(b=this.step(this.frame),b<0?this.step=0:(a.ctx.globalAlpha=b,this.color!=="#000000"&&(a.ctx.fillStyle=this.color),a.clear(!0),a.ctx.globalAlpha=1,this.color!=="#000000"&&(a.ctx.fillStyle="#000000"),this.frame+=1)),!1},a.prototype.input=function(a){return this.step!==0},a}(),d=function(){function a(){this.loadcount=0,this.callback=0,this.arg=0,this.retval=[]}return a.prototype.loadimg=function(a){var b,c=this;return this.loadcount<0&&(this.loadcount=0),this.loadcount+=1,b=new q(new Image),b.buf.onload=function(){b.size(new t(b.buf.width,b.buf.height)),c.loadcount-=1,c.loadcount<0&&(c.loadcount=0);if(c.callback!==0&&c.loadcount===0)return c.callback(c.retval,c.arg),c.callback=0,c.arg=0,c.retval=[]},b.buf.src=a,b},a.prototype.loadandrun=function(a,b,c){var d,e,f;for(d=0,f=a.length;d<f;d++)e=a[d],this.retval[d]=this.loadimg(e);return this.callback=b,this.arg=c},a}(),h=function(){function a(a,b){this.loadctx=a,this.loadsprite=b,this.maxload=0}return a.prototype.render=function(a){var b;return this.loadctx.loadcount!==0?(this.maxload<this.loadctx.loadcount&&(this.maxload=this.loadctx.loadcount),b=(this.maxload-this.loadctx.loadcount)*a.dims.x/this.maxload-30,a.ctx.moveTo(30,a.dims.y-30),a.ctx.lineTo(b,a.dims.y-30),a.ctx.stroke(),this.loadsprite.step(a,new t(0,0))):this.maxload=0,this.loadctx.loadcount!==0},a.prototype.input=function(a){return this.loadctx.loadcount!==0},a}(),k=function(){function a(a,b){this.rends=a,this.screen=b,this.step=u(this.step,this),this.input=u(this.input,this),this.buffer=new q(this.screen.size()),this.buffer.ctx.fillStyle="#000000",this.buffer.ctx.strokeStyle="#ffffff",this.buffer.ctx.lineWidth=25,this.buffer.ctx.lineCap="round",this.buffer.ctx.globalCompositeOperation="destination-over",this.keys={poll:[0,0,0,0,0,0,0],state:[0,0,0,0,0,0,0]},this.keycodes=[87,65,83,68,16,32,27]}return a.prototype.input=function(a){var b,c,d,e,f,g;for(b=0;b<=6;b++)this.keys.poll[b]=a.keyCode===this.keycodes[b]?a.data:0,this.keys.poll[b]===1&&(this.keys.state[b]=1),this.keys.poll[b]===-1&&(this.keys.state[b]=0);f=this.rends,g=[];for(d=0,e=f.length;d<e;d++){c=f[d];if(c.input(this.keys))break;g.push(void 0)}return g},a.prototype.step=function(){var a,b,c,d;this.screen.blit(this.buffer),this.buffer.clear(!1),d=this.rends;for(b=0,c=d.length;b<c;b++){a=d[b];if(a.render(this.buffer))break}return this.buffer.clear(!0)},a}(),m=function(){function a(a,b){this.overlay=a,this.underlay=b,this.display=new q(new t(800,600)),this.pressed=!1,this.show=!1}return a.prototype.render=function(a){return this.pressed&&(this.pressed=!1,this.show=!this.show,this.display.clear(!1),this.display.blit(this.underlay),this.display.blit(this.overlay)),this.show&&a.blit(this.display),this.show},a.prototype.input=function(a){return a.poll[6]===1&&(this.pressed=!0),this.show},a}(),n=function(){function a(a,b,c,d){this.x=a,this.y=b,this.w=c,this.h=d}return a.prototype.size=function(){return new t(this.w,this.h)},a}(),t=function(){function a(a,b){this.x=a,this.y=b}return a}(),o=function(){function a(a){this.text=a,this.currscene=0}return a.prototype.initialize=function(a){return this.currscene=a},a.prototype.render=function(a){var b,c,d,e,f,g,h,i,j;if(this.currscene!==0){i=this.currscene;for(e=0,g=i.length;e<g;e++)d=i[e],d.docollide(this.currscene[0]);b=this.currscene[0].area.x+(this.currscene[0].area.w-a.dims.x)/2,c=this.currscene[0].area.y+(this.currscene[0].area.h-a.dims.y)/2,this.text.render(a),j=this.currscene;for(f=0,h=j.length;f<h;f++)d=j[f],d.step(a,new t(b,c));return!0}return!1},a.prototype.input=function(a){var b,c,d,e,f,g;b=[[-3,4,3],[-2,-4,2],[-1,0,1]],d=b[1+a.state[0]-a.state[2]][1+a.state[3]-a.state[1]];if(!this.text.input(a)){d===-4?this.currscene[0].mode=0:(this.currscene[0].mode=a.state[4]===1?3:1,this.currscene[0].vector=d);if(a.poll[5]===1){g=this.currscene;for(e=0,f=g.length;e<f;e++)c=g[e],c.interact&&c.dointeract(this.currscene[0])}}return this.currscene!==0?!0:!1},a}(),p=function(){function a(a){var b,c,d;b={sheet:0,area:new n(0,0,0,0),callback:0,len:[],speed:[],collide:!1,trigger:!1,interact:!1,vector:0,mode:0,frame:0};for(c in b)this[c]=(d=a[c])!=null?d:b[c]}return a.prototype.step=function(a,b){var c,d,e;d=[-0.707,-1,-0.707,0,.707,1,.707,0],e=[.707,0,-0.707,-1,-0.707,0,.707,1];if(this.sheet!==0)return this.frame>=this.len[this.mode]&&(this.frame=0),c=new t(Math.floor(this.frame)+Math.abs(this.vector*this.len[this.mode]),this.mode),this.vector<0?(a.ctx.scale(-1,1),a.map(this.sheet,c.x,c.y,b.x-this.area.x-this.area.w,this.area.y-b.y,this.area.w,this.area.h),a.ctx.scale(-1,1)):a.map(this.sheet,c.x,c.y,this.area.x-b.x,this.area.y-b.y,this.area.w,this.area.h),this.area.x+=d[this.vector+3]*this.speed[this.mode],this.area.y+=e[this.vector+3]*this.speed[this.mode],this.frame+=.3},a.prototype.docollide=function(a){var b,c,d,e,f,g;b=a.area.y+a.area.h-this.area.y,c=this.area.x+this.area.w-a.area.x,d=this.area.y+this.area.h-a.area.y,e=a.area.x+a.area.w-this.area.x,g=1,f=b;if(b>0&&c>0&&d>0&&e>0){this.collide&&(f>c&&(f=c,g=2),f>d&&(f=d,g=3),f>e&&(f=e,g=4),g===1&&(a.area.y-=f),g===2&&(a.area.x+=f),g===3&&(a.area.y+=f),g===4&&(a.area.x-=f));if(this.trigger)return a.mode=0,this.callback(this,a)}},a.prototype.dointeract=function(a){var b,c,d,e,f,g,h;f=new n(a.area.x,a.area.y,a.area.w,a.area.h),a.vector<0&&(f.x-=f.w/2),0<(g=a.vector)&&g<4&&(f.x+=f.w/2),-2<(h=a.vector)&&h<2&&(f.y-=f.h/2);if(a.vector<-2||a.vector>2)f.y+=f.h/2;b=f.y+f.h-this.area.y,c=this.area.x+this.area.w-f.x,d=this.area.y+this.area.h-f.y,e=f.x+f.w-this.area.x;if(b>0&&c>0&&d>0&&e>0)return a.mode=0,this.callback(this,a)},a.prototype.lookhere=function(a,b){var c,d,e,f,g;return d=[1,2,3,4,-3,-2,-1,0],f=a.area.x-this.area.x,g=a.area.y-this.area.y,f===0?c=g>0?0:4:e=g/f,f<0&&(e>2.41421356&&(c=4),.414213562<e&&e<=2.41421356&&(c=3),-0.414213562<e&&e<=.414213562&&(c=2),-2.41421356<e&&e<=-0.414213562&&(c=1),e<=-2.41421356&&(c=0)),f>0&&(e>2.41421356&&(c=0),.414213562<e&&e<=2.41421356&&(c=-1),-0.414213562<e&&e<=.414213562&&(c=-2),-2.41421356<e&&e<=-0.414213562&&(c=-3),e<=-2.41421356&&(c=4)),b&&(a.vector=c),this.vector=d[c+3]},a}(),q=function(){function a(a){var b;a instanceof Image||a instanceof HTMLCanvasElement?(this.buf=a,this.dims=new t(a.width,a.height)):(this.buf=document.createElement("canvas"),this.size(a)),this.ctx=typeof (b=this.buf).getContext=="function"?b.getContext("2d"):void 0}return a.prototype.size=function(a){return a!=null&&(this.dims=a,this.buf.width=a.x,this.buf.height=a.y),this.dims},a.prototype.clear=function(a){return a?this.ctx.fillRect(0,0,this.dims.x,this.dims.y):this.ctx.clearRect(0,0,this.dims.x,this.dims.y)},a.prototype.blit=function(a){return this.ctx.drawImage(a.buf,0,0)},a.prototype.map=function(a,b,c,d,e,f,g){return this.ctx.drawImage(a.buf,b*f,c*g,f,g,Math.round(d),Math.round(e),f,g)},a.prototype.draw=function(a,b){return this.ctx.globalAlpha=b[3],this.ctx.drawImage(a.buf,Math.round(b[0]),Math.round(b[1]),Math.round(b[2]*a.dims.x),Math.round(b[2]*a.dims.y))},a.prototype.layer=function(a,b){var c,d,e,f,g,h,i,j,k,l;return b.x==="c"&&(b.x=a.dims.x/2),b.y==="c"&&(b.y=a.dims.y/2),k=this.dims.x/2-b.x,l=this.dims.y/2-b.y,j=k+a.dims.x,g=l+a.dims.y,h=k>0?0:-k,c=k<0?0:k,i=l>0?0:-l,d=l<0?0:l,f=(j>this.dims.x?this.dims.x:j)-c,e=(g>this.dims.y?this.dims.y:g)-d,this.ctx.drawImage(a.buf,Math.round(h),Math.round(i),Math.round(f),Math.round(e),Math.round(c),Math.round(d),Math.round(f),Math.round(e))},a}(),r=function(){function a(a,b,c,d,e){this.charsheet=a,this.chars=b,this.localarea=c,this.chararea=d,this.avatararea=e,this.text=new q(this.localarea.size()),this.text.ctx.fillStyle="#000000",this.choice=new t(-1,-1),this.textbox=0,this.currframe=0}return a.prototype.initialize=function(a){return this.textbox=a,this.currframe=0,this.next()},a.prototype.render=function(a){if(this.textbox!==0)return a.layer(this.text,new t("c",-100))},a.prototype.input=function(a){return this.textbox!==0?(this.choice.x!==-1&&this.choice.y!==-1&&(a.poll[0]===1&&(this.choice.y-=1),a.poll[1]===1&&(this.choice.x-=1),a.poll[2]===1&&(this.choice.y+=1),a.poll[3]===1&&(this.choice.x+=1),this.choice.x<0&&(this.choice.x=0),this.choice.x>1&&(this.choice.x=1),this.choice.y<0&&(this.choice.y=0),this.choice.y>2&&(this.choice.y=2),this.drawchoice(this.textbox[this.currframe])),a.poll[5]===1&&this.next(),!0):!1},a.prototype.next=function(){var a;return a=this.choice.x+2*this.choice.y,this.choice.x!==-1&&this.choice.y!==-1&&(this.choice.x=-1,this.choice.y=-1,this.textbox[0](this.textbox,this.currframe,a)),this.textbox.length>this.currframe+1?(this.currframe+=1,this.textbox[this.currframe][0]===":"?(this.choice.x=0,this.choice.y=0,this.drawchoice(this.textbox[this.currframe])):this.drawtext(this.textbox[this.currframe])):this.textbox=0},a.prototype.drawchoice=function(a){var b,c,d,e,f,g,h,i;e="",c=a.substring(1).split(":",6),Math.ceil(c.length/2)<=this.choice.y&&(this.choice.y=-1+Math.ceil(c.length/2)),b=this.choice.x+2*this.choice.y,b>=c.length&&(this.choice.x-=1,b-=1),c[b]="> "+c[b]+" <";for(g=0,i=c.length;g<i;g++){d=c[g],f=Math.floor((Math.floor(this.chars.x/2)-d.length)/2);for(h=1;1>f?h>=f:h<=f;1>f?h--:h++)d=" "+d+" ";d.length%2!==this.chars.x/2%2&&(d+=" "),e+=d}return this.drawtext(e)},a.prototype.drawtext=function(a){var b,c,d,e,f,g,h,i,j,k;d=0,c=0,this.text.clear(!1),this.text.ctx.globalAlpha=.7,this.text.clear(!0),this.text.ctx.globalAlpha=1,k=[];for(i=0,j=a.length;i<j;i++){b=a[i];if(d>=this.chars.y)continue;g=b.charCodeAt(0)-16*Math.floor(b.charCodeAt(0)/16),h=Math.floor(b.charCodeAt(0)/16),e=this.localarea.x+c*(this.chararea.x+this.chararea.w),f=this.localarea.y+d*(this.chararea.y+this.chararea.h),this.text.map(this.charsheet,g,h,e,f,this.chararea.w,this.chararea.h),c+=1,c<this.chars.x?k.push(void 0):(c=0,k.push(d+=1))}return k},a}(),s=function(a){function b(a,c,d,e){var f,g,h,i,j,k,l,m;this.tilesize=a,this.tilesheet=c,this.gridsize=d,this.grid=e,h=new q(new t(this.tilesize.x*this.gridsize.x,this.tilesize.y*this.gridsize.y)),k=this.tilesheet.dims.x/this.tilesize.x;for(f=0,l=this.gridsize.x;0>l?f>l:f<l;0>l?f--:f++)for(g=0,m=this.gridsize.y;0>m?g>m:g<m;0>m?g--:g++)j=Math.floor((Math.abs(this.grid[f+g*this.gridsize.x])-1)/k),i=Math.abs(this.grid[f+g*this.gridsize.x])-1-j*k,h.map(this.tilesheet,i,j,f*this.tilesize.x,g*this.tilesize.y,this.tilesize.x,this.tilesize.y);b.__super__.constructor.call(this,{sheet:h,collide:!0,area:new n(0,0,this.tilesize.x,this.tilesize.y)})}return w(b,a),b.prototype.step=function(a,b){return a.layer(this.sheet,new t(b.x+a.dims.x/2,b.y+a.dims.y/2))},b.prototype.docollide=function(a){var c,d,e,f,g;d=Math.floor(a.area.x/this.tilesize.x),f=Math.floor(a.area.y/this.tilesize.y),e=Math.floor((a.area.x+a.area.w/2)/this.tilesize.x)-d,g=Math.floor((a.area.y+a.area.h/2)/this.tilesize.y)-f,c=1+e+g*2,d<0&&(this.area.x=-this.area.w,this.area.y=a.area.y,b.__super__.docollide.call(this,a)),f<0&&(this.area.x=a.area.x,this.area.y=-this.area.h,b.__super__.docollide.call(this,a)),d>this.gridsize.x-2&&(this.area.x=this.gridsize.x*this.area.w,this.area.y=a.area.y,b.__super__.docollide.call(this,a)),f>this.gridsize.y-2&&(this.area.x=a.area.x,this.area.y=this.gridsize.y*this.area.h,b.__super__.docollide.call(this,a)),this.grid[d+f*this.gridsize.x]<0&&(c!==4||this.grid[d+(f+1)*this.gridsize.x]>0&&this.grid[d+1+f*this.gridsize.x]>0)&&(this.area.x=d*this.area.w,this.area.y=f*this.area.h,b.__super__.docollide.call(this,a)),this.grid[d+1+f*this.gridsize.x]<0&&(c!==3||this.grid[d+f*this.gridsize.x]>0&&this.grid[d+1+(f+1)*this.gridsize.x]>0)&&(this.area.x=(d+1)*this.area.w,this.area.y=f*this.area.h,b.__super__.docollide.call(this,a)),this.grid[d+(f+1)*this.gridsize.x]<0&&(c!==2||this.grid[d+f*this.gridsize.x]>0&&this.grid[d+1+(f+1)*this.gridsize.x]>0)&&(this.area.x=d*this.area.w,this.area.y=(f+1)*this.area.h,b.__super__.docollide.call(this,a));if(this.grid[d+1+(f+1)*this.gridsize.x]<0&&(c!==1||this.grid[d+(f+1)*this.gridsize.x]>0&&this.grid[d+1+f*this.gridsize.x]>0))return this.area.x=(d+1)*this.area.w,this.area.y=(f+1)*this.area.h,b.__super__.docollide.call(this,a)},b}(p),e=function(a){return a.fileloader.loadandrun(["img/room.test0.png","img/thumb.art1.png","img/artifact.quest.png"],i,a)},i=function(b,c){return c.cutscenemgr.initialize(c.fileloader,[new a(150,[function(a,b,c){c===0&&(a[3]="You chose one!");if(c===1)return a[3]="You chose two!"},"This is some text during a cutscene.",":Choice One:Choice Two"],[new l(b[2],function(a){return[Math.cos(Math.PI*a/30)*200+350,Math.sin(Math.PI*a/30)*200+250,1,1]}),new l(b[1],function(a){return[350,250,1,c.cutscenemgr.fadeform(a,30)]}),new l(b[0],function(a){return[0,0,1,1]})]),new a(0,0,[new l(b[2],function(a){return c.cutscenemgr.zoomform(64,64,400,300,Math.cos(Math.PI*a/30)+1,1)})]),new a(50,0,[new l(b[1],function(a){return[50,50,1,1]})])])},$(document).ready(function(){return g(f())}),f=function(){var a,e;return e=new q($("#miskatonic").get(0)),a={},a.fileloader=new d,a.textmgr=new r(a.fileloader.loadimg("img/text.png"),new t(38,3),new n(16,16,656,160),new n(-16,16,32,32),new n(0,0,100,100)),a.scenemgr=new o(a.textmgr),a.cutscenemgr=new b(a.textmgr),a.fademgr=new c,a.engine=new k([new h(a.fileloader,new p({sheet:a.fileloader.loadimg("img/load.png"),area:new n(350,300,100,100),vector:0,mode:0,len:[8],speed:[0]})),new m(a.fileloader.loadimg("img/pause.png"),e),a.fademgr,a.cutscenemgr,a.scenemgr],e),$(document).keydown(1,a.engine.input),$(document).keyup(-1,a.engine.input),window.setInterval(a.engine.step,33),a},g=function(a){return a.fileloader.loadandrun(["img/pinkiepie.gif","img/tent.png"],j,a)},j=function(a,b){return b.scenemgr.initialize([new p({sheet:a[0],area:new n(100,100,96,96),vector:2,len:[1,6,6,6],speed:[0,3,6,9]}),new p({sheet:a[0],area:new n(500,100,96,96),collide:!0,interact:!0,vector:4,len:[1,6,6,6],speed:[0,3,6,9],callback:function(a,c){return a.lookhere(c,!0),b.scenemgr.text.initialize([function(a,b,c){c===0&&(a[5]="You chose yes!"),c===1&&(a[5]="You chose no!"),c===2&&(a[5]="You chose hmm?"),c===3&&(a[5]="You made Pinkie cry :<");if(c===4)return a[5]="You're silly ^^"},"Hi, I'm Pinkie Pie!","I threw this party just for you!","Were you surprised?",":Yes:Nope:What?:Buck you:what now"])}}),new p({sheet:a[0],area:new n(100,500,96,96),collide:!0,interact:!0,vector:-1,len:[1,6,6,6],speed:[0,3,6,9],callback:function(){return b.fademgr.initialize("#CC0000",function(a){a===30&&e(b);if(a===60)return-1;if(a<=30)return a/30;if(a>30)return(60-a)/30})}}),new s(new t(100,100),a[1],new t(10,8),[21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,1,-2,-3,-4,5,21,21,21,21,21,6,-7,-8,-9,10,21,21,21,21,21,11,-12,13,-14,15,21,21,21,21,21,16,17,18,19,20,21,21,21,21,21,21,21,21,21,21,21])])}})).call(this);